import { __decorate } from "tslib";
import { Application, TextView, Color, Frame, profile, profilingUptime } from '@nativescript/core';
// import './dom-adapter';
// import 'nativescript-intl';
import { PlatformRef, EventEmitter, Sanitizer } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { NativeScriptDebug } from './trace';
import { defaultPageFactoryProvider, setRootPage, PAGE_FACTORY, getRootPage } from './platform-providers';
import { AppHostView, AppHostAsyncView } from './app-host-view';
export const onBeforeLivesync = new EventEmitter();
export const onAfterLivesync = new EventEmitter();
let lastBootstrappedModule;
export class NativeScriptSanitizer extends Sanitizer {
    sanitize(_context, value) {
        return value;
    }
}
export class NativeScriptDocument {
    constructor() {
        // Required by the AnimationDriver
        this.body = {
            isOverride: true,
        };
    }
    createElement(tag) {
        throw new Error('NativeScriptDocument is not DOM Document. There is no createElement() method.');
    }
}
export const COMMON_PROVIDERS = [defaultPageFactoryProvider, { provide: Sanitizer, useClass: NativeScriptSanitizer, deps: [] }, { provide: DOCUMENT, useClass: NativeScriptDocument, deps: [] }];
export class NativeScriptPlatformRef extends PlatformRef {
    constructor(platform, appOptions = {}) {
        super();
        this.platform = platform;
        this.appOptions = appOptions;
    }
    bootstrapModuleFactory(moduleFactory) {
        this._bootstrapper = () => {
            let bootstrapFactory = moduleFactory;
            if (this.appOptions.hmrOptions) {
                bootstrapFactory = this.appOptions.hmrOptions.moduleTypeFactory();
            }
            return this.platform.bootstrapModuleFactory(bootstrapFactory);
        };
        this.bootstrapApp();
        return null; // Make the compiler happy
    }
    bootstrapModule(moduleType, compilerOptions = []) {
        this._bootstrapper = () => {
            let bootstrapType = moduleType;
            if (this.appOptions.hmrOptions) {
                bootstrapType = this.appOptions.hmrOptions.moduleTypeFactory();
            }
            return this.platform.bootstrapModule(bootstrapType, compilerOptions);
        };
        this.bootstrapApp();
        return null; // Make the compiler happy
    }
    bootstrapApp() {
        global.__onLiveSyncCore = () => {
            if (this.appOptions.hmrOptions) {
                const rootView = Application.getRootView();
                if (rootView) {
                    rootView._closeAllModalViewsInternal();
                }
                this.appOptions.hmrOptions.livesyncCallback(() => this._livesync());
            }
            else {
                this._livesync();
            }
        };
        if (this.appOptions && typeof this.appOptions.cssFile === 'string') {
            Application.setCssFileName(this.appOptions.cssFile);
        }
        this.bootstrapNativeScriptApp();
    }
    onDestroy(callback) {
        this.platform.onDestroy(callback);
    }
    get injector() {
        return this.platform.injector;
    }
    destroy() {
        this.platform.destroy();
    }
    get destroyed() {
        return this.platform.destroyed;
    }
    bootstrapNativeScriptApp() {
        let rootContent;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.bootstrapLog('NativeScriptPlatform bootstrap started.');
        }
        const launchCallback = profile('@nativescript/angular/platform-common.launchCallback', (args) => {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.bootstrapLog('Application launch event fired');
            }
            // Create a temp page for root of the renderer
            let tempAppHostView;
            let tempAppHostAsyncView;
            if (this.appOptions && (this.appOptions.async || this.appOptions.launchView)) {
                tempAppHostAsyncView = new AppHostAsyncView(new Color(this.appOptions && this.appOptions.backgroundColor ? this.appOptions.backgroundColor : '#fff'));
                if (this.appOptions.launchView) {
                    this.appOptions.launchView.style.zIndex = 1000;
                    tempAppHostAsyncView.addChild(this.appOptions.launchView);
                }
                rootContent = tempAppHostAsyncView.ngAppRoot;
                setRootPage(tempAppHostAsyncView);
            }
            else {
                tempAppHostView = new AppHostView(new Color(this.appOptions && this.appOptions.backgroundColor ? this.appOptions.backgroundColor : '#fff'));
                setRootPage(tempAppHostView);
            }
            let bootstrapPromiseCompleted = false;
            const bootstrap = () => {
                this._bootstrapper().then((moduleRef) => {
                    bootstrapPromiseCompleted = true;
                    if (NativeScriptDebug.isLogEnabled()) {
                        NativeScriptDebug.bootstrapLog(`Angular bootstrap bootstrap done. uptime: ${profilingUptime()}`);
                    }
                    if (this.appOptions.launchView && this.appOptions.launchView.cleanup) {
                        this.appOptions.launchView.cleanup().then(() => {
                            // cleanup any custom launch views
                            tempAppHostAsyncView.removeChild(this.appOptions.launchView);
                            this.appOptions.launchView = null;
                        });
                    }
                    else if (tempAppHostView) {
                        rootContent = tempAppHostView.content;
                    }
                    lastBootstrappedModule = new WeakRef(moduleRef);
                }, (err) => {
                    bootstrapPromiseCompleted = true;
                    const errorMessage = err.message + '\n\n' + err.stack;
                    if (NativeScriptDebug.isLogEnabled()) {
                        NativeScriptDebug.bootstrapLogError('ERROR BOOTSTRAPPING ANGULAR');
                    }
                    if (NativeScriptDebug.isLogEnabled()) {
                        NativeScriptDebug.bootstrapLogError(errorMessage);
                    }
                    rootContent = this.createErrorUI(errorMessage);
                });
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.bootstrapLog('bootstrapAction called, draining micro tasks queue. Root: ' + rootContent);
                }
                global.Zone.drainMicroTaskQueue();
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.bootstrapLog('bootstrapAction called, draining micro tasks queue finished! Root: ' + rootContent);
                }
            };
            if (this.appOptions && this.appOptions.launchView && this.appOptions.launchView.startAnimation) {
                // start animations on next tick (after initial boot)
                setTimeout(() => {
                    // ensure launch animation is executed after launchView added to view stack
                    this.appOptions.launchView.startAnimation();
                });
            }
            bootstrap();
            // if (!bootstrapPromiseCompleted) {
            // 	const errorMessage = "Bootstrap promise didn't resolve";
            // 	if (NativeScriptDebug.isLogEnabled()) {
            // 		NativeScriptDebug.bootstrapLogError(errorMessage);
            // 	}
            // 	rootContent = this.createErrorUI(errorMessage);
            // }
            args.root = rootContent;
        });
        const exitCallback = profile('@nativescript/angular/platform-common.exitCallback', (args) => {
            const androidActivity = args.android;
            if (androidActivity && !androidActivity.isFinishing()) {
                // Exit event was triggered as a part of a restart of the app.
                return;
            }
            const lastModuleRef = lastBootstrappedModule ? lastBootstrappedModule.get() : null;
            if (lastModuleRef) {
                // Make sure the module is only destroyed once
                lastBootstrappedModule = null;
                lastModuleRef.destroy();
            }
            rootContent = null;
        });
        Application.on(Application.launchEvent, launchCallback);
        Application.on(Application.exitEvent, exitCallback);
        Application.run();
    }
    _livesync() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.bootstrapLog('Angular livesync started.');
        }
        const lastModuleRef = lastBootstrappedModule ? lastBootstrappedModule.get() : null;
        onBeforeLivesync.next(lastModuleRef);
        if (lastModuleRef) {
            lastModuleRef.destroy();
        }
        this._bootstrapper().then((moduleRef) => {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.bootstrapLog('Angular livesync done.');
            }
            onAfterLivesync.next({ moduleRef });
            lastBootstrappedModule = new WeakRef(moduleRef);
            Application.resetRootView({
                create: () => getRootPage(),
            });
        }, (error) => {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.bootstrapLogError('ERROR LIVESYNC BOOTSTRAPPING ANGULAR');
            }
            const errorMessage = error.message + '\n\n' + error.stack;
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.bootstrapLogError(errorMessage);
            }
            Application.resetRootView({
                create: () => this.createErrorUI(errorMessage),
            });
            onAfterLivesync.next({ error });
        });
    }
    createErrorUI(message) {
        const errorTextBox = new TextView();
        errorTextBox.text = message;
        errorTextBox.color = new Color('red');
        return errorTextBox;
    }
    createFrameAndPage(isLivesync) {
        const frame = new Frame();
        const pageFactory = this.platform.injector.get(PAGE_FACTORY);
        const page = pageFactory({ isBootstrap: true, isLivesync });
        frame.navigate({
            create: () => {
                return page;
            },
        });
        return { page, frame };
    }
}
__decorate([
    profile
], NativeScriptPlatformRef.prototype, "bootstrapModuleFactory", null);
__decorate([
    profile
], NativeScriptPlatformRef.prototype, "bootstrapModule", null);
__decorate([
    profile
], NativeScriptPlatformRef.prototype, "bootstrapApp", null);
__decorate([
    profile
], NativeScriptPlatformRef.prototype, "bootstrapNativeScriptApp", null);
__decorate([
    profile
], NativeScriptPlatformRef.prototype, "_livesync", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxhdGZvcm0tY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vcGxhdGZvcm0tY29tbW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQVEsS0FBSyxFQUFxRCxPQUFPLEVBQUUsZUFBZSxFQUFvQixNQUFNLG9CQUFvQixDQUFDO0FBQzlLLDBCQUEwQjtBQUMxQiw4QkFBOEI7QUFFOUIsT0FBTyxFQUFtQyxXQUFXLEVBQWdDLFlBQVksRUFBRSxTQUFTLEVBQWtDLE1BQU0sZUFBZSxDQUFDO0FBQ3BLLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUzQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDNUMsT0FBTyxFQUFFLDBCQUEwQixFQUFFLFdBQVcsRUFBZSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdkgsT0FBTyxFQUFFLFdBQVcsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRWhFLE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFHLElBQUksWUFBWSxFQUFvQixDQUFDO0FBQ3JFLE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRyxJQUFJLFlBQVksRUFHM0MsQ0FBQztBQUNMLElBQUksc0JBQWlELENBQUM7QUE0RHRELE1BQU0sT0FBTyxxQkFBc0IsU0FBUSxTQUFTO0lBQ25ELFFBQVEsQ0FBQyxRQUFhLEVBQUUsS0FBYTtRQUNwQyxPQUFPLEtBQUssQ0FBQztJQUNkLENBQUM7Q0FDRDtBQUVELE1BQU0sT0FBTyxvQkFBb0I7SUFBakM7UUFDQyxrQ0FBa0M7UUFDM0IsU0FBSSxHQUFRO1lBQ2xCLFVBQVUsRUFBRSxJQUFJO1NBQ2hCLENBQUM7SUFLSCxDQUFDO0lBSEEsYUFBYSxDQUFDLEdBQVc7UUFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBQywrRUFBK0Us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OUMsQ0FBQyxDQUFDO1lBQ0gsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDakMsQ0FBQyxDQUNELENBQUM7SUFDSCxDQUFDO0lBRU8sYUFBYSxDQUFDLE9BQWU7UUFDcEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUNwQyxZQUFZLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztRQUM1QixZQUFZLENBQUMsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sWUFBWSxDQUFDO0lBQ3JCLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxVQUFtQjtRQUM3QyxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzFCLE1BQU0sV0FBVyxHQUFnQixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDMUUsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBRTVELEtBQUssQ0FBQyxRQUFRLENBQUM7WUFDZCxNQUFNLEVBQUUsR0FBRyxFQUFFO2dCQUNaLE9BQU8sSUFBSSxDQUFDO1lBQ2IsQ0FBQztTQUNELENBQUMsQ0FBQztRQUNILE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUM7SUFDeEIsQ0FBQztDQUNEO0FBaFBBO0lBREMsT0FBTztxRUFjUDtBQUdEO0lBREMsT0FBTzs4REFhUDtBQUdEO0lBREMsT0FBTzsyREFvQlA7QUFtQkQ7SUFEQyxPQUFPO3VFQThHUDtBQUdEO0lBREMsT0FBTzt3REF1Q1AiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBsaWNhdGlvbiwgVGV4dFZpZXcsIENvbG9yLCBWaWV3LCBGcmFtZSwgR3JpZExheW91dCwgTGF1bmNoRXZlbnREYXRhLCBBcHBsaWNhdGlvbkV2ZW50RGF0YSwgcHJvZmlsZSwgcHJvZmlsaW5nVXB0aW1lLCBQYWdlLCBMYXlvdXRCYXNlIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcbi8vIGltcG9ydCAnLi9kb20tYWRhcHRlcic7XG4vLyBpbXBvcnQgJ25hdGl2ZXNjcmlwdC1pbnRsJztcblxuaW1wb3J0IHsgVHlwZSwgSW5qZWN0b3IsIENvbXBpbGVyT3B0aW9ucywgUGxhdGZvcm1SZWYsIE5nTW9kdWxlRmFjdG9yeSwgTmdNb2R1bGVSZWYsIEV2ZW50RW1pdHRlciwgU2FuaXRpemVyLCBJbmplY3Rpb25Ub2tlbiwgU3RhdGljUHJvdmlkZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuL3RyYWNlJztcbmltcG9ydCB7IGRlZmF1bHRQYWdlRmFjdG9yeVByb3ZpZGVyLCBzZXRSb290UGFnZSwgUGFnZUZhY3RvcnksIFBBR0VfRkFDVE9SWSwgZ2V0Um9vdFBhZ2UgfSBmcm9tICcuL3BsYXRmb3JtLXByb3ZpZGVycyc7XG5pbXBvcnQgeyBBcHBIb3N0VmlldywgQXBwSG9zdEFzeW5jVmlldyB9IGZyb20gJy4vYXBwLWhvc3Qtdmlldyc7XG5cbmV4cG9ydCBjb25zdCBvbkJlZm9yZUxpdmVzeW5jID0gbmV3IEV2ZW50RW1pdHRlcjxOZ01vZHVsZVJlZjxhbnk+PigpO1xuZXhwb3J0IGNvbnN0IG9uQWZ0ZXJMaXZlc3luYyA9IG5ldyBFdmVudEVtaXR0ZXI8e1xuXHRtb2R1bGVSZWY/OiBOZ01vZHVsZVJlZjxhbnk+O1xuXHRlcnJvcj86IEVycm9yO1xufT4oKTtcbmxldCBsYXN0Qm9vdHN0cmFwcGVkTW9kdWxlOiBXZWFrUmVmPE5nTW9kdWxlUmVmPGFueT4+O1xudHlwZSBCb290c3RyYXBwZXJBY3Rpb24gPSAoKSA9PiBQcm9taXNlPE5nTW9kdWxlUmVmPGFueT4+O1xuXG4vLyBXb3JrIGFyb3VuZCBhIFRTIGJ1ZyByZXF1aXJpbmcgYW4gaW1wb3J0IG9mIE9wYXF1ZVRva2VuIHdpdGhvdXQgdXNpbmcgaXRcbi8vIGlmICgoPGFueT5nbG9iYWwpLl9fX1RTX1VOVVNFRCkge1xuLy8gICAgICgoKSA9PiB7XG4vLyAgICAgICAgIHJldHVybiBJbmplY3Rpb25Ub2tlbjtcbi8vICAgICB9KSgpO1xuLy8gfVxuXG4vLyB0c2xpbnQ6ZGlzYWJsZTptYXgtbGluZS1sZW5ndGhcbi8qKlxuICogT3B0aW9ucyB0byBiZSBwYXNzZWQgd2hlbiBITVIgaXMgZW5hYmxlZFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEhtck9wdGlvbnMge1xuXHQvKipcblx0ICogQSBmYWN0b3J5IGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBlaXRoZXIgTW9kdWxlIHR5cGUgb3IgTmdNb2R1bGVGYWN0b3J5IHR5cGUuXG5cdCAqIFRoaXMgbmVlZHMgdG8gYmUgYSBmYWN0b3J5IGZ1bmN0aW9uIGFzIHRoZSB0eXBlcyB3aWxsIGNoYW5nZSB3aGVuIG1vZHVsZXMgYXJlIHJlcGxhY2VkLlxuXHQgKi9cblx0bW9kdWxlVHlwZUZhY3Rvcnk/OiAoKSA9PiBUeXBlPGFueT4gfCBOZ01vZHVsZUZhY3Rvcnk8YW55PjtcblxuXHQvKipcblx0ICogQSBsaXZlc3luYyBjYWxsYmFjayB0aGF0IHdpbGwgYmUgY2FsbGVkIGluc3RlYWQgb2YgdGhlIG9yaWdpbmFsIGxpdmVzeW5jLlxuXHQgKiBJdCBnaXZlcyB0aGUgSE1SIGEgaG9vayB0byBhcHBseSB0aGUgbW9kdWxlIHJlcGxhY2VtZW50LlxuXHQgKiBAcGFyYW0gYm9vdHN0cmFwUGxhdGZvcm0gLSBBIGJvb3RzdHJhcCBjYWxsYmFjayB0byBiZSBjYWxsZWQgYWZ0ZXIgSE1SIGlzIGRvbmUuIEl0IHdpbGwgYm9vdHN0cmFwIGEgbmV3IGFuZ3VsYXIgYXBwIHdpdGhpbiB0aGUgZXhpc2l0aW5nIHBsYXRmb3JtLCB1c2luZyB0aGUgbW9kdWxlVHlwZUZhY3RvcnkgdG8gZ2V0IHRoZSBNb2R1bGUgb3IgTmdNb2R1bGVGYWN0b3J5IHRvIGJlIHVzZWQuXG5cdCAqL1xuXHRsaXZlc3luY0NhbGxiYWNrOiAoYm9vdHN0cmFwUGxhdGZvcm06ICgpID0+IHZvaWQpID0+IHZvaWQ7XG59XG4vLyB0c2xpbnQ6ZW5hYmxlOm1heC1saW5lLWxlbmd0aFxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcExhdW5jaFZpZXcgZXh0ZW5kcyBMYXlvdXRCYXNlIHtcblx0Ly8gY2FsbGVkIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyB0byBiZWdpblxuXHRzdGFydEFuaW1hdGlvbj86ICgpID0+IHZvaWQ7XG5cdC8vIGNhbGxlZCB3aGVuIGJvb3RzdHJhcCBpcyBjb21wbGV0ZSBhbmQgY2xlYW51cCBjYW4gYmVnaW5cblx0Ly8gc2hvdWxkIHJlc29sdmUgd2hlbiBhbmltYXRpb24gaXMgY29tcGxldGVseSBmaW5pc2hlZFxuXHRjbGVhbnVwPzogKCkgPT4gUHJvbWlzZTxhbnk+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcE9wdGlvbnMge1xuXHRib290SW5FeGlzdGluZ1BhZ2U/OiBib29sZWFuO1xuXHRjc3NGaWxlPzogc3RyaW5nO1xuXHRzdGFydFBhZ2VBY3Rpb25CYXJIaWRkZW4/OiBib29sZWFuO1xuXHRobXJPcHRpb25zPzogSG1yT3B0aW9ucztcblx0LyoqXG5cdCAqIEJhY2tncm91bmQgY29sb3Igb2YgdGhlIHJvb3Qgdmlld1xuXHQgKi9cblx0YmFja2dyb3VuZENvbG9yPzogc3RyaW5nO1xuXHQvKipcblx0ICogVXNlIGFuaW1hdGVkIGxhdW5jaCB2aWV3IChhc3luYyBieSBkZWZhdWx0KVxuXHQgKi9cblx0bGF1bmNoVmlldz86IEFwcExhdW5jaFZpZXc7XG5cdC8qKlxuXHQgKiBXaGVuIHVzaW5nIEFzeW5jIEFQUF9JTklUSUFMSVpFUiwgc2V0IHRoaXMgdG8gYHRydWVgLlxuXHQgKiAoTm90IG5lZWRlZCB3aGVuIHVzaW5nIGxhdW5jaFZpZXcpXG5cdCAqL1xuXHRhc3luYz86IGJvb2xlYW47XG59XG5cbmV4cG9ydCB0eXBlIFBsYXRmb3JtRmFjdG9yeSA9IChleHRyYVByb3ZpZGVycz86IFN0YXRpY1Byb3ZpZGVyW10pID0+IFBsYXRmb3JtUmVmO1xuXG5leHBvcnQgY2xhc3MgTmF0aXZlU2NyaXB0U2FuaXRpemVyIGV4dGVuZHMgU2FuaXRpemVyIHtcblx0c2FuaXRpemUoX2NvbnRleHQ6IGFueSwgdmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHZhbHVlO1xuXHR9XG59XG5cbmV4cG9ydCBjbGFzcyBOYXRpdmVTY3JpcHREb2N1bWVudCB7XG5cdC8vIFJlcXVpcmVkIGJ5IHRoZSBBbmltYXRpb25Ecml2ZXJcblx0cHVibGljIGJvZHk6IGFueSA9IHtcblx0XHRpc092ZXJyaWRlOiB0cnVlLFxuXHR9O1xuXG5cdGNyZWF0ZUVsZW1lbnQodGFnOiBzdHJpbmcpIHtcblx0XHR0aHJvdyBuZXcgRXJyb3IoJ05hdGl2ZVNjcmlwdERvY3VtZW50IGlzIG5vdCBET00gRG9jdW1lbnQuIFRoZXJlIGlzIG5vIGNyZWF0ZUVsZW1lbnQoKSBtZXRob2QuJyk7XG5cdH1cbn1cblxuZXhwb3J0IGNvbnN0IENPTU1PTl9QUk9WSURFUlMgPSBbZGVmYXVsdFBhZ2VGYWN0b3J5UHJvdmlkZXIsIHsgcHJvdmlkZTogU2FuaXRpemVyLCB1c2VDbGFzczogTmF0aXZlU2NyaXB0U2FuaXRpemVyLCBkZXBzOiBbXSB9LCB7IHByb3ZpZGU6IERPQ1VNRU5ULCB1c2VDbGFzczogTmF0aXZlU2NyaXB0RG9jdW1lbnQsIGRlcHM6IFtdIH1dO1xuXG5leHBvcnQgY2xhc3MgTmF0aXZlU2NyaXB0UGxhdGZvcm1SZWYgZXh0ZW5kcyBQbGF0Zm9ybVJlZiB7XG5cdHByaXZhdGUgX2Jvb3RzdHJhcHBlcjogQm9vdHN0cmFwcGVyQWN0aW9uO1xuXG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgcGxhdGZvcm06IFBsYXRmb3JtUmVmLCBwcml2YXRlIGFwcE9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7fSkge1xuXHRcdHN1cGVyKCk7XG5cdH1cblxuXHRAcHJvZmlsZVxuXHRib290c3RyYXBNb2R1bGVGYWN0b3J5PE0+KG1vZHVsZUZhY3Rvcnk6IE5nTW9kdWxlRmFjdG9yeTxNPik6IFByb21pc2U8TmdNb2R1bGVSZWY8TT4+IHtcblx0XHR0aGlzLl9ib290c3RyYXBwZXIgPSAoKSA9PiB7XG5cdFx0XHRsZXQgYm9vdHN0cmFwRmFjdG9yeSA9IG1vZHVsZUZhY3Rvcnk7XG5cdFx0XHRpZiAodGhpcy5hcHBPcHRpb25zLmhtck9wdGlvbnMpIHtcblx0XHRcdFx0Ym9vdHN0cmFwRmFjdG9yeSA9IDxOZ01vZHVsZUZhY3Rvcnk8TT4+dGhpcy5hcHBPcHRpb25zLmhtck9wdGlvbnMubW9kdWxlVHlwZUZhY3RvcnkoKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHRoaXMucGxhdGZvcm0uYm9vdHN0cmFwTW9kdWxlRmFjdG9yeShib290c3RyYXBGYWN0b3J5KTtcblx0XHR9O1xuXG5cdFx0dGhpcy5ib290c3RyYXBBcHAoKTtcblxuXHRcdHJldHVybiBudWxsOyAvLyBNYWtlIHRoZSBjb21waWxlciBoYXBweVxuXHR9XG5cblx0QHByb2ZpbGVcblx0Ym9vdHN0cmFwTW9kdWxlPE0+KG1vZHVsZVR5cGU6IFR5cGU8TT4sIGNvbXBpbGVyT3B0aW9uczogQ29tcGlsZXJPcHRpb25zIHwgQ29tcGlsZXJPcHRpb25zW10gPSBbXSk6IFByb21pc2U8TmdNb2R1bGVSZWY8TT4+IHtcblx0XHR0aGlzLl9ib290c3RyYXBwZXIgPSAoKSA9PiB7XG5cdFx0XHRsZXQgYm9vdHN0cmFwVHlwZSA9IG1vZHVsZVR5cGU7XG5cdFx0XHRpZiAodGhpcy5hcHBPcHRpb25zLmhtck9wdGlvbnMpIHtcblx0XHRcdFx0Ym9vdHN0cmFwVHlwZSA9IDxUeXBlPE0+PnRoaXMuYXBwT3B0aW9ucy5obXJPcHRpb25zLm1vZHVsZVR5cGVGYWN0b3J5KCk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiB0aGlzLnBsYXRmb3JtLmJvb3RzdHJhcE1vZHVsZShib290c3RyYXBUeXBlLCBjb21waWxlck9wdGlvbnMpO1xuXHRcdH07XG5cdFx0dGhpcy5ib290c3RyYXBBcHAoKTtcblxuXHRcdHJldHVybiBudWxsOyAvLyBNYWtlIHRoZSBjb21waWxlciBoYXBweVxuXHR9XG5cblx0QHByb2ZpbGVcblx0cHJpdmF0ZSBib290c3RyYXBBcHAoKSB7XG5cdFx0KDxhbnk+Z2xvYmFsKS5fX29uTGl2ZVN5bmNDb3JlID0gKCkgPT4ge1xuXHRcdFx0aWYgKHRoaXMuYXBwT3B0aW9ucy5obXJPcHRpb25zKSB7XG5cdFx0XHRcdGNvbnN0IHJvb3RWaWV3ID0gQXBwbGljYXRpb24uZ2V0Um9vdFZpZXcoKTtcblx0XHRcdFx0aWYgKHJvb3RWaWV3KSB7XG5cdFx0XHRcdFx0cm9vdFZpZXcuX2Nsb3NlQWxsTW9kYWxWaWV3c0ludGVybmFsKCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHR0aGlzLmFwcE9wdGlvbnMuaG1yT3B0aW9ucy5saXZlc3luY0NhbGxiYWNrKCgpID0+IHRoaXMuX2xpdmVzeW5jKCkpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5fbGl2ZXN5bmMoKTtcblx0XHRcdH1cblx0XHR9O1xuXG5cdFx0aWYgKHRoaXMuYXBwT3B0aW9ucyAmJiB0eXBlb2YgdGhpcy5hcHBPcHRpb25zLmNzc0ZpbGUgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRBcHBsaWNhdGlvbi5zZXRDc3NGaWxlTmFtZSh0aGlzLmFwcE9wdGlvbnMuY3NzRmlsZSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5ib290c3RyYXBOYXRpdmVTY3JpcHRBcHAoKTtcblx0fVxuXG5cdG9uRGVzdHJveShjYWxsYmFjazogKCkgPT4gdm9pZCk6IHZvaWQge1xuXHRcdHRoaXMucGxhdGZvcm0ub25EZXN0cm95KGNhbGxiYWNrKTtcblx0fVxuXG5cdGdldCBpbmplY3RvcigpOiBJbmplY3RvciB7XG5cdFx0cmV0dXJuIHRoaXMucGxhdGZvcm0uaW5qZWN0b3I7XG5cdH1cblxuXHRkZXN0cm95KCk6IHZvaWQge1xuXHRcdHRoaXMucGxhdGZvcm0uZGVzdHJveSgpO1xuXHR9XG5cblx0Z2V0IGRlc3Ryb3llZCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5wbGF0Zm9ybS5kZXN0cm95ZWQ7XG5cdH1cblxuXHRAcHJvZmlsZVxuXHRwcml2YXRlIGJvb3RzdHJhcE5hdGl2ZVNjcmlwdEFwcCgpIHtcblx0XHRsZXQgcm9vdENvbnRlbnQ6IFZpZXc7XG5cblx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLmJvb3RzdHJhcExvZygnTmF0aXZlU2NyaXB0UGxhdGZvcm0gYm9vdHN0cmFwIHN0YXJ0ZWQuJyk7XG5cdFx0fVxuXHRcdGNvbnN0IGxhdW5jaENhbGxiYWNrID0gcHJvZmlsZSgnQG5hdGl2ZXNjcmlwdC9hbmd1bGFyL3BsYXRmb3JtLWNvbW1vbi5sYXVuY2hDYWxsYmFjaycsIChhcmdzOiBMYXVuY2hFdmVudERhdGEpID0+IHtcblx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2coJ0FwcGxpY2F0aW9uIGxhdW5jaCBldmVudCBmaXJlZCcpO1xuXHRcdFx0fVxuXG5cdFx0XHQvLyBDcmVhdGUgYSB0ZW1wIHBhZ2UgZm9yIHJvb3Qgb2YgdGhlIHJlbmRlcmVyXG5cdFx0XHRsZXQgdGVtcEFwcEhvc3RWaWV3OiBBcHBIb3N0Vmlldztcblx0XHRcdGxldCB0ZW1wQXBwSG9zdEFzeW5jVmlldzogQXBwSG9zdEFzeW5jVmlldztcblx0XHRcdGlmICh0aGlzLmFwcE9wdGlvbnMgJiYgKHRoaXMuYXBwT3B0aW9ucy5hc3luYyB8fCB0aGlzLmFwcE9wdGlvbnMubGF1bmNoVmlldykpIHtcblx0XHRcdFx0dGVtcEFwcEhvc3RBc3luY1ZpZXcgPSBuZXcgQXBwSG9zdEFzeW5jVmlldyhuZXcgQ29sb3IodGhpcy5hcHBPcHRpb25zICYmIHRoaXMuYXBwT3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IgPyB0aGlzLmFwcE9wdGlvbnMuYmFja2dyb3VuZENvbG9yIDogJyNmZmYnKSk7XG5cdFx0XHRcdGlmICh0aGlzLmFwcE9wdGlvbnMubGF1bmNoVmlldykge1xuXHRcdFx0XHRcdHRoaXMuYXBwT3B0aW9ucy5sYXVuY2hWaWV3LnN0eWxlLnpJbmRleCA9IDEwMDA7XG5cdFx0XHRcdFx0dGVtcEFwcEhvc3RBc3luY1ZpZXcuYWRkQ2hpbGQodGhpcy5hcHBPcHRpb25zLmxhdW5jaFZpZXcpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJvb3RDb250ZW50ID0gdGVtcEFwcEhvc3RBc3luY1ZpZXcubmdBcHBSb290O1xuXHRcdFx0XHRzZXRSb290UGFnZSg8YW55PnRlbXBBcHBIb3N0QXN5bmNWaWV3KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRlbXBBcHBIb3N0VmlldyA9IG5ldyBBcHBIb3N0VmlldyhuZXcgQ29sb3IodGhpcy5hcHBPcHRpb25zICYmIHRoaXMuYXBwT3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IgPyB0aGlzLmFwcE9wdGlvbnMuYmFja2dyb3VuZENvbG9yIDogJyNmZmYnKSk7XG5cdFx0XHRcdHNldFJvb3RQYWdlKDxhbnk+dGVtcEFwcEhvc3RWaWV3KTtcblx0XHRcdH1cblxuXHRcdFx0bGV0IGJvb3RzdHJhcFByb21pc2VDb21wbGV0ZWQgPSBmYWxzZTtcblx0XHRcdGNvbnN0IGJvb3RzdHJhcCA9ICgpID0+IHtcblx0XHRcdFx0dGhpcy5fYm9vdHN0cmFwcGVyKCkudGhlbihcblx0XHRcdFx0XHQobW9kdWxlUmVmKSA9PiB7XG5cdFx0XHRcdFx0XHRib290c3RyYXBQcm9taXNlQ29tcGxldGVkID0gdHJ1ZTtcblx0XHRcdFx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHRcdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2coYEFuZ3VsYXIgYm9vdHN0cmFwIGJvb3RzdHJhcCBkb25lLiB1cHRpbWU6ICR7cHJvZmlsaW5nVXB0aW1lKCl9YCk7XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGlmICh0aGlzLmFwcE9wdGlvbnMubGF1bmNoVmlldyAmJiB0aGlzLmFwcE9wdGlvbnMubGF1bmNoVmlldy5jbGVhbnVwKSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMuYXBwT3B0aW9ucy5sYXVuY2hWaWV3LmNsZWFudXAoKS50aGVuKCgpID0+IHtcblx0XHRcdFx0XHRcdFx0XHQvLyBjbGVhbnVwIGFueSBjdXN0b20gbGF1bmNoIHZpZXdzXG5cdFx0XHRcdFx0XHRcdFx0dGVtcEFwcEhvc3RBc3luY1ZpZXcucmVtb3ZlQ2hpbGQodGhpcy5hcHBPcHRpb25zLmxhdW5jaFZpZXcpO1xuXHRcdFx0XHRcdFx0XHRcdHRoaXMuYXBwT3B0aW9ucy5sYXVuY2hWaWV3ID0gbnVsbDtcblx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHR9IGVsc2UgaWYgKHRlbXBBcHBIb3N0Vmlldykge1xuXHRcdFx0XHRcdFx0XHRyb290Q29udGVudCA9IHRlbXBBcHBIb3N0Vmlldy5jb250ZW50O1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRsYXN0Qm9vdHN0cmFwcGVkTW9kdWxlID0gbmV3IFdlYWtSZWYobW9kdWxlUmVmKTtcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdChlcnIpID0+IHtcblx0XHRcdFx0XHRcdGJvb3RzdHJhcFByb21pc2VDb21wbGV0ZWQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0Y29uc3QgZXJyb3JNZXNzYWdlID0gZXJyLm1lc3NhZ2UgKyAnXFxuXFxuJyArIGVyci5zdGFjaztcblx0XHRcdFx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHRcdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2dFcnJvcignRVJST1IgQk9PVFNUUkFQUElORyBBTkdVTEFSJyk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdFx0XHRcdFx0TmF0aXZlU2NyaXB0RGVidWcuYm9vdHN0cmFwTG9nRXJyb3IoZXJyb3JNZXNzYWdlKTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0cm9vdENvbnRlbnQgPSB0aGlzLmNyZWF0ZUVycm9yVUkoZXJyb3JNZXNzYWdlKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdCk7XG5cdFx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLmJvb3RzdHJhcExvZygnYm9vdHN0cmFwQWN0aW9uIGNhbGxlZCwgZHJhaW5pbmcgbWljcm8gdGFza3MgcXVldWUuIFJvb3Q6ICcgKyByb290Q29udGVudCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0KDxhbnk+Z2xvYmFsKS5ab25lLmRyYWluTWljcm9UYXNrUXVldWUoKTtcblx0XHRcdFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHRcdFx0TmF0aXZlU2NyaXB0RGVidWcuYm9vdHN0cmFwTG9nKCdib290c3RyYXBBY3Rpb24gY2FsbGVkLCBkcmFpbmluZyBtaWNybyB0YXNrcyBxdWV1ZSBmaW5pc2hlZCEgUm9vdDogJyArIHJvb3RDb250ZW50KTtcblx0XHRcdFx0fVxuXHRcdFx0fTtcblxuXHRcdFx0aWYgKHRoaXMuYXBwT3B0aW9ucyAmJiB0aGlzLmFwcE9wdGlvbnMubGF1bmNoVmlldyAmJiB0aGlzLmFwcE9wdGlvbnMubGF1bmNoVmlldy5zdGFydEFuaW1hdGlvbikge1xuXHRcdFx0XHQvLyBzdGFydCBhbmltYXRpb25zIG9uIG5leHQgdGljayAoYWZ0ZXIgaW5pdGlhbCBib290KVxuXHRcdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0XHQvLyBlbnN1cmUgbGF1bmNoIGFuaW1hdGlvbiBpcyBleGVjdXRlZCBhZnRlciBsYXVuY2hWaWV3IGFkZGVkIHRvIHZpZXcgc3RhY2tcblx0XHRcdFx0XHR0aGlzLmFwcE9wdGlvbnMubGF1bmNoVmlldy5zdGFydEFuaW1hdGlvbigpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHRcdGJvb3RzdHJhcCgpO1xuXHRcdFx0Ly8gaWYgKCFib290c3RyYXBQcm9taXNlQ29tcGxldGVkKSB7XG5cdFx0XHQvLyBcdGNvbnN0IGVycm9yTWVzc2FnZSA9IFwiQm9vdHN0cmFwIHByb21pc2UgZGlkbid0IHJlc29sdmVcIjtcblx0XHRcdC8vIFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHQvLyBcdFx0TmF0aXZlU2NyaXB0RGVidWcuYm9vdHN0cmFwTG9nRXJyb3IoZXJyb3JNZXNzYWdlKTtcblx0XHRcdC8vIFx0fVxuXHRcdFx0Ly8gXHRyb290Q29udGVudCA9IHRoaXMuY3JlYXRlRXJyb3JVSShlcnJvck1lc3NhZ2UpO1xuXHRcdFx0Ly8gfVxuXHRcdFx0YXJncy5yb290ID0gcm9vdENvbnRlbnQ7XG5cdFx0fSk7XG5cdFx0Y29uc3QgZXhpdENhbGxiYWNrID0gcHJvZmlsZSgnQG5hdGl2ZXNjcmlwdC9hbmd1bGFyL3BsYXRmb3JtLWNvbW1vbi5leGl0Q2FsbGJhY2snLCAoYXJnczogQXBwbGljYXRpb25FdmVudERhdGEpID0+IHtcblx0XHRcdGNvbnN0IGFuZHJvaWRBY3Rpdml0eSA9IGFyZ3MuYW5kcm9pZDtcblx0XHRcdGlmIChhbmRyb2lkQWN0aXZpdHkgJiYgIWFuZHJvaWRBY3Rpdml0eS5pc0ZpbmlzaGluZygpKSB7XG5cdFx0XHRcdC8vIEV4aXQgZXZlbnQgd2FzIHRyaWdnZXJlZCBhcyBhIHBhcnQgb2YgYSByZXN0YXJ0IG9mIHRoZSBhcHAuXG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgbGFzdE1vZHVsZVJlZiA9IGxhc3RCb290c3RyYXBwZWRNb2R1bGUgPyBsYXN0Qm9vdHN0cmFwcGVkTW9kdWxlLmdldCgpIDogbnVsbDtcblx0XHRcdGlmIChsYXN0TW9kdWxlUmVmKSB7XG5cdFx0XHRcdC8vIE1ha2Ugc3VyZSB0aGUgbW9kdWxlIGlzIG9ubHkgZGVzdHJveWVkIG9uY2Vcblx0XHRcdFx0bGFzdEJvb3RzdHJhcHBlZE1vZHVsZSA9IG51bGw7XG5cblx0XHRcdFx0bGFzdE1vZHVsZVJlZi5kZXN0cm95KCk7XG5cdFx0XHR9XG5cblx0XHRcdHJvb3RDb250ZW50ID0gbnVsbDtcblx0XHR9KTtcblxuXHRcdEFwcGxpY2F0aW9uLm9uKEFwcGxpY2F0aW9uLmxhdW5jaEV2ZW50LCBsYXVuY2hDYWxsYmFjayk7XG5cdFx0QXBwbGljYXRpb24ub24oQXBwbGljYXRpb24uZXhpdEV2ZW50LCBleGl0Q2FsbGJhY2spO1xuXG5cdFx0QXBwbGljYXRpb24ucnVuKCk7XG5cdH1cblxuXHRAcHJvZmlsZVxuXHRwdWJsaWMgX2xpdmVzeW5jKCkge1xuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcuYm9vdHN0cmFwTG9nKCdBbmd1bGFyIGxpdmVzeW5jIHN0YXJ0ZWQuJyk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgbGFzdE1vZHVsZVJlZiA9IGxhc3RCb290c3RyYXBwZWRNb2R1bGUgPyBsYXN0Qm9vdHN0cmFwcGVkTW9kdWxlLmdldCgpIDogbnVsbDtcblx0XHRvbkJlZm9yZUxpdmVzeW5jLm5leHQobGFzdE1vZHVsZVJlZik7XG5cdFx0aWYgKGxhc3RNb2R1bGVSZWYpIHtcblx0XHRcdGxhc3RNb2R1bGVSZWYuZGVzdHJveSgpO1xuXHRcdH1cblxuXHRcdHRoaXMuX2Jvb3RzdHJhcHBlcigpLnRoZW4oXG5cdFx0XHQobW9kdWxlUmVmKSA9PiB7XG5cdFx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLmJvb3RzdHJhcExvZygnQW5ndWxhciBsaXZlc3luYyBkb25lLicpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdG9uQWZ0ZXJMaXZlc3luYy5uZXh0KHsgbW9kdWxlUmVmIH0pO1xuXG5cdFx0XHRcdGxhc3RCb290c3RyYXBwZWRNb2R1bGUgPSBuZXcgV2Vha1JlZihtb2R1bGVSZWYpO1xuXHRcdFx0XHRBcHBsaWNhdGlvbi5yZXNldFJvb3RWaWV3KHtcblx0XHRcdFx0XHRjcmVhdGU6ICgpID0+IGdldFJvb3RQYWdlKCksXG5cdFx0XHRcdH0pO1xuXHRcdFx0fSxcblx0XHRcdChlcnJvcikgPT4ge1xuXHRcdFx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2dFcnJvcignRVJST1IgTElWRVNZTkMgQk9PVFNUUkFQUElORyBBTkdVTEFSJyk7XG5cdFx0XHRcdH1cblx0XHRcdFx0Y29uc3QgZXJyb3JNZXNzYWdlID0gZXJyb3IubWVzc2FnZSArICdcXG5cXG4nICsgZXJyb3Iuc3RhY2s7XG5cdFx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLmJvb3RzdHJhcExvZ0Vycm9yKGVycm9yTWVzc2FnZSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRBcHBsaWNhdGlvbi5yZXNldFJvb3RWaWV3KHtcblx0XHRcdFx0XHRjcmVhdGU6ICgpID0+IHRoaXMuY3JlYXRlRXJyb3JVSShlcnJvck1lc3NhZ2UpLFxuXHRcdFx0XHR9KTtcblx0XHRcdFx0b25BZnRlckxpdmVzeW5jLm5leHQoeyBlcnJvciB9KTtcblx0XHRcdH1cblx0XHQpO1xuXHR9XG5cblx0cHJpdmF0ZSBjcmVhdGVFcnJvclVJKG1lc3NhZ2U6IHN0cmluZyk6IFZpZXcge1xuXHRcdGNvbnN0IGVycm9yVGV4dEJveCA9IG5ldyBUZXh0VmlldygpO1xuXHRcdGVycm9yVGV4dEJveC50ZXh0ID0gbWVzc2FnZTtcblx0XHRlcnJvclRleHRCb3guY29sb3IgPSBuZXcgQ29sb3IoJ3JlZCcpO1xuXHRcdHJldHVybiBlcnJvclRleHRCb3g7XG5cdH1cblxuXHRwcml2YXRlIGNyZWF0ZUZyYW1lQW5kUGFnZShpc0xpdmVzeW5jOiBib29sZWFuKSB7XG5cdFx0Y29uc3QgZnJhbWUgPSBuZXcgRnJhbWUoKTtcblx0XHRjb25zdCBwYWdlRmFjdG9yeTogUGFnZUZhY3RvcnkgPSB0aGlzLnBsYXRmb3JtLmluamVjdG9yLmdldChQQUdFX0ZBQ1RPUlkpO1xuXHRcdGNvbnN0IHBhZ2UgPSBwYWdlRmFjdG9yeSh7IGlzQm9vdHN0cmFwOiB0cnVlLCBpc0xpdmVzeW5jIH0pO1xuXG5cdFx0ZnJhbWUubmF2aWdhdGUoe1xuXHRcdFx0Y3JlYXRlOiAoKSA9PiB7XG5cdFx0XHRcdHJldHVybiBwYWdlO1xuXHRcdFx0fSxcblx0XHR9KTtcblx0XHRyZXR1cm4geyBwYWdlLCBmcmFtZSB9O1xuXHR9XG59XG4iXX0=
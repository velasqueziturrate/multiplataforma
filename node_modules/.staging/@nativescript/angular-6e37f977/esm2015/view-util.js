import { unsetValue, ContentView, LayoutBase, platformNames } from '@nativescript/core';
import { CommentNode, TextNode, getViewClass, getViewMeta, isDetachedElement, isInvisibleNode, isKnownView, isView } from './element-registry';
import { NativeScriptDebug } from './trace';
const ELEMENT_NODE_TYPE = 1;
const XML_ATTRIBUTES = Object.freeze(['style', 'rows', 'columns', 'fontAttributes']);
const whiteSpaceSplitter = /\s+/;
export function isLayout(view) {
    return view instanceof LayoutBase;
}
export function isContentView(view) {
    return view instanceof ContentView;
}
const propertyMaps = new Map();
export class ViewUtil {
    constructor(device) {
        this.isIos = device.os === platformNames.ios;
        this.isAndroid = device.os === platformNames.android;
    }
    insertChild(parent, child, previous, next) {
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        if (!previous) {
            previous = extendedParent.lastChild;
        }
        this.addToQueue(extendedParent, extendedChild, previous, next);
        if (isInvisibleNode(child)) {
            extendedChild.parentNode = extendedParent;
        }
        if (!isDetachedElement(child)) {
            const nextVisual = this.findNextVisual(next);
            this.addToVisualTree(extendedParent, extendedChild, nextVisual);
        }
    }
    addToQueue(parent, child, previous, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.addToQueue parent: ${parent}, view: ${child}, ` + `previous: ${previous}, next: ${next}`);
        }
        if (previous) {
            previous.nextSibling = child;
        }
        else {
            parent.firstChild = child;
        }
        if (next) {
            child.nextSibling = next;
        }
        else {
            this.appendToQueue(parent, child);
        }
    }
    appendToQueue(parent, view) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.appendToQueue parent: ${parent} view: ${view}`);
        }
        if (parent.lastChild) {
            parent.lastChild.nextSibling = view;
        }
        parent.lastChild = view;
    }
    addToVisualTree(parent, child, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.addToVisualTree parent: ${parent}, view: ${child}, next: ${next}`);
        }
        if (parent.meta && parent.meta.insertChild) {
            parent.meta.insertChild(parent, child, next);
        }
        else if (isLayout(parent)) {
            this.insertToLayout(parent, child, next);
        }
        else if (isContentView(parent)) {
            parent.content = child;
        }
        else if (parent && parent._addChildFromBuilder) {
            parent._addChildFromBuilder(child.nodeName, child);
        }
    }
    insertToLayout(parent, child, next) {
        if (child.parent === parent) {
            this.removeLayoutChild(parent, child);
        }
        const nextVisual = this.findNextVisual(next);
        if (nextVisual) {
            const index = parent.getChildIndex(nextVisual);
            parent.insertChild(child, index);
        }
        else {
            parent.addChild(child);
        }
    }
    findNextVisual(view) {
        let next = view;
        while (next && isDetachedElement(next)) {
            next = next.nextSibling;
        }
        return next;
    }
    removeChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeChild parent: ${parent} child: ${child}`);
        }
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        this.removeFromQueue(extendedParent, extendedChild);
        if (!isDetachedElement(extendedChild)) {
            this.removeFromVisualTree(extendedParent, extendedChild);
        }
    }
    removeFromQueue(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromQueue parent: ${parent} child: ${child}`);
        }
        if (parent.firstChild === child && parent.lastChild === child) {
            parent.firstChild = null;
            parent.lastChild = null;
            child.nextSibling = null;
            return;
        }
        if (parent.firstChild === child) {
            parent.firstChild = child.nextSibling;
        }
        const previous = this.findPreviousElement(parent, child);
        if (parent.lastChild === child) {
            parent.lastChild = previous;
        }
        if (previous) {
            previous.nextSibling = child.nextSibling;
        }
        child.nextSibling = null;
    }
    // NOTE: This one is O(n) - use carefully
    findPreviousElement(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.findPreviousElement parent: ${parent} child: ${child}`);
        }
        let previousVisual;
        if (isLayout(parent)) {
            previousVisual = this.getPreviousVisualElement(parent, child);
        }
        let previous = previousVisual || parent.firstChild;
        // since detached elements are not added to the visual tree,
        // we need to find the actual previous sibling of the view,
        // which may as well be an invisible node
        while (previous && previous !== child && previous.nextSibling !== child) {
            previous = previous.nextSibling;
        }
        return previous;
    }
    getPreviousVisualElement(parent, child) {
        const elementIndex = parent.getChildIndex(child);
        if (elementIndex > 0) {
            return parent.getChildAt(elementIndex - 1);
        }
    }
    // NOTE: This one is O(n) - use carefully
    getChildIndex(parent, child) {
        if (isLayout(parent)) {
            return parent.getChildIndex(child);
        }
        else if (isContentView(parent)) {
            return child === parent.content ? 0 : -1;
        }
    }
    removeFromVisualTree(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromVisualTree parent: ${parent} child: ${child}`);
        }
        if (parent.meta && parent.meta.removeChild) {
            parent.meta.removeChild(parent, child);
        }
        else if (isLayout(parent)) {
            this.removeLayoutChild(parent, child);
        }
        else if (isContentView(parent) && parent.content === child) {
            parent.content = null;
        }
        else if (isView(parent)) {
            parent._removeView(child);
        }
    }
    removeLayoutChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeLayoutChild parent: ${parent} child: ${child}`);
        }
        const index = parent.getChildIndex(child);
        if (index !== -1) {
            parent.removeChild(child);
        }
    }
    createComment() {
        return new CommentNode();
    }
    createText() {
        return new TextNode();
    }
    createView(name) {
        const originalName = name;
        if (!isKnownView(name)) {
            name = 'ProxyViewContainer';
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Creating view: ${originalName} ${name}`);
        }
        const viewClass = getViewClass(name);
        const view = new viewClass();
        const ngView = this.setNgViewExtensions(view, name);
        return ngView;
    }
    ensureNgViewExtensions(view) {
        if (view.hasOwnProperty('meta')) {
            return view;
        }
        else {
            const name = view.cssType;
            const ngView = this.setNgViewExtensions(view, name);
            return ngView;
        }
    }
    setNgViewExtensions(view, name) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Make into a NgView view: ${view} name: "${name}"`);
        }
        const ngView = view;
        ngView.nodeName = name;
        ngView.meta = getViewMeta(name);
        // we're setting the node type of the view
        // to 'element' because of checks done in the
        // dom animation engine
        ngView.nodeType = ELEMENT_NODE_TYPE;
        return ngView;
    }
    setProperty(view, attributeName, value, namespace) {
        if (!view || (namespace && !this.runsIn(namespace))) {
            return;
        }
        if (attributeName.indexOf('.') !== -1) {
            // Handle nested properties
            const properties = attributeName.split('.');
            attributeName = properties[properties.length - 1];
            let propMap = this.getProperties(view);
            let i = 0;
            while (i < properties.length - 1 && typeof view !== 'undefined') {
                let prop = properties[i];
                if (propMap.has(prop)) {
                    prop = propMap.get(prop);
                }
                view = view[prop];
                propMap = this.getProperties(view);
                i++;
            }
        }
        if (typeof view !== 'undefined') {
            this.setPropertyInternal(view, attributeName, value);
        }
    }
    runsIn(platform) {
        return (platform === 'ios' && this.isIos) || (platform === 'android' && this.isAndroid);
    }
    setPropertyInternal(view, attributeName, value) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Setting attribute: ${attributeName}=${value} to ${view}`);
        }
        if (attributeName === 'class') {
            this.setClasses(view, value);
            return;
        }
        if (XML_ATTRIBUTES.indexOf(attributeName) !== -1) {
            view[attributeName] = value;
            return;
        }
        const propMap = this.getProperties(view);
        const propertyName = propMap.get(attributeName);
        // Ensure the children of a collection currently have no parent set.
        if (Array.isArray(value)) {
            this.removeParentReferencesFromItems(value);
        }
        if (propertyName) {
            // We have a lower-upper case mapped property.
            view[propertyName] = value;
            return;
        }
        // Unknown attribute value -- just set it to our object as is.
        view[attributeName] = value;
    }
    removeParentReferencesFromItems(items) {
        for (const item of items) {
            if (item.parent && item.parentNode) {
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.viewUtilLog(`Unassigning parent ${item.parentNode} on value: ${item}`);
                }
                item.parent = undefined;
                item.parentNode = undefined;
            }
        }
    }
    getProperties(instance) {
        const type = instance && instance.constructor;
        if (!type) {
            return new Map();
        }
        if (!propertyMaps.has(type)) {
            let propMap = new Map();
            for (let propName in instance) {
                // tslint:disable:forin
                propMap.set(propName.toLowerCase(), propName);
            }
            propertyMaps.set(type, propMap);
        }
        return propertyMaps.get(type);
    }
    cssClasses(view) {
        if (!view.ngCssClasses) {
            view.ngCssClasses = new Map();
        }
        return view.ngCssClasses;
    }
    addClass(view, className) {
        this.cssClasses(view).set(className, true);
        this.syncClasses(view);
    }
    removeClass(view, className) {
        this.cssClasses(view).delete(className);
        this.syncClasses(view);
    }
    setClasses(view, classesValue) {
        let classes = classesValue.split(whiteSpaceSplitter);
        this.cssClasses(view).clear();
        classes.forEach((className) => this.cssClasses(view).set(className, true));
        this.syncClasses(view);
    }
    syncClasses(view) {
        let classValue = Array.from(this.cssClasses(view).keys()).join(' ');
        view.className = classValue;
    }
    setStyle(view, styleName, value) {
        view.style[styleName] = value;
    }
    removeStyle(view, styleName) {
        view.style[styleName] = unsetValue;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy11dGlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdmlldy11dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBUSxVQUFVLEVBQWUsV0FBVyxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQVUsTUFBTSxvQkFBb0IsQ0FBQztBQUNuSCxPQUFPLEVBQUUsV0FBVyxFQUF5QixRQUFRLEVBQWtCLFlBQVksRUFBRSxXQUFXLEVBQUUsaUJBQWlCLEVBQUUsZUFBZSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV0TCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFNUMsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLENBQUM7QUFDNUIsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztBQUNyRixNQUFNLGtCQUFrQixHQUFHLEtBQUssQ0FBQztBQVNqQyxNQUFNLFVBQVUsUUFBUSxDQUFDLElBQVM7SUFDakMsT0FBTyxJQUFJLFlBQVksVUFBVSxDQUFDO0FBQ25DLENBQUM7QUFFRCxNQUFNLFVBQVUsYUFBYSxDQUFDLElBQVM7SUFDdEMsT0FBTyxJQUFJLFlBQVksV0FBVyxDQUFDO0FBQ3BDLENBQUM7QUFFRCxNQUFNLFlBQVksR0FBdUMsSUFBSSxHQUFHLEVBQWlDLENBQUM7QUFFbEcsTUFBTSxPQUFPLFFBQVE7SUFJcEIsWUFBWSxNQUFxQjtRQUNoQyxJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxFQUFFLEtBQUssYUFBYSxDQUFDLEdBQUcsQ0FBQztRQUM3QyxJQUFJLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxFQUFFLEtBQUssYUFBYSxDQUFDLE9BQU8sQ0FBQztJQUN0RCxDQUFDO0lBRU0sV0FBVyxDQUFDLE1BQVksRUFBRSxLQUFX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QVk7UUFDL0IsSUFBSSxVQUFVLEdBQVMsS0FBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNFLElBQUksQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDO0lBQzdCLENBQUM7SUFFTSxRQUFRLENBQUMsSUFBWSxFQUFFLFNBQWlCLEVBQUUsS0FBVTtRQUMxRCxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQztJQUMvQixDQUFDO0lBRU0sV0FBVyxDQUFDLElBQVksRUFBRSxTQUFpQjtRQUNqRCxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLFVBQVUsQ0FBQztJQUNwQyxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWaWV3LCB1bnNldFZhbHVlLCBQbGFjZWhvbGRlciwgQ29udGVudFZpZXcsIExheW91dEJhc2UsIHBsYXRmb3JtTmFtZXMsIERldmljZSB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBDb21tZW50Tm9kZSwgSW52aXNpYmxlTm9kZSwgTmdWaWV3LCBUZXh0Tm9kZSwgVmlld0V4dGVuc2lvbnMsIGdldFZpZXdDbGFzcywgZ2V0Vmlld01ldGEsIGlzRGV0YWNoZWRFbGVtZW50LCBpc0ludmlzaWJsZU5vZGUsIGlzS25vd25WaWV3LCBpc1ZpZXcgfSBmcm9tICcuL2VsZW1lbnQtcmVnaXN0cnknO1xuXG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4vdHJhY2UnO1xuXG5jb25zdCBFTEVNRU5UX05PREVfVFlQRSA9IDE7XG5jb25zdCBYTUxfQVRUUklCVVRFUyA9IE9iamVjdC5mcmVlemUoWydzdHlsZScsICdyb3dzJywgJ2NvbHVtbnMnLCAnZm9udEF0dHJpYnV0ZXMnXSk7XG5jb25zdCB3aGl0ZVNwYWNlU3BsaXR0ZXIgPSAvXFxzKy87XG5cbi8vIGV4cG9ydCB0eXBlIFZpZXdFeHRlbnNpb25zID0gVmlld0V4dGVuc2lvbnM7XG4vLyBleHBvcnQgdHlwZSBOZ1ZpZXcgPSBOZ1ZpZXc7XG5leHBvcnQgdHlwZSBOZ0xheW91dEJhc2UgPSBMYXlvdXRCYXNlICYgVmlld0V4dGVuc2lvbnM7XG5leHBvcnQgdHlwZSBOZ0NvbnRlbnRWaWV3ID0gQ29udGVudFZpZXcgJiBWaWV3RXh0ZW5zaW9ucztcbmV4cG9ydCB0eXBlIE5nUGxhY2Vob2xkZXIgPSBQbGFjZWhvbGRlciAmIFZpZXdFeHRlbnNpb25zO1xuZXhwb3J0IHR5cGUgQmVmb3JlQXR0YWNoQWN0aW9uID0gKHZpZXc6IFZpZXcpID0+IHZvaWQ7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0xheW91dCh2aWV3OiBhbnkpOiB2aWV3IGlzIE5nTGF5b3V0QmFzZSB7XG5cdHJldHVybiB2aWV3IGluc3RhbmNlb2YgTGF5b3V0QmFzZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQ29udGVudFZpZXcodmlldzogYW55KTogdmlldyBpcyBOZ0NvbnRlbnRWaWV3IHtcblx0cmV0dXJuIHZpZXcgaW5zdGFuY2VvZiBDb250ZW50Vmlldztcbn1cblxuY29uc3QgcHJvcGVydHlNYXBzOiBNYXA8RnVuY3Rpb24sIE1hcDxzdHJpbmcsIHN0cmluZz4+ID0gbmV3IE1hcDxGdW5jdGlvbiwgTWFwPHN0cmluZywgc3RyaW5nPj4oKTtcblxuZXhwb3J0IGNsYXNzIFZpZXdVdGlsIHtcblx0cHJpdmF0ZSBpc0lvczogYm9vbGVhbjtcblx0cHJpdmF0ZSBpc0FuZHJvaWQ6IGJvb2xlYW47XG5cblx0Y29uc3RydWN0b3IoZGV2aWNlOiB0eXBlb2YgRGV2aWNlKSB7XG5cdFx0dGhpcy5pc0lvcyA9IGRldmljZS5vcyA9PT0gcGxhdGZvcm1OYW1lcy5pb3M7XG5cdFx0dGhpcy5pc0FuZHJvaWQgPSBkZXZpY2Uub3MgPT09IHBsYXRmb3JtTmFtZXMuYW5kcm9pZDtcblx0fVxuXG5cdHB1YmxpYyBpbnNlcnRDaGlsZChwYXJlbnQ6IFZpZXcsIGNoaWxkOiBWaWV3LCBwcmV2aW91cz86IE5nVmlldywgbmV4dD86IE5nVmlldykge1xuXHRcdGlmICghcGFyZW50KSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Y29uc3QgZXh0ZW5kZWRQYXJlbnQgPSB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnMocGFyZW50KTtcblx0XHRjb25zdCBleHRlbmRlZENoaWxkID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKGNoaWxkKTtcblxuXHRcdGlmICghcHJldmlvdXMpIHtcblx0XHRcdHByZXZpb3VzID0gZXh0ZW5kZWRQYXJlbnQubGFzdENoaWxkO1xuXHRcdH1cblx0XHR0aGlzLmFkZFRvUXVldWUoZXh0ZW5kZWRQYXJlbnQsIGV4dGVuZGVkQ2hpbGQsIHByZXZpb3VzLCBuZXh0KTtcblxuXHRcdGlmIChpc0ludmlzaWJsZU5vZGUoY2hpbGQpKSB7XG5cdFx0XHRleHRlbmRlZENoaWxkLnBhcmVudE5vZGUgPSBleHRlbmRlZFBhcmVudDtcblx0XHR9XG5cblx0XHRpZiAoIWlzRGV0YWNoZWRFbGVtZW50KGNoaWxkKSkge1xuXHRcdFx0Y29uc3QgbmV4dFZpc3VhbCA9IHRoaXMuZmluZE5leHRWaXN1YWwobmV4dCk7XG5cdFx0XHR0aGlzLmFkZFRvVmlzdWFsVHJlZShleHRlbmRlZFBhcmVudCwgZXh0ZW5kZWRDaGlsZCwgbmV4dFZpc3VhbCk7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBhZGRUb1F1ZXVlKHBhcmVudDogTmdWaWV3LCBjaGlsZDogTmdWaWV3LCBwcmV2aW91czogTmdWaWV3LCBuZXh0OiBOZ1ZpZXcpOiB2b2lkIHtcblx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5hZGRUb1F1ZXVlIHBhcmVudDogJHtwYXJlbnR9LCB2aWV3OiAke2NoaWxkfSwgYCArIGBwcmV2aW91czogJHtwcmV2aW91c30sIG5leHQ6ICR7bmV4dH1gKTtcblx0XHR9XG5cblx0XHRpZiAocHJldmlvdXMpIHtcblx0XHRcdHByZXZpb3VzLm5leHRTaWJsaW5nID0gY2hpbGQ7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHBhcmVudC5maXJzdENoaWxkID0gY2hpbGQ7XG5cdFx0fVxuXG5cdFx0aWYgKG5leHQpIHtcblx0XHRcdGNoaWxkLm5leHRTaWJsaW5nID0gbmV4dDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5hcHBlbmRUb1F1ZXVlKHBhcmVudCwgY2hpbGQpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgYXBwZW5kVG9RdWV1ZShwYXJlbnQ6IE5nVmlldywgdmlldzogTmdWaWV3KSB7XG5cdFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwuYXBwZW5kVG9RdWV1ZSBwYXJlbnQ6ICR7cGFyZW50fSB2aWV3OiAke3ZpZXd9YCk7XG5cdFx0fVxuXG5cdFx0aWYgKHBhcmVudC5sYXN0Q2hpbGQpIHtcblx0XHRcdHBhcmVudC5sYXN0Q2hpbGQubmV4dFNpYmxpbmcgPSB2aWV3O1xuXHRcdH1cblxuXHRcdHBhcmVudC5sYXN0Q2hpbGQgPSB2aWV3O1xuXHR9XG5cblx0cHJpdmF0ZSBhZGRUb1Zpc3VhbFRyZWUocGFyZW50OiBOZ1ZpZXcsIGNoaWxkOiBOZ1ZpZXcsIG5leHQ6IE5nVmlldyk6IHZvaWQge1xuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLmFkZFRvVmlzdWFsVHJlZSBwYXJlbnQ6ICR7cGFyZW50fSwgdmlldzogJHtjaGlsZH0sIG5leHQ6ICR7bmV4dH1gKTtcblx0XHR9XG5cblx0XHRpZiAocGFyZW50Lm1ldGEgJiYgcGFyZW50Lm1ldGEuaW5zZXJ0Q2hpbGQpIHtcblx0XHRcdHBhcmVudC5tZXRhLmluc2VydENoaWxkKHBhcmVudCwgY2hpbGQsIG5leHQpO1xuXHRcdH0gZWxzZSBpZiAoaXNMYXlvdXQocGFyZW50KSkge1xuXHRcdFx0dGhpcy5pbnNlcnRUb0xheW91dChwYXJlbnQsIGNoaWxkLCBuZXh0KTtcblx0XHR9IGVsc2UgaWYgKGlzQ29udGVudFZpZXcocGFyZW50KSkge1xuXHRcdFx0cGFyZW50LmNvbnRlbnQgPSBjaGlsZDtcblx0XHR9IGVsc2UgaWYgKHBhcmVudCAmJiAoPGFueT5wYXJlbnQpLl9hZGRDaGlsZEZyb21CdWlsZGVyKSB7XG5cdFx0XHQoPGFueT5wYXJlbnQpLl9hZGRDaGlsZEZyb21CdWlsZGVyKGNoaWxkLm5vZGVOYW1lLCBjaGlsZCk7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBpbnNlcnRUb0xheW91dChwYXJlbnQ6IE5nTGF5b3V0QmFzZSwgY2hpbGQ6IE5nVmlldywgbmV4dDogTmdWaWV3KTogdm9pZCB7XG5cdFx0aWYgKGNoaWxkLnBhcmVudCA9PT0gcGFyZW50KSB7XG5cdFx0XHR0aGlzLnJlbW92ZUxheW91dENoaWxkKHBhcmVudCwgY2hpbGQpO1xuXHRcdH1cblxuXHRcdGNvbnN0IG5leHRWaXN1YWwgPSB0aGlzLmZpbmROZXh0VmlzdWFsKG5leHQpO1xuXHRcdGlmIChuZXh0VmlzdWFsKSB7XG5cdFx0XHRjb25zdCBpbmRleCA9IHBhcmVudC5nZXRDaGlsZEluZGV4KG5leHRWaXN1YWwpO1xuXHRcdFx0cGFyZW50Lmluc2VydENoaWxkKGNoaWxkLCBpbmRleCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHBhcmVudC5hZGRDaGlsZChjaGlsZCk7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBmaW5kTmV4dFZpc3VhbCh2aWV3OiBOZ1ZpZXcpOiBOZ1ZpZXcge1xuXHRcdGxldCBuZXh0ID0gdmlldztcblx0XHR3aGlsZSAobmV4dCAmJiBpc0RldGFjaGVkRWxlbWVudChuZXh0KSkge1xuXHRcdFx0bmV4dCA9IG5leHQubmV4dFNpYmxpbmc7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG5leHQ7XG5cdH1cblxuXHRwdWJsaWMgcmVtb3ZlQ2hpbGQocGFyZW50OiBWaWV3LCBjaGlsZDogVmlldykge1xuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLnJlbW92ZUNoaWxkIHBhcmVudDogJHtwYXJlbnR9IGNoaWxkOiAke2NoaWxkfWApO1xuXHRcdH1cblxuXHRcdGlmICghcGFyZW50KSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Y29uc3QgZXh0ZW5kZWRQYXJlbnQgPSB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnMocGFyZW50KTtcblx0XHRjb25zdCBleHRlbmRlZENoaWxkID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKGNoaWxkKTtcblxuXHRcdHRoaXMucmVtb3ZlRnJvbVF1ZXVlKGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkKTtcblx0XHRpZiAoIWlzRGV0YWNoZWRFbGVtZW50KGV4dGVuZGVkQ2hpbGQpKSB7XG5cdFx0XHR0aGlzLnJlbW92ZUZyb21WaXN1YWxUcmVlKGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkKTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIHJlbW92ZUZyb21RdWV1ZShwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldykge1xuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLnJlbW92ZUZyb21RdWV1ZSBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcblx0XHR9XG5cblx0XHRpZiAocGFyZW50LmZpcnN0Q2hpbGQgPT09IGNoaWxkICYmIHBhcmVudC5sYXN0Q2hpbGQgPT09IGNoaWxkKSB7XG5cdFx0XHRwYXJlbnQuZmlyc3RDaGlsZCA9IG51bGw7XG5cdFx0XHRwYXJlbnQubGFzdENoaWxkID0gbnVsbDtcblx0XHRcdGNoaWxkLm5leHRTaWJsaW5nID0gbnVsbDtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAocGFyZW50LmZpcnN0Q2hpbGQgPT09IGNoaWxkKSB7XG5cdFx0XHRwYXJlbnQuZmlyc3RDaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nO1xuXHRcdH1cblxuXHRcdGNvbnN0IHByZXZpb3VzID0gdGhpcy5maW5kUHJldmlvdXNFbGVtZW50KHBhcmVudCwgY2hpbGQpO1xuXHRcdGlmIChwYXJlbnQubGFzdENoaWxkID09PSBjaGlsZCkge1xuXHRcdFx0cGFyZW50Lmxhc3RDaGlsZCA9IHByZXZpb3VzO1xuXHRcdH1cblxuXHRcdGlmIChwcmV2aW91cykge1xuXHRcdFx0cHJldmlvdXMubmV4dFNpYmxpbmcgPSBjaGlsZC5uZXh0U2libGluZztcblx0XHR9XG5cblx0XHRjaGlsZC5uZXh0U2libGluZyA9IG51bGw7XG5cdH1cblxuXHQvLyBOT1RFOiBUaGlzIG9uZSBpcyBPKG4pIC0gdXNlIGNhcmVmdWxseVxuXHRwcml2YXRlIGZpbmRQcmV2aW91c0VsZW1lbnQocGFyZW50OiBOZ1ZpZXcsIGNoaWxkOiBOZ1ZpZXcpOiBOZ1ZpZXcge1xuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLmZpbmRQcmV2aW91c0VsZW1lbnQgcGFyZW50OiAke3BhcmVudH0gY2hpbGQ6ICR7Y2hpbGR9YCk7XG5cdFx0fVxuXG5cdFx0bGV0IHByZXZpb3VzVmlzdWFsO1xuXHRcdGlmIChpc0xheW91dChwYXJlbnQpKSB7XG5cdFx0XHRwcmV2aW91c1Zpc3VhbCA9IHRoaXMuZ2V0UHJldmlvdXNWaXN1YWxFbGVtZW50KHBhcmVudCwgY2hpbGQpO1xuXHRcdH1cblxuXHRcdGxldCBwcmV2aW91cyA9IHByZXZpb3VzVmlzdWFsIHx8IHBhcmVudC5maXJzdENoaWxkO1xuXG5cdFx0Ly8gc2luY2UgZGV0YWNoZWQgZWxlbWVudHMgYXJlIG5vdCBhZGRlZCB0byB0aGUgdmlzdWFsIHRyZWUsXG5cdFx0Ly8gd2UgbmVlZCB0byBmaW5kIHRoZSBhY3R1YWwgcHJldmlvdXMgc2libGluZyBvZiB0aGUgdmlldyxcblx0XHQvLyB3aGljaCBtYXkgYXMgd2VsbCBiZSBhbiBpbnZpc2libGUgbm9kZVxuXHRcdHdoaWxlIChwcmV2aW91cyAmJiBwcmV2aW91cyAhPT0gY2hpbGQgJiYgcHJldmlvdXMubmV4dFNpYmxpbmcgIT09IGNoaWxkKSB7XG5cdFx0XHRwcmV2aW91cyA9IHByZXZpb3VzLm5leHRTaWJsaW5nO1xuXHRcdH1cblxuXHRcdHJldHVybiBwcmV2aW91cztcblx0fVxuXG5cdHByaXZhdGUgZ2V0UHJldmlvdXNWaXN1YWxFbGVtZW50KHBhcmVudDogTmdMYXlvdXRCYXNlLCBjaGlsZDogTmdWaWV3KTogTmdWaWV3IHtcblx0XHRjb25zdCBlbGVtZW50SW5kZXggPSBwYXJlbnQuZ2V0Q2hpbGRJbmRleChjaGlsZCk7XG5cblx0XHRpZiAoZWxlbWVudEluZGV4ID4gMCkge1xuXHRcdFx0cmV0dXJuIHBhcmVudC5nZXRDaGlsZEF0KGVsZW1lbnRJbmRleCAtIDEpIGFzIE5nVmlldztcblx0XHR9XG5cdH1cblxuXHQvLyBOT1RFOiBUaGlzIG9uZSBpcyBPKG4pIC0gdXNlIGNhcmVmdWxseVxuXHRwdWJsaWMgZ2V0Q2hpbGRJbmRleChwYXJlbnQ6IGFueSwgY2hpbGQ6IE5nVmlldykge1xuXHRcdGlmIChpc0xheW91dChwYXJlbnQpKSB7XG5cdFx0XHRyZXR1cm4gcGFyZW50LmdldENoaWxkSW5kZXgoY2hpbGQpO1xuXHRcdH0gZWxzZSBpZiAoaXNDb250ZW50VmlldyhwYXJlbnQpKSB7XG5cdFx0XHRyZXR1cm4gY2hpbGQgPT09IHBhcmVudC5jb250ZW50ID8gMCA6IC0xO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgcmVtb3ZlRnJvbVZpc3VhbFRyZWUocGFyZW50OiBOZ1ZpZXcsIGNoaWxkOiBOZ1ZpZXcpIHtcblx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5yZW1vdmVGcm9tVmlzdWFsVHJlZSBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcblx0XHR9XG5cblx0XHRpZiAocGFyZW50Lm1ldGEgJiYgcGFyZW50Lm1ldGEucmVtb3ZlQ2hpbGQpIHtcblx0XHRcdHBhcmVudC5tZXRhLnJlbW92ZUNoaWxkKHBhcmVudCwgY2hpbGQpO1xuXHRcdH0gZWxzZSBpZiAoaXNMYXlvdXQocGFyZW50KSkge1xuXHRcdFx0dGhpcy5yZW1vdmVMYXlvdXRDaGlsZChwYXJlbnQsIGNoaWxkKTtcblx0XHR9IGVsc2UgaWYgKGlzQ29udGVudFZpZXcocGFyZW50KSAmJiBwYXJlbnQuY29udGVudCA9PT0gY2hpbGQpIHtcblx0XHRcdHBhcmVudC5jb250ZW50ID0gbnVsbDtcblx0XHR9IGVsc2UgaWYgKGlzVmlldyhwYXJlbnQpKSB7XG5cdFx0XHRwYXJlbnQuX3JlbW92ZVZpZXcoY2hpbGQpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgcmVtb3ZlTGF5b3V0Q2hpbGQocGFyZW50OiBOZ0xheW91dEJhc2UsIGNoaWxkOiBOZ1ZpZXcpOiB2b2lkIHtcblx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5yZW1vdmVMYXlvdXRDaGlsZCBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcblx0XHR9XG5cblx0XHRjb25zdCBpbmRleCA9IHBhcmVudC5nZXRDaGlsZEluZGV4KGNoaWxkKTtcblxuXHRcdGlmIChpbmRleCAhPT0gLTEpIHtcblx0XHRcdHBhcmVudC5yZW1vdmVDaGlsZChjaGlsZCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGNyZWF0ZUNvbW1lbnQoKTogSW52aXNpYmxlTm9kZSB7XG5cdFx0cmV0dXJuIG5ldyBDb21tZW50Tm9kZSgpO1xuXHR9XG5cblx0cHVibGljIGNyZWF0ZVRleHQoKTogSW52aXNpYmxlTm9kZSB7XG5cdFx0cmV0dXJuIG5ldyBUZXh0Tm9kZSgpO1xuXHR9XG5cblx0cHVibGljIGNyZWF0ZVZpZXcobmFtZTogc3RyaW5nKTogTmdWaWV3IHtcblx0XHRjb25zdCBvcmlnaW5hbE5hbWUgPSBuYW1lO1xuXHRcdGlmICghaXNLbm93blZpZXcobmFtZSkpIHtcblx0XHRcdG5hbWUgPSAnUHJveHlWaWV3Q29udGFpbmVyJztcblx0XHR9XG5cblx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBDcmVhdGluZyB2aWV3OiAke29yaWdpbmFsTmFtZX0gJHtuYW1lfWApO1xuXHRcdH1cblxuXHRcdGNvbnN0IHZpZXdDbGFzcyA9IGdldFZpZXdDbGFzcyhuYW1lKTtcblx0XHRjb25zdCB2aWV3ID0gPE5nVmlldz5uZXcgdmlld0NsYXNzKCk7XG5cdFx0Y29uc3QgbmdWaWV3ID0gdGhpcy5zZXROZ1ZpZXdFeHRlbnNpb25zKHZpZXcsIG5hbWUpO1xuXG5cdFx0cmV0dXJuIG5nVmlldztcblx0fVxuXG5cdHByaXZhdGUgZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyh2aWV3OiBWaWV3KTogTmdWaWV3IHtcblx0XHRpZiAodmlldy5oYXNPd25Qcm9wZXJ0eSgnbWV0YScpKSB7XG5cdFx0XHRyZXR1cm4gdmlldyBhcyBOZ1ZpZXc7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnN0IG5hbWUgPSB2aWV3LmNzc1R5cGU7XG5cdFx0XHRjb25zdCBuZ1ZpZXcgPSB0aGlzLnNldE5nVmlld0V4dGVuc2lvbnModmlldywgbmFtZSk7XG5cblx0XHRcdHJldHVybiBuZ1ZpZXc7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBzZXROZ1ZpZXdFeHRlbnNpb25zKHZpZXc6IFZpZXcsIG5hbWU6IHN0cmluZyk6IE5nVmlldyB7XG5cdFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgTWFrZSBpbnRvIGEgTmdWaWV3IHZpZXc6ICR7dmlld30gbmFtZTogXCIke25hbWV9XCJgKTtcblx0XHR9XG5cblx0XHRjb25zdCBuZ1ZpZXcgPSB2aWV3IGFzIE5nVmlldztcblx0XHRuZ1ZpZXcubm9kZU5hbWUgPSBuYW1lO1xuXHRcdG5nVmlldy5tZXRhID0gZ2V0Vmlld01ldGEobmFtZSk7XG5cblx0XHQvLyB3ZSdyZSBzZXR0aW5nIHRoZSBub2RlIHR5cGUgb2YgdGhlIHZpZXdcblx0XHQvLyB0byAnZWxlbWVudCcgYmVjYXVzZSBvZiBjaGVja3MgZG9uZSBpbiB0aGVcblx0XHQvLyBkb20gYW5pbWF0aW9uIGVuZ2luZVxuXHRcdG5nVmlldy5ub2RlVHlwZSA9IEVMRU1FTlRfTk9ERV9UWVBFO1xuXG5cdFx0cmV0dXJuIG5nVmlldztcblx0fVxuXG5cdHB1YmxpYyBzZXRQcm9wZXJ0eSh2aWV3OiBOZ1ZpZXcsIGF0dHJpYnV0ZU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwgbmFtZXNwYWNlPzogc3RyaW5nKTogdm9pZCB7XG5cdFx0aWYgKCF2aWV3IHx8IChuYW1lc3BhY2UgJiYgIXRoaXMucnVuc0luKG5hbWVzcGFjZSkpKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKGF0dHJpYnV0ZU5hbWUuaW5kZXhPZignLicpICE9PSAtMSkge1xuXHRcdFx0Ly8gSGFuZGxlIG5lc3RlZCBwcm9wZXJ0aWVzXG5cdFx0XHRjb25zdCBwcm9wZXJ0aWVzID0gYXR0cmlidXRlTmFtZS5zcGxpdCgnLicpO1xuXHRcdFx0YXR0cmlidXRlTmFtZSA9IHByb3BlcnRpZXNbcHJvcGVydGllcy5sZW5ndGggLSAxXTtcblxuXHRcdFx0bGV0IHByb3BNYXAgPSB0aGlzLmdldFByb3BlcnRpZXModmlldyk7XG5cdFx0XHRsZXQgaSA9IDA7XG5cdFx0XHR3aGlsZSAoaSA8IHByb3BlcnRpZXMubGVuZ3RoIC0gMSAmJiB0eXBlb2YgdmlldyAhPT0gJ3VuZGVmaW5lZCcpIHtcblx0XHRcdFx0bGV0IHByb3AgPSBwcm9wZXJ0aWVzW2ldO1xuXHRcdFx0XHRpZiAocHJvcE1hcC5oYXMocHJvcCkpIHtcblx0XHRcdFx0XHRwcm9wID0gcHJvcE1hcC5nZXQocHJvcCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHR2aWV3ID0gdmlld1twcm9wXTtcblx0XHRcdFx0cHJvcE1hcCA9IHRoaXMuZ2V0UHJvcGVydGllcyh2aWV3KTtcblx0XHRcdFx0aSsrO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmICh0eXBlb2YgdmlldyAhPT0gJ3VuZGVmaW5lZCcpIHtcblx0XHRcdHRoaXMuc2V0UHJvcGVydHlJbnRlcm5hbCh2aWV3LCBhdHRyaWJ1dGVOYW1lLCB2YWx1ZSk7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBydW5zSW4ocGxhdGZvcm06IHN0cmluZyk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiAocGxhdGZvcm0gPT09ICdpb3MnICYmIHRoaXMuaXNJb3MpIHx8IChwbGF0Zm9ybSA9PT0gJ2FuZHJvaWQnICYmIHRoaXMuaXNBbmRyb2lkKTtcblx0fVxuXG5cdHByaXZhdGUgc2V0UHJvcGVydHlJbnRlcm5hbCh2aWV3OiBOZ1ZpZXcsIGF0dHJpYnV0ZU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSk6IHZvaWQge1xuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFNldHRpbmcgYXR0cmlidXRlOiAke2F0dHJpYnV0ZU5hbWV9PSR7dmFsdWV9IHRvICR7dmlld31gKTtcblx0XHR9XG5cblx0XHRpZiAoYXR0cmlidXRlTmFtZSA9PT0gJ2NsYXNzJykge1xuXHRcdFx0dGhpcy5zZXRDbGFzc2VzKHZpZXcsIHZhbHVlKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAoWE1MX0FUVFJJQlVURVMuaW5kZXhPZihhdHRyaWJ1dGVOYW1lKSAhPT0gLTEpIHtcblx0XHRcdHZpZXdbYXR0cmlidXRlTmFtZV0gPSB2YWx1ZTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBwcm9wTWFwID0gdGhpcy5nZXRQcm9wZXJ0aWVzKHZpZXcpO1xuXHRcdGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BNYXAuZ2V0KGF0dHJpYnV0ZU5hbWUpO1xuXG5cdFx0Ly8gRW5zdXJlIHRoZSBjaGlsZHJlbiBvZiBhIGNvbGxlY3Rpb24gY3VycmVudGx5IGhhdmUgbm8gcGFyZW50IHNldC5cblx0XHRpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcblx0XHRcdHRoaXMucmVtb3ZlUGFyZW50UmVmZXJlbmNlc0Zyb21JdGVtcyh2YWx1ZSk7XG5cdFx0fVxuXG5cdFx0aWYgKHByb3BlcnR5TmFtZSkge1xuXHRcdFx0Ly8gV2UgaGF2ZSBhIGxvd2VyLXVwcGVyIGNhc2UgbWFwcGVkIHByb3BlcnR5LlxuXHRcdFx0dmlld1twcm9wZXJ0eU5hbWVdID0gdmFsdWU7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Ly8gVW5rbm93biBhdHRyaWJ1dGUgdmFsdWUgLS0ganVzdCBzZXQgaXQgdG8gb3VyIG9iamVjdCBhcyBpcy5cblx0XHR2aWV3W2F0dHJpYnV0ZU5hbWVdID0gdmFsdWU7XG5cdH1cblxuXHRwcml2YXRlIHJlbW92ZVBhcmVudFJlZmVyZW5jZXNGcm9tSXRlbXMoaXRlbXM6IGFueVtdKTogdm9pZCB7XG5cdFx0Zm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKSB7XG5cdFx0XHRpZiAoaXRlbS5wYXJlbnQgJiYgaXRlbS5wYXJlbnROb2RlKSB7XG5cdFx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBVbmFzc2lnbmluZyBwYXJlbnQgJHtpdGVtLnBhcmVudE5vZGV9IG9uIHZhbHVlOiAke2l0ZW19YCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0aXRlbS5wYXJlbnQgPSB1bmRlZmluZWQ7XG5cdFx0XHRcdGl0ZW0ucGFyZW50Tm9kZSA9IHVuZGVmaW5lZDtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGdldFByb3BlcnRpZXMoaW5zdGFuY2U6IGFueSk6IE1hcDxzdHJpbmcsIHN0cmluZz4ge1xuXHRcdGNvbnN0IHR5cGUgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5jb25zdHJ1Y3Rvcjtcblx0XHRpZiAoIXR5cGUpIHtcblx0XHRcdHJldHVybiBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuXHRcdH1cblxuXHRcdGlmICghcHJvcGVydHlNYXBzLmhhcyh0eXBlKSkge1xuXHRcdFx0bGV0IHByb3BNYXAgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuXHRcdFx0Zm9yIChsZXQgcHJvcE5hbWUgaW4gaW5zdGFuY2UpIHtcblx0XHRcdFx0Ly8gdHNsaW50OmRpc2FibGU6Zm9yaW5cblx0XHRcdFx0cHJvcE1hcC5zZXQocHJvcE5hbWUudG9Mb3dlckNhc2UoKSwgcHJvcE5hbWUpO1xuXHRcdFx0fVxuXHRcdFx0cHJvcGVydHlNYXBzLnNldCh0eXBlLCBwcm9wTWFwKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gcHJvcGVydHlNYXBzLmdldCh0eXBlKTtcblx0fVxuXG5cdHByaXZhdGUgY3NzQ2xhc3Nlcyh2aWV3OiBOZ1ZpZXcpIHtcblx0XHRpZiAoIXZpZXcubmdDc3NDbGFzc2VzKSB7XG5cdFx0XHR2aWV3Lm5nQ3NzQ2xhc3NlcyA9IG5ldyBNYXA8c3RyaW5nLCBib29sZWFuPigpO1xuXHRcdH1cblx0XHRyZXR1cm4gdmlldy5uZ0Nzc0NsYXNzZXM7XG5cdH1cblxuXHRwdWJsaWMgYWRkQ2xhc3ModmlldzogTmdWaWV3LCBjbGFzc05hbWU6IHN0cmluZyk6IHZvaWQge1xuXHRcdHRoaXMuY3NzQ2xhc3Nlcyh2aWV3KS5zZXQoY2xhc3NOYW1lLCB0cnVlKTtcblx0XHR0aGlzLnN5bmNDbGFzc2VzKHZpZXcpO1xuXHR9XG5cblx0cHVibGljIHJlbW92ZUNsYXNzKHZpZXc6IE5nVmlldywgY2xhc3NOYW1lOiBzdHJpbmcpOiB2b2lkIHtcblx0XHR0aGlzLmNzc0NsYXNzZXModmlldykuZGVsZXRlKGNsYXNzTmFtZSk7XG5cdFx0dGhpcy5zeW5jQ2xhc3Nlcyh2aWV3KTtcblx0fVxuXG5cdHByaXZhdGUgc2V0Q2xhc3Nlcyh2aWV3OiBOZ1ZpZXcsIGNsYXNzZXNWYWx1ZTogc3RyaW5nKTogdm9pZCB7XG5cdFx0bGV0IGNsYXNzZXMgPSBjbGFzc2VzVmFsdWUuc3BsaXQod2hpdGVTcGFjZVNwbGl0dGVyKTtcblx0XHR0aGlzLmNzc0NsYXNzZXModmlldykuY2xlYXIoKTtcblx0XHRjbGFzc2VzLmZvckVhY2goKGNsYXNzTmFtZSkgPT4gdGhpcy5jc3NDbGFzc2VzKHZpZXcpLnNldChjbGFzc05hbWUsIHRydWUpKTtcblx0XHR0aGlzLnN5bmNDbGFzc2VzKHZpZXcpO1xuXHR9XG5cblx0cHJpdmF0ZSBzeW5jQ2xhc3Nlcyh2aWV3OiBOZ1ZpZXcpOiB2b2lkIHtcblx0XHRsZXQgY2xhc3NWYWx1ZSA9ICg8YW55PkFycmF5KS5mcm9tKHRoaXMuY3NzQ2xhc3Nlcyh2aWV3KS5rZXlzKCkpLmpvaW4oJyAnKTtcblx0XHR2aWV3LmNsYXNzTmFtZSA9IGNsYXNzVmFsdWU7XG5cdH1cblxuXHRwdWJsaWMgc2V0U3R5bGUodmlldzogTmdWaWV3LCBzdHlsZU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkge1xuXHRcdHZpZXcuc3R5bGVbc3R5bGVOYW1lXSA9IHZhbHVlO1xuXHR9XG5cblx0cHVibGljIHJlbW92ZVN0eWxlKHZpZXc6IE5nVmlldywgc3R5bGVOYW1lOiBzdHJpbmcpIHtcblx0XHR2aWV3LnN0eWxlW3N0eWxlTmFtZV0gPSB1bnNldFZhbHVlO1xuXHR9XG59XG4iXX0=
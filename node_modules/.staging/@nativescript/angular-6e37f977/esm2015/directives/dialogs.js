import { ComponentFactoryResolver, Injectable, Injector } from '@angular/core';
import { Frame } from '@nativescript/core';
import { NSLocationStrategy } from '../router/ns-location-strategy';
import { AppHostView, AppHostAsyncView } from '../app-host-view';
import { DetachedLoader } from '../common/detached-loader';
import { PAGE_FACTORY } from '../platform-providers';
import { once } from '../common/utils';
export class ModalDialogParams {
    constructor(context = {}, closeCallback) {
        this.context = context;
        this.closeCallback = closeCallback;
    }
}
export class ModalDialogService {
    constructor(location) {
        this.location = location;
    }
    showModal(type, options) {
        if (!options.viewContainerRef) {
            throw new Error('No viewContainerRef: ' + 'Make sure you pass viewContainerRef in ModalDialogOptions.');
        }
        let parentView = options.viewContainerRef.element.nativeElement;
        if (options.target) {
            parentView = options.target;
        }
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        if (parentView._ngDialogRoot) {
            parentView = parentView._ngDialogRoot;
        }
        const pageFactory = options.viewContainerRef.injector.get(PAGE_FACTORY);
        // resolve from particular module (moduleRef)
        // or from same module as parentView (viewContainerRef)
        const componentContainer = options.moduleRef || options.viewContainerRef;
        const resolver = componentContainer.injector.get(ComponentFactoryResolver);
        let frame = parentView;
        if (!(parentView instanceof Frame)) {
            frame = (parentView.page && parentView.page.frame) || Frame.topmost();
        }
        this.location._beginModalNavigation(frame);
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                try {
                    this._showDialog(Object.assign(Object.assign({}, options), { containerRef: options.viewContainerRef, context: options.context, doneCallback: resolve, pageFactory,
                        parentView,
                        resolver,
                        type }));
                }
                catch (err) {
                    reject(err);
                }
            }, 10);
        });
    }
    _showDialog(options) {
        let componentView;
        let detachedLoaderRef;
        const closeCallback = once((...args) => {
            options.doneCallback.apply(undefined, args);
            if (componentView) {
                componentView.closeModal();
                this.location._closeModalNavigation();
                detachedLoaderRef.instance.detectChanges();
                detachedLoaderRef.destroy();
            }
        });
        const modalParams = new ModalDialogParams(options.context, closeCallback);
        const childInjector = Injector.create({
            providers: [{ provide: ModalDialogParams, useValue: modalParams }],
            parent: options.containerRef.injector,
        });
        const detachedFactory = options.resolver.resolveComponentFactory(DetachedLoader);
        detachedLoaderRef = options.containerRef.createComponent(detachedFactory, 0, childInjector, null);
        detachedLoaderRef.instance.loadComponent(options.type).then((compRef) => {
            const detachedProxy = compRef.location.nativeElement;
            if (detachedProxy.getChildrenCount() > 1) {
                throw new Error('Modal content has more than one root view.');
            }
            componentView = detachedProxy.getChildAt(0);
            if (componentView.parent) {
                componentView.parent._ngDialogRoot = componentView;
                componentView.parent.removeChild(componentView);
            }
            options.parentView.showModal(componentView, Object.assign(Object.assign({}, options), { closeCallback }));
        });
    }
}
ModalDialogService.decorators = [
    { type: Injectable }
];
ModalDialogService.ctorParameters = () => [
    { type: NSLocationStrategy }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2RpcmVjdGl2ZXMvZGlhbG9ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsd0JBQXdCLEVBQWdCLFVBQVUsRUFBRSxRQUFRLEVBQXVDLE1BQU0sZUFBZSxDQUFDO0FBQ2xJLE9BQU8sRUFBRSxLQUFLLEVBQXdELE1BQU0sb0JBQW9CLENBQUM7QUFFakcsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDcEUsT0FBTyxFQUFFLFdBQVcsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMzRCxPQUFPLEVBQWUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbEUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBcUJ2QyxNQUFNLE9BQU8saUJBQWlCO0lBQzdCLFlBQW1CLFVBQWUsRUFBRSxFQUFTLGFBQStCO1FBQXpELFlBQU8sR0FBUCxPQUFPLENBQVU7UUFBUyxrQkFBYSxHQUFiLGFBQWEsQ0FBa0I7SUFBRyxDQUFDO0NBQ2hGO0FBR0QsTUFBTSxPQUFPLGtCQUFrQjtJQUM5QixZQUFvQixRQUE0QjtRQUE1QixhQUFRLEdBQVIsUUFBUSxDQUFvQjtJQUFHLENBQUM7SUFFN0MsU0FBUyxDQUFDLElBQWUsRUFBRSxPQUEyQjtRQUM1RCxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFO1lBQzlCLE1BQU0sSUFBSSxLQUFLLENBQUMsdUJBQXVCLEdBQUcsNERBQTRELENBQUMsQ0FBQztTQUN4RztRQUVELElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO1FBQ2hFLElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNuQixVQUFVLEdBQUcsT0FB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QUFjLENBQUMsQ0FBQztRQUNqRixpQkFBaUIsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxFQUFFLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsRyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUN2RSxNQUFNLGFBQWEsR0FBdUIsT0FBTyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUM7WUFFekUsSUFBSSxhQUFhLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLEVBQUU7Z0JBQ3pDLE1BQU0sSUFBSSxLQUFLLENBQUMsNENBQTRDLENBQUMsQ0FBQzthQUM5RDtZQUNELGFBQWEsR0FBRyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTVDLElBQUksYUFBYSxDQUFDLE1BQU0sRUFBRTtnQkFDbkIsYUFBYSxDQUFDLE1BQU8sQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO2dCQUNwRCxhQUFhLENBQUMsTUFBTyxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQzthQUN2RDtZQUVELE9BQU8sQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLGFBQWEsa0NBQU8sT0FBTyxLQUFFLGFBQWEsSUFBRyxDQUFDO1FBQzVFLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQzs7O1lBaEdELFVBQVU7OztZQTdCRixrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE5nTW9kdWxlUmVmLCBUeXBlLCBWaWV3Q29udGFpbmVyUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGcmFtZSwgVmlldywgVmlld0Jhc2UsIFByb3h5Vmlld0NvbnRhaW5lciwgU2hvd01vZGFsT3B0aW9ucyB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5cbmltcG9ydCB7IE5TTG9jYXRpb25TdHJhdGVneSB9IGZyb20gJy4uL3JvdXRlci9ucy1sb2NhdGlvbi1zdHJhdGVneSc7XG5pbXBvcnQgeyBBcHBIb3N0VmlldywgQXBwSG9zdEFzeW5jVmlldyB9IGZyb20gJy4uL2FwcC1ob3N0LXZpZXcnO1xuaW1wb3J0IHsgRGV0YWNoZWRMb2FkZXIgfSBmcm9tICcuLi9jb21tb24vZGV0YWNoZWQtbG9hZGVyJztcbmltcG9ydCB7IFBhZ2VGYWN0b3J5LCBQQUdFX0ZBQ1RPUlkgfSBmcm9tICcuLi9wbGF0Zm9ybS1wcm92aWRlcnMnO1xuaW1wb3J0IHsgb25jZSB9IGZyb20gJy4uL2NvbW1vbi91dGlscyc7XG5cbmV4cG9ydCB0eXBlIEJhc2VTaG93TW9kYWxPcHRpb25zID0gUGljazxTaG93TW9kYWxPcHRpb25zLCBFeGNsdWRlPGtleW9mIFNob3dNb2RhbE9wdGlvbnMsICdjbG9zZUNhbGxiYWNrJyB8ICdjb250ZXh0Jz4+O1xuXG5leHBvcnQgaW50ZXJmYWNlIE1vZGFsRGlhbG9nT3B0aW9ucyBleHRlbmRzIEJhc2VTaG93TW9kYWxPcHRpb25zIHtcblx0Y29udGV4dD86IGFueTtcblx0dmlld0NvbnRhaW5lclJlZj86IFZpZXdDb250YWluZXJSZWY7XG5cdG1vZHVsZVJlZj86IE5nTW9kdWxlUmVmPGFueT47XG5cdHRhcmdldD86IFZpZXc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2hvd0RpYWxvZ09wdGlvbnMgZXh0ZW5kcyBCYXNlU2hvd01vZGFsT3B0aW9ucyB7XG5cdGNvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZjtcblx0Y29udGV4dDogYW55O1xuXHRkb25lQ2FsbGJhY2s7XG5cdHBhZ2VGYWN0b3J5OiBQYWdlRmFjdG9yeTtcblx0cGFyZW50VmlldzogVmlld0Jhc2U7XG5cdHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI7XG5cdHR5cGU6IFR5cGU8YW55Pjtcbn1cblxuZXhwb3J0IGNsYXNzIE1vZGFsRGlhbG9nUGFyYW1zIHtcblx0Y29uc3RydWN0b3IocHVibGljIGNvbnRleHQ6IGFueSA9IHt9LCBwdWJsaWMgY2xvc2VDYWxsYmFjazogKC4uLmFyZ3MpID0+IGFueSkge31cbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1vZGFsRGlhbG9nU2VydmljZSB7XG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgbG9jYXRpb246IE5TTG9jYXRpb25TdHJhdGVneSkge31cblxuXHRwdWJsaWMgc2hvd01vZGFsKHR5cGU6IFR5cGU8YW55Piwgb3B0aW9uczogTW9kYWxEaWFsb2dPcHRpb25zKTogUHJvbWlzZTxhbnk+IHtcblx0XHRpZiAoIW9wdGlvbnMudmlld0NvbnRhaW5lclJlZikge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdObyB2aWV3Q29udGFpbmVyUmVmOiAnICsgJ01ha2Ugc3VyZSB5b3UgcGFzcyB2aWV3Q29udGFpbmVyUmVmIGluIE1vZGFsRGlhbG9nT3B0aW9ucy4nKTtcblx0XHR9XG5cblx0XHRsZXQgcGFyZW50VmlldyA9IG9wdGlvbnMudmlld0NvbnRhaW5lclJlZi5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XG5cdFx0aWYgKG9wdGlvbnMudGFyZ2V0KSB7XG5cdFx0XHRwYXJlbnRWaWV3ID0gb3B0aW9ucy50YXJnZXQ7XG5cdFx0fVxuXG5cdFx0aWYgKChwYXJlbnRWaWV3IGluc3RhbmNlb2YgQXBwSG9zdFZpZXcgfHwgcGFyZW50VmlldyBpbnN0YW5jZW9mIEFwcEhvc3RBc3luY1ZpZXcpICYmIHBhcmVudFZpZXcubmdBcHBSb290KSB7XG5cdFx0XHRwYXJlbnRWaWV3ID0gcGFyZW50Vmlldy5uZ0FwcFJvb3Q7XG5cdFx0fVxuXG5cdFx0Ly8gX25nRGlhbG9nUm9vdCBpcyB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIHByZXZpb3VzbHkgZGV0YWNoZWQgcHJveHkuXG5cdFx0Ly8gSXQgc2hvdWxkIGhhdmUgJ3ZpZXdDb250cm9sbGVyJyAoaU9TKSBvciAnX2RpYWxvZ0ZyYWdtZW50JyAoQW5kcm9pZCkgYXZhaWxhYmxlIGZvclxuXHRcdC8vIHByZXNlbnRpbmcgZnV0dXJlIG1vZGFsIHZpZXdzLlxuXHRcdGlmIChwYXJlbnRWaWV3Ll9uZ0RpYWxvZ1Jvb3QpIHtcblx0XHRcdHBhcmVudFZpZXcgPSBwYXJlbnRWaWV3Ll9uZ0RpYWxvZ1Jvb3Q7XG5cdFx0fVxuXG5cdFx0Y29uc3QgcGFnZUZhY3Rvcnk6IFBhZ2VGYWN0b3J5ID0gb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmLmluamVjdG9yLmdldChQQUdFX0ZBQ1RPUlkpO1xuXG5cdFx0Ly8gcmVzb2x2ZSBmcm9tIHBhcnRpY3VsYXIgbW9kdWxlIChtb2R1bGVSZWYpXG5cdFx0Ly8gb3IgZnJvbSBzYW1lIG1vZHVsZSBhcyBwYXJlbnRWaWV3ICh2aWV3Q29udGFpbmVyUmVmKVxuXHRcdGNvbnN0IGNvbXBvbmVudENvbnRhaW5lciA9IG9wdGlvbnMubW9kdWxlUmVmIHx8IG9wdGlvbnMudmlld0NvbnRhaW5lclJlZjtcblx0XHRjb25zdCByZXNvbHZlciA9IGNvbXBvbmVudENvbnRhaW5lci5pbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKTtcblxuXHRcdGxldCBmcmFtZSA9IHBhcmVudFZpZXc7XG5cdFx0aWYgKCEocGFyZW50VmlldyBpbnN0YW5jZW9mIEZyYW1lKSkge1xuXHRcdFx0ZnJhbWUgPSAocGFyZW50Vmlldy5wYWdlICYmIHBhcmVudFZpZXcucGFnZS5mcmFtZSkgfHwgRnJhbWUudG9wbW9zdCgpO1xuXHRcdH1cblxuXHRcdHRoaXMubG9jYXRpb24uX2JlZ2luTW9kYWxOYXZpZ2F0aW9uKGZyYW1lKTtcblxuXHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHR0aGlzLl9zaG93RGlhbG9nKHtcblx0XHRcdFx0XHRcdC4uLm9wdGlvbnMsXG5cdFx0XHRcdFx0XHRjb250YWluZXJSZWY6IG9wdGlvbnMudmlld0NvbnRhaW5lclJlZixcblx0XHRcdFx0XHRcdGNvbnRleHQ6IG9wdGlvbnMuY29udGV4dCxcblx0XHRcdFx0XHRcdGRvbmVDYWxsYmFjazogcmVzb2x2ZSxcblx0XHRcdFx0XHRcdHBhZ2VGYWN0b3J5LFxuXHRcdFx0XHRcdFx0cGFyZW50Vmlldyxcblx0XHRcdFx0XHRcdHJlc29sdmVyLFxuXHRcdFx0XHRcdFx0dHlwZSxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdFx0cmVqZWN0KGVycik7XG5cdFx0XHRcdH1cblx0XHRcdH0sIDEwKTtcblx0XHR9KTtcblx0fVxuXG5cdHByaXZhdGUgX3Nob3dEaWFsb2cob3B0aW9uczogU2hvd0RpYWxvZ09wdGlvbnMpOiB2b2lkIHtcblx0XHRsZXQgY29tcG9uZW50VmlldzogVmlldztcblx0XHRsZXQgZGV0YWNoZWRMb2FkZXJSZWY6IENvbXBvbmVudFJlZjxEZXRhY2hlZExvYWRlcj47XG5cblx0XHRjb25zdCBjbG9zZUNhbGxiYWNrID0gb25jZSgoLi4uYXJncykgPT4ge1xuXHRcdFx0b3B0aW9ucy5kb25lQ2FsbGJhY2suYXBwbHkodW5kZWZpbmVkLCBhcmdzKTtcblx0XHRcdGlmIChjb21wb25lbnRWaWV3KSB7XG5cdFx0XHRcdGNvbXBvbmVudFZpZXcuY2xvc2VNb2RhbCgpO1xuXHRcdFx0XHR0aGlzLmxvY2F0aW9uLl9jbG9zZU1vZGFsTmF2aWdhdGlvbigpO1xuXHRcdFx0XHRkZXRhY2hlZExvYWRlclJlZi5pbnN0YW5jZS5kZXRlY3RDaGFuZ2VzKCk7XG5cdFx0XHRcdGRldGFjaGVkTG9hZGVyUmVmLmRlc3Ryb3koKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGNvbnN0IG1vZGFsUGFyYW1zID0gbmV3IE1vZGFsRGlhbG9nUGFyYW1zKG9wdGlvbnMuY29udGV4dCwgY2xvc2VDYWxsYmFjayk7XG5cblx0XHRjb25zdCBjaGlsZEluamVjdG9yID0gSW5qZWN0b3IuY3JlYXRlKHtcblx0XHRcdHByb3ZpZGVyczogW3sgcHJvdmlkZTogTW9kYWxEaWFsb2dQYXJhbXMsIHVzZVZhbHVlOiBtb2RhbFBhcmFtcyB9XSxcblx0XHRcdHBhcmVudDogb3B0aW9ucy5jb250YWluZXJSZWYuaW5qZWN0b3IsXG5cdFx0fSk7XG5cdFx0Y29uc3QgZGV0YWNoZWRGYWN0b3J5ID0gb3B0aW9ucy5yZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShEZXRhY2hlZExvYWRlcik7XG5cdFx0ZGV0YWNoZWRMb2FkZXJSZWYgPSBvcHRpb25zLmNvbnRhaW5lclJlZi5jcmVhdGVDb21wb25lbnQoZGV0YWNoZWRGYWN0b3J5LCAwLCBjaGlsZEluamVjdG9yLCBudWxsKTtcblx0XHRkZXRhY2hlZExvYWRlclJlZi5pbnN0YW5jZS5sb2FkQ29tcG9uZW50KG9wdGlvbnMudHlwZSkudGhlbigoY29tcFJlZikgPT4ge1xuXHRcdFx0Y29uc3QgZGV0YWNoZWRQcm94eSA9IDxQcm94eVZpZXdDb250YWluZXI+Y29tcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xuXG5cdFx0XHRpZiAoZGV0YWNoZWRQcm94eS5nZXRDaGlsZHJlbkNvdW50KCkgPiAxKSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcignTW9kYWwgY29udGVudCBoYXMgbW9yZSB0aGFuIG9uZSByb290IHZpZXcuJyk7XG5cdFx0XHR9XG5cdFx0XHRjb21wb25lbnRWaWV3ID0gZGV0YWNoZWRQcm94eS5nZXRDaGlsZEF0KDApO1xuXG5cdFx0XHRpZiAoY29tcG9uZW50Vmlldy5wYXJlbnQpIHtcblx0XHRcdFx0KDxhbnk+Y29tcG9uZW50Vmlldy5wYXJlbnQpLl9uZ0RpYWxvZ1Jvb3QgPSBjb21wb25lbnRWaWV3O1xuXHRcdFx0XHQoPGFueT5jb21wb25lbnRWaWV3LnBhcmVudCkucmVtb3ZlQ2hpbGQoY29tcG9uZW50Vmlldyk7XG5cdFx0XHR9XG5cblx0XHRcdG9wdGlvbnMucGFyZW50Vmlldy5zaG93TW9kYWwoY29tcG9uZW50VmlldywgeyAuLi5vcHRpb25zLCBjbG9zZUNhbGxiYWNrIH0pO1xuXHRcdH0pO1xuXHR9XG59XG4iXX0=
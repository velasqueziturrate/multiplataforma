import { ProxyViewContainer, eachDescendant, CssAnimationProperty, CSSHelper } from '@nativescript/core';
import { NativeScriptAnimationPlayer } from './animation-player';
import { dashCaseToCamelCase } from './utils';
import { InvisibleNode } from '../element-registry';
import { NativeScriptDebug } from '../trace';
class Selector {
    constructor(rawSelector) {
        this.parse(rawSelector);
    }
    match(element) {
        return this.nsSelectorMatch(element) || this.classSelectorsMatch(element);
    }
    parse(rawSelector) {
        const selectors = rawSelector.split(',').map((s) => s.trim());
        this.nsSelectors = selectors.map(CSSHelper.createSelector);
        this.classSelectors = selectors.filter((s) => s.startsWith('.')).map((s) => s.substring(1));
    }
    nsSelectorMatch(element) {
        return this.nsSelectors.some((s) => s.match(element));
    }
    classSelectorsMatch(element) {
        return this.classSelectors.some((s) => this.hasClass(element, s));
    }
    // we're using that instead of match for classes
    // that are dynamically added by the animation engine
    // such as .ng-trigger, that's added for every :enter view
    hasClass(element, cls) {
        return element && element['$$classes'] && element['$$classes'][cls];
    }
}
export class NativeScriptAnimationDriver {
    validateStyleProperty(property) {
        NativeScriptDebug.animationsLog(`CssAnimationProperty.validateStyleProperty: ${property}`);
        return NativeScriptAnimationDriver.validProperties.indexOf(property) !== -1;
    }
    matchesElement(element, rawSelector) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.matchesElement ` + `element: ${element}, selector: ${rawSelector}`);
        const selector = this.makeSelector(rawSelector);
        return selector.match(element);
    }
    containsElement(elm1, elm2) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.containsElement ` + `element1: ${elm1}, element2: ${elm2}`);
        // Checking if the parent is our fake body object
        if (elm1['isOverride']) {
            return true;
        }
        const params = { originalView: elm2 };
        const result = this.visitDescendants(elm1, viewMatches, params);
        return result.found;
    }
    query(element, rawSelector, multi) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.query ` + `element: ${element}, selector: ${rawSelector} ` + `multi: ${multi}`);
        const selector = this.makeSelector(rawSelector);
        const params = { selector, multi };
        const result = this.visitDescendants(element, queryDescendants, params);
        return result.matches || [];
    }
    computeStyle(element, prop) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.computeStyle ` + `element: ${element}, prop: ${prop}`);
        const camelCaseProp = dashCaseToCamelCase(prop);
        return element.style[camelCaseProp];
    }
    animate(element, keyframes, duration, delay, easing) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.animate ` + `element: ${element}, keyframes: ${keyframes} ` + `duration: ${duration}, delay: ${delay} ` + `easing: ${easing}`);
        return new NativeScriptAnimationPlayer(element, keyframes, duration, delay, easing);
    }
    makeSelector(rawSelector) {
        return new Selector(rawSelector);
    }
    visitDescendants(element, cb, cbParams) {
        const result = {};
        // fill the result obj with the result from the callback function
        eachDescendant(element, (child) => cb(child, result, cbParams));
        return result;
    }
}
NativeScriptAnimationDriver.validProperties = [...CssAnimationProperty._getPropertyNames(), 'transform'];
function viewMatches(element, result, params) {
    if (element === params.originalView) {
        result.found = true;
    }
    return !result.found;
}
function queryDescendants(element, result, params) {
    if (!result.matches) {
        result.matches = [];
    }
    const { selector, multi } = params;
    // skip comment and text nodes
    // because they are not actual Views
    // and cannot be animated
    if (element instanceof InvisibleNode || !selector.match(element)) {
        return true;
    }
    if (element instanceof ProxyViewContainer) {
        element.eachChild((child) => {
            result.matches.push(child);
            return true;
        });
    }
    else {
        result.matches.push(element);
    }
    return multi;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5pbWF0aW9uLWRyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2FuaW1hdGlvbnMvYW5pbWF0aW9uLWRyaXZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsY0FBYyxFQUFFLG9CQUFvQixFQUFFLFNBQVMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXpHLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2pFLE9BQU8sRUFBWSxtQkFBbUIsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN4RCxPQUFPLEVBQVUsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBbUI3QyxNQUFNLFFBQVE7SUFJYixZQUFZLFdBQW1CO1FBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFlO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDM0UsQ0FBQztJQUVPLEtBQUssQ0FBQyxXQUFtQjtRQUNoQyxNQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFFOUQsSUFBSSxDQUFDLFdBQVcsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsY0FBYyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENB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QUssQ0FBQztBQUN0QixDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxPQUFlLEVBQUUsTUFBbUIsRUFBRSxNQUFtQjtJQUNsRixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRTtRQUNwQixNQUFNLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztLQUNwQjtJQUVELE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxDQUFDO0lBRW5DLDhCQUE4QjtJQUM5QixvQ0FBb0M7SUFDcEMseUJBQXlCO0lBQ3pCLElBQUksT0FBTyxZQUFZLGFBQWEsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDakUsT0FBTyxJQUFJLENBQUM7S0FDWjtJQUVELElBQUksT0FBTyxZQUFZLGtCQUFrQixFQUFFO1FBQzFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFhLEVBQUUsRUFBRTtZQUNuQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQixPQUFPLElBQUksQ0FBQztRQUNiLENBQUMsQ0FBQyxDQUFDO0tBQ0g7U0FBTTtRQUNOLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQzdCO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQW5pbWF0aW9uUGxheWVyIH0gZnJvbSAnQGFuZ3VsYXIvYW5pbWF0aW9ucyc7XG5pbXBvcnQgeyBBbmltYXRpb25Ecml2ZXIgfSBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zL2Jyb3dzZXInO1xuaW1wb3J0IHsgUHJveHlWaWV3Q29udGFpbmVyLCBlYWNoRGVzY2VuZGFudCwgQ3NzQW5pbWF0aW9uUHJvcGVydHksIENTU0hlbHBlciB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5cbmltcG9ydCB7IE5hdGl2ZVNjcmlwdEFuaW1hdGlvblBsYXllciB9IGZyb20gJy4vYW5pbWF0aW9uLXBsYXllcic7XG5pbXBvcnQgeyBLZXlmcmFtZSwgZGFzaENhc2VUb0NhbWVsQ2FzZSB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgTmdWaWV3LCBJbnZpc2libGVOb2RlIH0gZnJvbSAnLi4vZWxlbWVudC1yZWdpc3RyeSc7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4uL3RyYWNlJztcblxuaW50ZXJmYWNlIFZpZXdNYXRjaFJlc3VsdCB7XG5cdGZvdW5kOiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgVmlld01hdGNoUGFyYW1zIHtcblx0b3JpZ2luYWxWaWV3OiBOZ1ZpZXc7XG59XG5cbmludGVyZmFjZSBRdWVyeVBhcmFtcyB7XG5cdHNlbGVjdG9yOiBTZWxlY3Rvcjtcblx0bXVsdGk6IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBRdWVyeVJlc3VsdCB7XG5cdG1hdGNoZXM6IE5nVmlld1tdO1xufVxuXG5jbGFzcyBTZWxlY3RvciB7XG5cdHByaXZhdGUgbnNTZWxlY3RvcnM6IEFycmF5PGFueT47XG5cdHByaXZhdGUgY2xhc3NTZWxlY3RvcnM6IHN0cmluZ1tdO1xuXG5cdGNvbnN0cnVjdG9yKHJhd1NlbGVjdG9yOiBzdHJpbmcpIHtcblx0XHR0aGlzLnBhcnNlKHJhd1NlbGVjdG9yKTtcblx0fVxuXG5cdG1hdGNoKGVsZW1lbnQ6IE5nVmlldyk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLm5zU2VsZWN0b3JNYXRjaChlbGVtZW50KSB8fCB0aGlzLmNsYXNzU2VsZWN0b3JzTWF0Y2goZWxlbWVudCk7XG5cdH1cblxuXHRwcml2YXRlIHBhcnNlKHJhd1NlbGVjdG9yOiBzdHJpbmcpIHtcblx0XHRjb25zdCBzZWxlY3RvcnMgPSByYXdTZWxlY3Rvci5zcGxpdCgnLCcpLm1hcCgocykgPT4gcy50cmltKCkpO1xuXG5cdFx0dGhpcy5uc1NlbGVjdG9ycyA9IHNlbGVjdG9ycy5tYXAoQ1NTSGVscGVyLmNyZWF0ZVNlbGVjdG9yKTtcblx0XHR0aGlzLmNsYXNzU2VsZWN0b3JzID0gc2VsZWN0b3JzLmZpbHRlcigocykgPT4gcy5zdGFydHNXaXRoKCcuJykpLm1hcCgocykgPT4gcy5zdWJzdHJpbmcoMSkpO1xuXHR9XG5cblx0cHJpdmF0ZSBuc1NlbGVjdG9yTWF0Y2goZWxlbWVudDogTmdWaWV3KSB7XG5cdFx0cmV0dXJuIHRoaXMubnNTZWxlY3RvcnMuc29tZSgocykgPT4gcy5tYXRjaChlbGVtZW50KSk7XG5cdH1cblxuXHRwcml2YXRlIGNsYXNzU2VsZWN0b3JzTWF0Y2goZWxlbWVudDogTmdWaWV3KSB7XG5cdFx0cmV0dXJuIHRoaXMuY2xhc3NTZWxlY3RvcnMuc29tZSgocykgPT4gdGhpcy5oYXNDbGFzcyhlbGVtZW50LCBzKSk7XG5cdH1cblxuXHQvLyB3ZSdyZSB1c2luZyB0aGF0IGluc3RlYWQgb2YgbWF0Y2ggZm9yIGNsYXNzZXNcblx0Ly8gdGhhdCBhcmUgZHluYW1pY2FsbHkgYWRkZWQgYnkgdGhlIGFuaW1hdGlvbiBlbmdpbmVcblx0Ly8gc3VjaCBhcyAubmctdHJpZ2dlciwgdGhhdCdzIGFkZGVkIGZvciBldmVyeSA6ZW50ZXIgdmlld1xuXHRwcml2YXRlIGhhc0NsYXNzKGVsZW1lbnQ6IE5nVmlldywgY2xzOiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gZWxlbWVudCAmJiBlbGVtZW50WyckJGNsYXNzZXMnXSAmJiBlbGVtZW50WyckJGNsYXNzZXMnXVtjbHNdO1xuXHR9XG59XG5cbmV4cG9ydCBjbGFzcyBOYXRpdmVTY3JpcHRBbmltYXRpb25Ecml2ZXIgaW1wbGVtZW50cyBBbmltYXRpb25Ecml2ZXIge1xuXHRwcml2YXRlIHN0YXRpYyB2YWxpZFByb3BlcnRpZXMgPSBbLi4uQ3NzQW5pbWF0aW9uUHJvcGVydHkuX2dldFByb3BlcnR5TmFtZXMoKSwgJ3RyYW5zZm9ybSddO1xuXG5cdHZhbGlkYXRlU3R5bGVQcm9wZXJ0eShwcm9wZXJ0eTogc3RyaW5nKTogYm9vbGVhbiB7XG5cdFx0TmF0aXZlU2NyaXB0RGVidWcuYW5pbWF0aW9uc0xvZyhgQ3NzQW5pbWF0aW9uUHJvcGVydHkudmFsaWRhdGVTdHlsZVByb3BlcnR5OiAke3Byb3BlcnR5fWApO1xuXHRcdHJldHVybiBOYXRpdmVTY3JpcHRBbmltYXRpb25Ecml2ZXIudmFsaWRQcm9wZXJ0aWVzLmluZGV4T2YocHJvcGVydHkpICE9PSAtMTtcblx0fVxuXG5cdG1hdGNoZXNFbGVtZW50KGVsZW1lbnQ6IE5nVmlldywgcmF3U2VsZWN0b3I6IHN0cmluZyk6IGJvb2xlYW4ge1xuXHRcdE5hdGl2ZVNjcmlwdERlYnVnLmFuaW1hdGlvbnNMb2coYE5hdGl2ZVNjcmlwdEFuaW1hdGlvbkRyaXZlci5tYXRjaGVzRWxlbWVudCBgICsgYGVsZW1lbnQ6ICR7ZWxlbWVudH0sIHNlbGVjdG9yOiAke3Jhd1NlbGVjdG9yfWApO1xuXG5cdFx0Y29uc3Qgc2VsZWN0b3IgPSB0aGlzLm1ha2VTZWxlY3RvcihyYXdTZWxlY3Rvcik7XG5cdFx0cmV0dXJuIHNlbGVjdG9yLm1hdGNoKGVsZW1lbnQpO1xuXHR9XG5cblx0Y29udGFpbnNFbGVtZW50KGVsbTE6IE5nVmlldywgZWxtMjogTmdWaWV3KTogYm9vbGVhbiB7XG5cdFx0TmF0aXZlU2NyaXB0RGVidWcuYW5pbWF0aW9uc0xvZyhgTmF0aXZlU2NyaXB0QW5pbWF0aW9uRHJpdmVyLmNvbnRhaW5zRWxlbWVudCBgICsgYGVsZW1lbnQxOiAke2VsbTF9LCBlbGVtZW50MjogJHtlbG0yfWApO1xuXG5cdFx0Ly8gQ2hlY2tpbmcgaWYgdGhlIHBhcmVudCBpcyBvdXIgZmFrZSBib2R5IG9iamVjdFxuXHRcdGlmIChlbG0xWydpc092ZXJyaWRlJ10pIHtcblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH1cblxuXHRcdGNvbnN0IHBhcmFtczogVmlld01hdGNoUGFyYW1zID0geyBvcmlnaW5hbFZpZXc6IGVsbTIgfTtcblx0XHRjb25zdCByZXN1bHQ6IFZpZXdNYXRjaFJlc3VsdCA9IHRoaXMudmlzaXREZXNjZW5kYW50cyhlbG0xLCB2aWV3TWF0Y2hlcywgcGFyYW1zKTtcblxuXHRcdHJldHVybiByZXN1bHQuZm91bmQ7XG5cdH1cblxuXHRxdWVyeShlbGVtZW50OiBOZ1ZpZXcsIHJhd1NlbGVjdG9yOiBzdHJpbmcsIG11bHRpOiBib29sZWFuKTogTmdWaWV3W10ge1xuXHRcdE5hdGl2ZVNjcmlwdERlYnVnLmFuaW1hdGlvbnNMb2coYE5hdGl2ZVNjcmlwdEFuaW1hdGlvbkRyaXZlci5xdWVyeSBgICsgYGVsZW1lbnQ6ICR7ZWxlbWVudH0sIHNlbGVjdG9yOiAke3Jhd1NlbGVjdG9yfSBgICsgYG11bHRpOiAke211bHRpfWApO1xuXG5cdFx0Y29uc3Qgc2VsZWN0b3IgPSB0aGlzLm1ha2VTZWxlY3RvcihyYXdTZWxlY3Rvcik7XG5cdFx0Y29uc3QgcGFyYW1zOiBRdWVyeVBhcmFtcyA9IHsgc2VsZWN0b3IsIG11bHRpIH07XG5cdFx0Y29uc3QgcmVzdWx0OiBRdWVyeVJlc3VsdCA9IHRoaXMudmlzaXREZXNjZW5kYW50cyhlbGVtZW50LCBxdWVyeURlc2NlbmRhbnRzLCBwYXJhbXMpO1xuXG5cdFx0cmV0dXJuIHJlc3VsdC5tYXRjaGVzIHx8IFtdO1xuXHR9XG5cblx0Y29tcHV0ZVN0eWxlKGVsZW1lbnQ6IE5nVmlldywgcHJvcDogc3RyaW5nKTogc3RyaW5nIHtcblx0XHROYXRpdmVTY3JpcHREZWJ1Zy5hbmltYXRpb25zTG9nKGBOYXRpdmVTY3JpcHRBbmltYXRpb25Ecml2ZXIuY29tcHV0ZVN0eWxlIGAgKyBgZWxlbWVudDogJHtlbGVtZW50fSwgcHJvcDogJHtwcm9wfWApO1xuXG5cdFx0Y29uc3QgY2FtZWxDYXNlUHJvcCA9IGRhc2hDYXNlVG9DYW1lbENhc2UocHJvcCk7XG5cdFx0cmV0dXJuIGVsZW1lbnQuc3R5bGVbY2FtZWxDYXNlUHJvcF07XG5cdH1cblxuXHRhbmltYXRlKGVsZW1lbnQ6IE5nVmlldywga2V5ZnJhbWVzOiBLZXlmcmFtZVtdLCBkdXJhdGlvbjogbnVtYmVyLCBkZWxheTogbnVtYmVyLCBlYXNpbmc6IHN0cmluZyk6IEFuaW1hdGlvblBsYXllciB7XG5cdFx0TmF0aXZlU2NyaXB0RGVidWcuYW5pbWF0aW9uc0xvZyhgTmF0aXZlU2NyaXB0QW5pbWF0aW9uRHJpdmVyLmFuaW1hdGUgYCArIGBlbGVtZW50OiAke2VsZW1lbnR9LCBrZXlmcmFtZXM6ICR7a2V5ZnJhbWVzfSBgICsgYGR1cmF0aW9uOiAke2R1cmF0aW9ufSwgZGVsYXk6ICR7ZGVsYXl9IGAgKyBgZWFzaW5nOiAke2Vhc2luZ31gKTtcblxuXHRcdHJldHVybiBuZXcgTmF0aXZlU2NyaXB0QW5pbWF0aW9uUGxheWVyKGVsZW1lbnQsIGtleWZyYW1lcywgZHVyYXRpb24sIGRlbGF5LCBlYXNpbmcpO1xuXHR9XG5cblx0cHJpdmF0ZSBtYWtlU2VsZWN0b3IocmF3U2VsZWN0b3I6IHN0cmluZyk6IFNlbGVjdG9yIHtcblx0XHRyZXR1cm4gbmV3IFNlbGVjdG9yKHJhd1NlbGVjdG9yKTtcblx0fVxuXG5cdHByaXZhdGUgdmlzaXREZXNjZW5kYW50cyhlbGVtZW50OiBOZ1ZpZXcsIGNiOiAoY2hpbGQ6IE5nVmlldywgcmVzdWx0OiBhbnksIHBhcmFtczogYW55KSA9PiBib29sZWFuLCBjYlBhcmFtczogYW55KTogYW55IHtcblx0XHRjb25zdCByZXN1bHQgPSB7fTtcblx0XHQvLyBmaWxsIHRoZSByZXN1bHQgb2JqIHdpdGggdGhlIHJlc3VsdCBmcm9tIHRoZSBjYWxsYmFjayBmdW5jdGlvblxuXHRcdGVhY2hEZXNjZW5kYW50KGVsZW1lbnQsIChjaGlsZDogTmdWaWV3KSA9PiBjYihjaGlsZCwgcmVzdWx0LCBjYlBhcmFtcykpO1xuXG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxufVxuXG5mdW5jdGlvbiB2aWV3TWF0Y2hlcyhlbGVtZW50OiBOZ1ZpZXcsIHJlc3VsdDogVmlld01hdGNoUmVzdWx0LCBwYXJhbXM6IFZpZXdNYXRjaFBhcmFtcyk6IGJvb2xlYW4ge1xuXHRpZiAoZWxlbWVudCA9PT0gcGFyYW1zLm9yaWdpbmFsVmlldykge1xuXHRcdHJlc3VsdC5mb3VuZCA9IHRydWU7XG5cdH1cblxuXHRyZXR1cm4gIXJlc3VsdC5mb3VuZDtcbn1cblxuZnVuY3Rpb24gcXVlcnlEZXNjZW5kYW50cyhlbGVtZW50OiBOZ1ZpZXcsIHJlc3VsdDogUXVlcnlSZXN1bHQsIHBhcmFtczogUXVlcnlQYXJhbXMpOiBib29sZWFuIHtcblx0aWYgKCFyZXN1bHQubWF0Y2hlcykge1xuXHRcdHJlc3VsdC5tYXRjaGVzID0gW107XG5cdH1cblxuXHRjb25zdCB7IHNlbGVjdG9yLCBtdWx0aSB9ID0gcGFyYW1zO1xuXG5cdC8vIHNraXAgY29tbWVudCBhbmQgdGV4dCBub2Rlc1xuXHQvLyBiZWNhdXNlIHRoZXkgYXJlIG5vdCBhY3R1YWwgVmlld3Ncblx0Ly8gYW5kIGNhbm5vdCBiZSBhbmltYXRlZFxuXHRpZiAoZWxlbWVudCBpbnN0YW5jZW9mIEludmlzaWJsZU5vZGUgfHwgIXNlbGVjdG9yLm1hdGNoKGVsZW1lbnQpKSB7XG5cdFx0cmV0dXJuIHRydWU7XG5cdH1cblxuXHRpZiAoZWxlbWVudCBpbnN0YW5jZW9mIFByb3h5Vmlld0NvbnRhaW5lcikge1xuXHRcdGVsZW1lbnQuZWFjaENoaWxkKChjaGlsZDogTmdWaWV3KSA9PiB7XG5cdFx0XHRyZXN1bHQubWF0Y2hlcy5wdXNoKGNoaWxkKTtcblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH0pO1xuXHR9IGVsc2Uge1xuXHRcdHJlc3VsdC5tYXRjaGVzLnB1c2goZWxlbWVudCk7XG5cdH1cblxuXHRyZXR1cm4gbXVsdGk7XG59XG4iXX0=
import { __decorate } from "tslib";
import { Attribute, ChangeDetectorRef, ComponentFactoryResolver, Directive, Inject, Injector, EventEmitter, Output, ViewContainerRef, ElementRef, NgZone } from '@angular/core';
import { ActivatedRoute, ChildrenOutletContexts, PRIMARY_OUTLET } from '@angular/router';
import { Frame, Page, profile, Device } from '@nativescript/core';
import { BehaviorSubject } from 'rxjs';
import { PAGE_FACTORY } from '../platform-providers';
import { NativeScriptDebug } from '../trace';
import { DetachedLoader } from '../common/detached-loader';
import { ViewUtil } from '../view-util';
import { NSLocationStrategy } from './ns-location-strategy';
import { NSRouteReuseStrategy } from './ns-route-reuse-strategy';
import { findTopActivatedRouteNodeForOutlet, pageRouterActivatedSymbol, loaderRefSymbol, destroyComponentRef } from './page-router-outlet-utils';
export class PageRoute {
    constructor(startRoute) {
        this.activatedRoute = new BehaviorSubject(startRoute);
    }
}
export class DestructibleInjector {
    constructor(destructableProviders, parent) {
        this.destructableProviders = destructableProviders;
        this.parent = parent;
        this.refs = new Set();
    }
    get(token, notFoundValue, flags) {
        const ref = this.parent.get(token, notFoundValue, flags);
        if (this.destructableProviders.has(token)) {
            this.refs.add(ref);
        }
        return ref;
    }
    destroy() {
        this.refs.forEach((ref) => {
            if (ref.ngOnDestroy instanceof Function) {
                ref.ngOnDestroy();
            }
        });
        this.refs.clear();
    }
}
const routeToString = function (activatedRoute) {
    return activatedRoute.pathFromRoot.join('->');
};
const ɵ0 = routeToString;
export class PageRouterOutlet {
    constructor(parentContexts, location, name, actionBarVisibility, isEmptyOutlet, locationStrategy, componentFactoryResolver, resolver, changeDetector, pageFactory, routeReuseStrategy, ngZone, elRef) {
        this.parentContexts = parentContexts;
        this.location = location;
        this.locationStrategy = locationStrategy;
        this.componentFactoryResolver = componentFactoryResolver;
        this.resolver = resolver;
        this.changeDetector = changeDetector;
        this.pageFactory = pageFactory;
        this.routeReuseStrategy = routeReuseStrategy;
        this.ngZone = ngZone;
        // tslint:disable-line:directive-class-suffix
        this.activated = null;
        this._activatedRoute = null;
        this.activateEvents = new EventEmitter(); // tslint:disable-line:no-output-rename
        this.deactivateEvents = new EventEmitter(); // tslint:disable-line:no-output-rename
        this.isEmptyOutlet = isEmptyOutlet;
        this.frame = elRef.nativeElement;
        this.setActionBarVisibility(actionBarVisibility);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.constructor frame: ${this.frame}`);
        }
        this.name = name || PRIMARY_OUTLET;
        parentContexts.onChildOutletCreated(this.name, this);
        this.viewUtil = new ViewUtil(Device);
        this.detachedLoaderFactory = resolver.resolveComponentFactory(DetachedLoader);
    }
    /** @deprecated from Angular since v4 */
    get locationInjector() {
        return this.location.injector;
    }
    /** @deprecated from Angular since v4 */
    get locationFactoryResolver() {
        return this.resolver;
    }
    get isActivated() {
        return !!this.activated;
    }
    get component() {
        if (!this.activated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        return this.activated.instance;
    }
    get activatedRoute() {
        if (!this.activated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        return this._activatedRoute;
    }
    setActionBarVisibility(actionBarVisibility) {
        switch (actionBarVisibility) {
            case 'always':
            case 'never':
                this.frame.actionBarVisibility = actionBarVisibility;
                return;
            default:
                this.frame.actionBarVisibility = 'auto';
        }
    }
    ngOnDestroy() {
        // Clear accumulated modal view page cache when page-router-outlet
        // destroyed on modal view closing
        this.parentContexts.onChildOutletDestroyed(this.name);
        if (this.outlet) {
            this.outlet.outletKeys.forEach((key) => {
                this.routeReuseStrategy.clearModalCache(key);
            });
            this.locationStrategy.clearOutlet(this.frame);
        }
        else {
            NativeScriptDebug.routerLog('PageRouterOutlet.ngOnDestroy: no outlet available for page-router-outlet');
        }
        if (this.isActivated) {
            const c = this.activated.instance;
            this.activated.hostView.detach();
            destroyComponentRef(this.activated);
            this.deactivateEvents.emit(c);
            this.activated = null;
        }
    }
    deactivate() {
        if (!this.outlet || !this.outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Currently not in page back navigation - component should be detached instead of deactivated.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('PageRouterOutlet.deactivate() while going back - should destroy');
        }
        if (!this.isActivated) {
            return;
        }
        const c = this.activated.instance;
        destroyComponentRef(this.activated);
        this.activated = null;
        this._activatedRoute = null;
        this.deactivateEvents.emit(c);
    }
    /**
     * Called when the `RouteReuseStrategy` instructs to detach the subtree
     */
    detach() {
        if (!this.isActivated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.detach() - ${routeToString(this._activatedRoute)}`);
        }
        // Detach from ChangeDetection
        this.activated.hostView.detach();
        const component = this.activated;
        this.activated = null;
        this._activatedRoute = null;
        return component;
    }
    /**
     * Called when the `RouteReuseStrategy` instructs to re-attach a previously detached subtree
     */
    attach(ref, activatedRoute) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.attach() - ${routeToString(activatedRoute)}`);
        }
        this.activated = ref;
        // reattach to ChangeDetection
        this.activated.hostView.markForCheck();
        this.activated.hostView.reattach();
        this._activatedRoute = activatedRoute;
        this.markActivatedRoute(activatedRoute);
        this.locationStrategy._finishBackPageNavigation(this.frame);
    }
    /**
     * Called by the Router to instantiate a new component during the commit phase of a navigation.
     * This method in turn is responsible for calling the `routerOnActivate` hook of its child.
     */
    activateWith(activatedRoute, resolver) {
        this.outlet = this.outlet || this.getOutlet(activatedRoute.snapshot);
        if (!this.outlet) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('No outlet found relative to activated route');
            }
            return;
        }
        this.outlet.isNSEmptyOutlet = this.isEmptyOutlet;
        this.locationStrategy.updateOutletFrame(this.outlet, this.frame, this.isEmptyOutlet);
        if (this.outlet && this.outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Currently in page back navigation - component should be reattached instead of activated.');
            }
            this.locationStrategy._finishBackPageNavigation(this.frame);
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.activateWith() - ${routeToString(activatedRoute)}`);
        }
        this._activatedRoute = activatedRoute;
        this.markActivatedRoute(activatedRoute);
        resolver = resolver || this.resolver;
        this.activateOnGoForward(activatedRoute, resolver);
        this.activateEvents.emit(this.activated.instance);
    }
    activateOnGoForward(activatedRoute, loadedResolver) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('PageRouterOutlet.activate() forward navigation - ' + 'create detached loader in the loader container');
        }
        const factory = this.getComponentFactory(activatedRoute, loadedResolver);
        const page = this.pageFactory({
            isNavigation: true,
            componentType: factory.componentType,
        });
        const destructables = new Set([]);
        const injector = Injector.create({
            providers: [
                { provide: Page, useValue: page },
                { provide: Frame, useValue: this.frame },
                { provide: PageRoute, useValue: new PageRoute(activatedRoute) },
                { provide: ActivatedRoute, useValue: activatedRoute },
                { provide: ChildrenOutletContexts, useValue: this.parentContexts.getOrCreateContext(this.name).children },
            ],
            parent: this.location.injector,
        });
        const childInjector = new DestructibleInjector(destructables, injector);
        const loaderRef = this.location.createComponent(this.detachedLoaderFactory, this.location.length, childInjector, []);
        loaderRef.onDestroy(() => childInjector.destroy());
        this.changeDetector.markForCheck();
        this.activated = loaderRef.instance.loadWithFactory(factory);
        this.loadComponentInPage(page, this.activated, { activatedRoute });
        this.activated[loaderRefSymbol] = loaderRef;
    }
    loadComponentInPage(page, componentRef, navigationContext) {
        // Component loaded. Find its root native view.
        const componentView = componentRef.location.nativeElement;
        // Remove it from original native parent.
        this.viewUtil.removeChild(componentView.parent, componentView);
        // Add it to the new page
        this.viewUtil.insertChild(page, componentView);
        const navigatedFromCallback = global.Zone.current.wrap((args) => {
            if (args.isBackNavigation) {
                this.locationStrategy._beginBackPageNavigation(this.frame);
                this.locationStrategy.back(null, this.frame);
            }
        });
        // TODO: experiment with using NgZone instead of global above
        // const navigatedFromCallback = (args: NavigatedData) => {
        // 	if (args.isBackNavigation) {
        //     this.ngZone.run(() => {
        //       this.locationStrategy._beginBackPageNavigation(this.frame);
        //       this.locationStrategy.back(null, this.frame);
        //     });
        // 	}
        // };
        page.on(Page.navigatedFromEvent, navigatedFromCallback);
        componentRef.onDestroy(() => {
            if (page) {
                page.off(Page.navigatedFromEvent, navigatedFromCallback);
                page = null;
            }
        });
        const navOptions = this.locationStrategy._beginPageNavigation(this.frame);
        // Clear refCache if navigation with clearHistory
        if (navOptions.clearHistory) {
            const clearCallback = () => setTimeout(() => {
                if (this.outlet) {
                    this.routeReuseStrategy.clearCache(this.outlet.outletKeys[0]);
                }
            });
            page.once(Page.navigatedToEvent, clearCallback);
        }
        this.frame.navigate({
            create() {
                return page;
            },
            context: navigationContext,
            clearHistory: navOptions.clearHistory,
            animated: navOptions.animated,
            transition: navOptions.transition,
        });
    }
    // Find and mark the top activated route as an activated one.
    // In ns-location-strategy we are reusing components only if their corresponing routes
    // are marked as activated from this method.
    markActivatedRoute(activatedRoute) {
        const queue = [];
        queue.push(activatedRoute.snapshot);
        let currentRoute = queue.shift();
        while (currentRoute) {
            currentRoute.children.forEach((childRoute) => {
                queue.push(childRoute);
            });
            const topActivatedRoute = findTopActivatedRouteNodeForOutlet(currentRoute);
            let outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
            let outlet = this.locationStrategy.findOutlet(outletKey, topActivatedRoute);
            if (outlet && outlet.frames.length) {
                topActivatedRoute[pageRouterActivatedSymbol] = true;
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('Activated route marked as page: ' + routeToString(topActivatedRoute));
                }
            }
            currentRoute = queue.shift();
        }
    }
    getComponentFactory(activatedRoute, loadedResolver) {
        const { component } = activatedRoute.routeConfig;
        return loadedResolver ? loadedResolver.resolveComponentFactory(component) : this.componentFactoryResolver.resolveComponentFactory(component);
    }
    getOutlet(activatedRouteSnapshot) {
        const topActivatedRoute = findTopActivatedRouteNodeForOutlet(activatedRouteSnapshot);
        const outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
        let outlet = this.locationStrategy.findOutlet(outletKey, topActivatedRoute);
        // Named lazy loaded outlet.
        if (!outlet && this.isEmptyOutlet) {
            const parentOutletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute.parent);
            outlet = this.locationStrategy.findOutlet(parentOutletKey, topActivatedRoute.parent);
            if (outlet) {
                outlet.outletKeys.push(outletKey);
            }
        }
        return outlet;
    }
}
PageRouterOutlet.decorators = [
    { type: Directive, args: [{ selector: 'page-router-outlet' },] }
];
PageRouterOutlet.ctorParameters = () => [
    { type: ChildrenOutletContexts },
    { type: ViewContainerRef },
    { type: String, decorators: [{ type: Attribute, args: ['name',] }] },
    { type: String, decorators: [{ type: Attribute, args: ['actionBarVisibility',] }] },
    { type: Boolean, decorators: [{ type: Attribute, args: ['isEmptyOutlet',] }] },
    { type: NSLocationStrategy },
    { type: ComponentFactoryResolver },
    { type: ComponentFactoryResolver },
    { type: ChangeDetectorRef },
    { type: undefined, decorators: [{ type: Inject, args: [PAGE_FACTORY,] }] },
    { type: NSRouteReuseStrategy },
    { type: NgZone },
    { type: ElementRef }
];
PageRouterOutlet.propDecorators = {
    activateEvents: [{ type: Output, args: ['activate',] }],
    deactivateEvents: [{ type: Output, args: ['deactivate',] }]
};
__decorate([
    profile
], PageRouterOutlet.prototype, "activateWith", null);
__decorate([
    profile
], PageRouterOutlet.prototype, "loadComponentInPage", null);
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZS1yb3V0ZXItb3V0bGV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcm91dGVyL3BhZ2Utcm91dGVyLW91dGxldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBb0Isd0JBQXdCLEVBQWdCLFNBQVMsRUFBRSxNQUFNLEVBQWtCLFFBQVEsRUFBYSxZQUFZLEVBQUUsTUFBTSxFQUFRLGdCQUFnQixFQUFFLFVBQVUsRUFBZSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOVAsT0FBTyxFQUFFLGNBQWMsRUFBMEIsc0JBQXNCLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFakgsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQWlCLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUVqRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXZDLE9BQU8sRUFBRSxZQUFZLEVBQWUsTUFBTSx1QkFBdUIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDN0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzNELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDeEMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFNUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLHlCQUF5QixFQUFFLGVBQWUsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRWpKLE1BQU0sT0FBTyxTQUFTO0lBR3JCLFlBQVksVUFBMEI7UUFDckMsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQztJ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QUMsZ0JBQWdCLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUM1RSxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBRTVFLDRCQUE0QjtRQUM1QixJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDbEMsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3pGLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLGVBQWUsRUFBRSxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVyRixJQUFJLE1BQU0sRUFBRTtnQkFDWCxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUNsQztTQUNEO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDZixDQUFDOzs7WUE3VkQsU0FBUyxTQUFDLEVBQUUsUUFBUSxFQUFFLG9CQUFvQixFQUFFOzs7WUFqREksc0JBQXNCO1lBRDhHLGdCQUFnQjt5Q0FvR25HLFNBQVMsU0FBQyxNQUFNO3lDQUFpQixTQUFTLFNBQUMscUJBQXFCOzBDQUFnQyxTQUFTLFNBQUMsZUFBZTtZQXpGbE4sa0JBQWtCO1lBWDhCLHdCQUF3QjtZQUF4Qix3QkFBd0I7WUFBN0QsaUJBQWlCOzRDQW9Ha1osTUFBTSxTQUFDLFlBQVk7WUF2RmpjLG9CQUFvQjtZQWJtTSxNQUFNO1lBQS9CLFVBQVU7Ozs2QkErRC9NLE1BQU0sU0FBQyxVQUFVOytCQUNqQixNQUFNLFNBQUMsWUFBWTs7QUFnS3BCO0lBREMsT0FBTztvREFnQ1A7QUFxQ0Q7SUFEQyxPQUFPOzJEQXdEUCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF0dHJpYnV0ZSwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudEZhY3RvcnksIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBEaXJlY3RpdmUsIEluamVjdCwgSW5qZWN0aW9uVG9rZW4sIEluamVjdG9yLCBPbkRlc3Ryb3ksIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBUeXBlLCBWaWV3Q29udGFpbmVyUmVmLCBFbGVtZW50UmVmLCBJbmplY3RGbGFncywgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgQ2hpbGRyZW5PdXRsZXRDb250ZXh0cywgUFJJTUFSWV9PVVRMRVQgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuXG5pbXBvcnQgeyBGcmFtZSwgUGFnZSwgTmF2aWdhdGVkRGF0YSwgcHJvZmlsZSwgRGV2aWNlIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcblxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IFBBR0VfRkFDVE9SWSwgUGFnZUZhY3RvcnkgfSBmcm9tICcuLi9wbGF0Zm9ybS1wcm92aWRlcnMnO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuLi90cmFjZSc7XG5pbXBvcnQgeyBEZXRhY2hlZExvYWRlciB9IGZyb20gJy4uL2NvbW1vbi9kZXRhY2hlZC1sb2FkZXInO1xuaW1wb3J0IHsgVmlld1V0aWwgfSBmcm9tICcuLi92aWV3LXV0aWwnO1xuaW1wb3J0IHsgTlNMb2NhdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi9ucy1sb2NhdGlvbi1zdHJhdGVneSc7XG5pbXBvcnQgeyBPdXRsZXQgfSBmcm9tICcuL25zLWxvY2F0aW9uLXV0aWxzJztcbmltcG9ydCB7IE5TUm91dGVSZXVzZVN0cmF0ZWd5IH0gZnJvbSAnLi9ucy1yb3V0ZS1yZXVzZS1zdHJhdGVneSc7XG5pbXBvcnQgeyBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0LCBwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sLCBsb2FkZXJSZWZTeW1ib2wsIGRlc3Ryb3lDb21wb25lbnRSZWYgfSBmcm9tICcuL3BhZ2Utcm91dGVyLW91dGxldC11dGlscyc7XG5cbmV4cG9ydCBjbGFzcyBQYWdlUm91dGUge1xuXHRhY3RpdmF0ZWRSb3V0ZTogQmVoYXZpb3JTdWJqZWN0PEFjdGl2YXRlZFJvdXRlPjtcblxuXHRjb25zdHJ1Y3RvcihzdGFydFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSkge1xuXHRcdHRoaXMuYWN0aXZhdGVkUm91dGUgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHN0YXJ0Um91dGUpO1xuXHR9XG59XG5cbmV4cG9ydCBjbGFzcyBEZXN0cnVjdGlibGVJbmplY3RvciBpbXBsZW1lbnRzIEluamVjdG9yIHtcblx0cHJpdmF0ZSByZWZzID0gbmV3IFNldDxhbnk+KCk7XG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgZGVzdHJ1Y3RhYmxlUHJvdmlkZXJzOiBQcm92aWRlclNldCwgcHJpdmF0ZSBwYXJlbnQ6IEluamVjdG9yKSB7fVxuXHRnZXQ8VD4odG9rZW46IFR5cGU8VD4gfCBJbmplY3Rpb25Ub2tlbjxUPiwgbm90Rm91bmRWYWx1ZT86IFQsIGZsYWdzPzogSW5qZWN0RmxhZ3MpOiBUIHtcblx0XHRjb25zdCByZWYgPSB0aGlzLnBhcmVudC5nZXQodG9rZW4sIG5vdEZvdW5kVmFsdWUsIGZsYWdzKTtcblx0XHRpZiAodGhpcy5kZXN0cnVjdGFibGVQcm92aWRlcnMuaGFzKHRva2VuKSkge1xuXHRcdFx0dGhpcy5yZWZzLmFkZChyZWYpO1xuXHRcdH1cblx0XHRyZXR1cm4gcmVmO1xuXHR9XG5cdGRlc3Ryb3koKSB7XG5cdFx0dGhpcy5yZWZzLmZvckVhY2goKHJlZikgPT4ge1xuXHRcdFx0aWYgKHJlZi5uZ09uRGVzdHJveSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG5cdFx0XHRcdHJlZi5uZ09uRGVzdHJveSgpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdHRoaXMucmVmcy5jbGVhcigpO1xuXHR9XG59XG5cbnR5cGUgUHJvdmlkZXJTZXQgPSBTZXQ8VHlwZTxhbnk+IHwgSW5qZWN0aW9uVG9rZW48YW55Pj47XG5cbmNvbnN0IHJvdXRlVG9TdHJpbmcgPSBmdW5jdGlvbiAoYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlIHwgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IHN0cmluZyB7XG5cdHJldHVybiBhY3RpdmF0ZWRSb3V0ZS5wYXRoRnJvbVJvb3Quam9pbignLT4nKTtcbn07XG5cbkBEaXJlY3RpdmUoeyBzZWxlY3RvcjogJ3BhZ2Utcm91dGVyLW91dGxldCcgfSkgLy8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3JcbmV4cG9ydCBjbGFzcyBQYWdlUm91dGVyT3V0bGV0IGltcGxlbWVudHMgT25EZXN0cm95IHtcblx0Ly8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtY2xhc3Mtc3VmZml4XG5cdHByaXZhdGUgYWN0aXZhdGVkOiBDb21wb25lbnRSZWY8YW55PiB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIF9hY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUgfCBudWxsID0gbnVsbDtcblx0cHJpdmF0ZSBkZXRhY2hlZExvYWRlckZhY3Rvcnk6IENvbXBvbmVudEZhY3Rvcnk8RGV0YWNoZWRMb2FkZXI+O1xuXG5cdHByaXZhdGUgb3V0bGV0OiBPdXRsZXQ7XG5cdHByaXZhdGUgbmFtZTogc3RyaW5nO1xuXHRwcml2YXRlIGlzRW1wdHlPdXRsZXQ6IGJvb2xlYW47XG5cdHByaXZhdGUgdmlld1V0aWw6IFZpZXdVdGlsO1xuXHRwcml2YXRlIGZyYW1lOiBGcmFtZTtcblxuXHRAT3V0cHV0KCdhY3RpdmF0ZScpIGFjdGl2YXRlRXZlbnRzID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7IC8vIHRzbGludDpkaXNhYmxlLWxpbmU6bm8tb3V0cHV0LXJlbmFtZVxuXHRAT3V0cHV0KCdkZWFjdGl2YXRlJykgZGVhY3RpdmF0ZUV2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpOyAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLW91dHB1dC1yZW5hbWVcblxuXHQvKiogQGRlcHJlY2F0ZWQgZnJvbSBBbmd1bGFyIHNpbmNlIHY0ICovXG5cdGdldCBsb2NhdGlvbkluamVjdG9yKCk6IEluamVjdG9yIHtcblx0XHRyZXR1cm4gdGhpcy5sb2NhdGlvbi5pbmplY3Rvcjtcblx0fVxuXHQvKiogQGRlcHJlY2F0ZWQgZnJvbSBBbmd1bGFyIHNpbmNlIHY0ICovXG5cdGdldCBsb2NhdGlvbkZhY3RvcnlSZXNvbHZlcigpOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIge1xuXHRcdHJldHVybiB0aGlzLnJlc29sdmVyO1xuXHR9XG5cblx0Z2V0IGlzQWN0aXZhdGVkKCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiAhIXRoaXMuYWN0aXZhdGVkO1xuXHR9XG5cblx0Z2V0IGNvbXBvbmVudCgpOiBPYmplY3Qge1xuXHRcdGlmICghdGhpcy5hY3RpdmF0ZWQpIHtcblx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ091dGxldCBpcyBub3QgYWN0aXZhdGVkJyk7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYWN0aXZhdGVkLmluc3RhbmNlO1xuXHR9XG5cdGdldCBhY3RpdmF0ZWRSb3V0ZSgpOiBBY3RpdmF0ZWRSb3V0ZSB7XG5cdFx0aWYgKCF0aGlzLmFjdGl2YXRlZCkge1xuXHRcdFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnT3V0bGV0IGlzIG5vdCBhY3RpdmF0ZWQnKTtcblx0XHRcdH1cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZhdGVkUm91dGU7XG5cdH1cblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHBhcmVudENvbnRleHRzOiBDaGlsZHJlbk91dGxldENvbnRleHRzLCBwcml2YXRlIGxvY2F0aW9uOiBWaWV3Q29udGFpbmVyUmVmLCBAQXR0cmlidXRlKCduYW1lJykgbmFtZTogc3RyaW5nLCBAQXR0cmlidXRlKCdhY3Rpb25CYXJWaXNpYmlsaXR5JykgYWN0aW9uQmFyVmlzaWJpbGl0eTogc3RyaW5nLCBAQXR0cmlidXRlKCdpc0VtcHR5T3V0bGV0JykgaXNFbXB0eU91dGxldDogYm9vbGVhbiwgcHJpdmF0ZSBsb2NhdGlvblN0cmF0ZWd5OiBOU0xvY2F0aW9uU3RyYXRlZ3ksIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIHByaXZhdGUgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWYsIEBJbmplY3QoUEFHRV9GQUNUT1JZKSBwcml2YXRlIHBhZ2VGYWN0b3J5OiBQYWdlRmFjdG9yeSwgcHJpdmF0ZSByb3V0ZVJldXNlU3RyYXRlZ3k6IE5TUm91dGVSZXVzZVN0cmF0ZWd5LCBwcml2YXRlIG5nWm9uZTogTmdab25lLCBlbFJlZjogRWxlbWVudFJlZikge1xuXHRcdHRoaXMuaXNFbXB0eU91dGxldCA9IGlzRW1wdHlPdXRsZXQ7XG5cdFx0dGhpcy5mcmFtZSA9IGVsUmVmLm5hdGl2ZUVsZW1lbnQ7XG5cdFx0dGhpcy5zZXRBY3Rpb25CYXJWaXNpYmlsaXR5KGFjdGlvbkJhclZpc2liaWxpdHkpO1xuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmNvbnN0cnVjdG9yIGZyYW1lOiAke3RoaXMuZnJhbWV9YCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5uYW1lID0gbmFtZSB8fCBQUklNQVJZX09VVExFVDtcblx0XHRwYXJlbnRDb250ZXh0cy5vbkNoaWxkT3V0bGV0Q3JlYXRlZCh0aGlzLm5hbWUsIDxhbnk+dGhpcyk7XG5cblx0XHR0aGlzLnZpZXdVdGlsID0gbmV3IFZpZXdVdGlsKERldmljZSk7XG5cdFx0dGhpcy5kZXRhY2hlZExvYWRlckZhY3RvcnkgPSByZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShEZXRhY2hlZExvYWRlcik7XG5cdH1cblxuXHRzZXRBY3Rpb25CYXJWaXNpYmlsaXR5KGFjdGlvbkJhclZpc2liaWxpdHk6IHN0cmluZyk6IHZvaWQge1xuXHRcdHN3aXRjaCAoYWN0aW9uQmFyVmlzaWJpbGl0eSkge1xuXHRcdFx0Y2FzZSAnYWx3YXlzJzpcblx0XHRcdGNhc2UgJ25ldmVyJzpcblx0XHRcdFx0dGhpcy5mcmFtZS5hY3Rpb25CYXJWaXNpYmlsaXR5ID0gYWN0aW9uQmFyVmlzaWJpbGl0eTtcblx0XHRcdFx0cmV0dXJuO1xuXG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHR0aGlzLmZyYW1lLmFjdGlvbkJhclZpc2liaWxpdHkgPSAnYXV0byc7XG5cdFx0fVxuXHR9XG5cblx0bmdPbkRlc3Ryb3koKTogdm9pZCB7XG5cdFx0Ly8gQ2xlYXIgYWNjdW11bGF0ZWQgbW9kYWwgdmlldyBwYWdlIGNhY2hlIHdoZW4gcGFnZS1yb3V0ZXItb3V0bGV0XG5cdFx0Ly8gZGVzdHJveWVkIG9uIG1vZGFsIHZpZXcgY2xvc2luZ1xuXHRcdHRoaXMucGFyZW50Q29udGV4dHMub25DaGlsZE91dGxldERlc3Ryb3llZCh0aGlzLm5hbWUpO1xuXG5cdFx0aWYgKHRoaXMub3V0bGV0KSB7XG5cdFx0XHR0aGlzLm91dGxldC5vdXRsZXRLZXlzLmZvckVhY2goKGtleSkgPT4ge1xuXHRcdFx0XHR0aGlzLnJvdXRlUmV1c2VTdHJhdGVneS5jbGVhck1vZGFsQ2FjaGUoa2V5KTtcblx0XHRcdH0pO1xuXHRcdFx0dGhpcy5sb2NhdGlvblN0cmF0ZWd5LmNsZWFyT3V0bGV0KHRoaXMuZnJhbWUpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ1BhZ2VSb3V0ZXJPdXRsZXQubmdPbkRlc3Ryb3k6IG5vIG91dGxldCBhdmFpbGFibGUgZm9yIHBhZ2Utcm91dGVyLW91dGxldCcpO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLmlzQWN0aXZhdGVkKSB7XG5cdFx0XHRjb25zdCBjID0gdGhpcy5hY3RpdmF0ZWQuaW5zdGFuY2U7XG5cdFx0XHR0aGlzLmFjdGl2YXRlZC5ob3N0Vmlldy5kZXRhY2goKTtcblx0XHRcdGRlc3Ryb3lDb21wb25lbnRSZWYodGhpcy5hY3RpdmF0ZWQpO1xuXG5cdFx0XHR0aGlzLmRlYWN0aXZhdGVFdmVudHMuZW1pdChjKTtcblx0XHRcdHRoaXMuYWN0aXZhdGVkID0gbnVsbDtcblx0XHR9XG5cdH1cblxuXHRkZWFjdGl2YXRlKCk6IHZvaWQge1xuXHRcdGlmICghdGhpcy5vdXRsZXQgfHwgIXRoaXMub3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrKSB7XG5cdFx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdDdXJyZW50bHkgbm90IGluIHBhZ2UgYmFjayBuYXZpZ2F0aW9uIC0gY29tcG9uZW50IHNob3VsZCBiZSBkZXRhY2hlZCBpbnN0ZWFkIG9mIGRlYWN0aXZhdGVkLicpO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdQYWdlUm91dGVyT3V0bGV0LmRlYWN0aXZhdGUoKSB3aGlsZSBnb2luZyBiYWNrIC0gc2hvdWxkIGRlc3Ryb3knKTtcblx0XHR9XG5cblx0XHRpZiAoIXRoaXMuaXNBY3RpdmF0ZWQpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBjID0gdGhpcy5hY3RpdmF0ZWQuaW5zdGFuY2U7XG5cdFx0ZGVzdHJveUNvbXBvbmVudFJlZih0aGlzLmFjdGl2YXRlZCk7XG5cblx0XHR0aGlzLmFjdGl2YXRlZCA9IG51bGw7XG5cdFx0dGhpcy5fYWN0aXZhdGVkUm91dGUgPSBudWxsO1xuXG5cdFx0dGhpcy5kZWFjdGl2YXRlRXZlbnRzLmVtaXQoYyk7XG5cdH1cblxuXHQvKipcblx0ICogQ2FsbGVkIHdoZW4gdGhlIGBSb3V0ZVJldXNlU3RyYXRlZ3lgIGluc3RydWN0cyB0byBkZXRhY2ggdGhlIHN1YnRyZWVcblx0ICovXG5cdGRldGFjaCgpOiBDb21wb25lbnRSZWY8YW55PiB7XG5cdFx0aWYgKCF0aGlzLmlzQWN0aXZhdGVkKSB7XG5cdFx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdPdXRsZXQgaXMgbm90IGFjdGl2YXRlZCcpO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmRldGFjaCgpIC0gJHtyb3V0ZVRvU3RyaW5nKHRoaXMuX2FjdGl2YXRlZFJvdXRlKX1gKTtcblx0XHR9XG5cblx0XHQvLyBEZXRhY2ggZnJvbSBDaGFuZ2VEZXRlY3Rpb25cblx0XHR0aGlzLmFjdGl2YXRlZC5ob3N0Vmlldy5kZXRhY2goKTtcblxuXHRcdGNvbnN0IGNvbXBvbmVudCA9IHRoaXMuYWN0aXZhdGVkO1xuXHRcdHRoaXMuYWN0aXZhdGVkID0gbnVsbDtcblx0XHR0aGlzLl9hY3RpdmF0ZWRSb3V0ZSA9IG51bGw7XG5cdFx0cmV0dXJuIGNvbXBvbmVudDtcblx0fVxuXG5cdC8qKlxuXHQgKiBDYWxsZWQgd2hlbiB0aGUgYFJvdXRlUmV1c2VTdHJhdGVneWAgaW5zdHJ1Y3RzIHRvIHJlLWF0dGFjaCBhIHByZXZpb3VzbHkgZGV0YWNoZWQgc3VidHJlZVxuXHQgKi9cblx0YXR0YWNoKHJlZjogQ29tcG9uZW50UmVmPGFueT4sIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSkge1xuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmF0dGFjaCgpIC0gJHtyb3V0ZVRvU3RyaW5nKGFjdGl2YXRlZFJvdXRlKX1gKTtcblx0XHR9XG5cblx0XHR0aGlzLmFjdGl2YXRlZCA9IHJlZjtcblxuXHRcdC8vIHJlYXR0YWNoIHRvIENoYW5nZURldGVjdGlvblxuXHRcdHRoaXMuYWN0aXZhdGVkLmhvc3RWaWV3Lm1hcmtGb3JDaGVjaygpO1xuXHRcdHRoaXMuYWN0aXZhdGVkLmhvc3RWaWV3LnJlYXR0YWNoKCk7XG5cdFx0dGhpcy5fYWN0aXZhdGVkUm91dGUgPSBhY3RpdmF0ZWRSb3V0ZTtcblx0XHR0aGlzLm1hcmtBY3RpdmF0ZWRSb3V0ZShhY3RpdmF0ZWRSb3V0ZSk7XG5cblx0XHR0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuX2ZpbmlzaEJhY2tQYWdlTmF2aWdhdGlvbih0aGlzLmZyYW1lKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBDYWxsZWQgYnkgdGhlIFJvdXRlciB0byBpbnN0YW50aWF0ZSBhIG5ldyBjb21wb25lbnQgZHVyaW5nIHRoZSBjb21taXQgcGhhc2Ugb2YgYSBuYXZpZ2F0aW9uLlxuXHQgKiBUaGlzIG1ldGhvZCBpbiB0dXJuIGlzIHJlc3BvbnNpYmxlIGZvciBjYWxsaW5nIHRoZSBgcm91dGVyT25BY3RpdmF0ZWAgaG9vayBvZiBpdHMgY2hpbGQuXG5cdCAqL1xuXHRAcHJvZmlsZVxuXHRhY3RpdmF0ZVdpdGgoYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlLCByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyIHwgbnVsbCk6IHZvaWQge1xuXHRcdHRoaXMub3V0bGV0ID0gdGhpcy5vdXRsZXQgfHwgdGhpcy5nZXRPdXRsZXQoYWN0aXZhdGVkUm91dGUuc25hcHNob3QpO1xuXHRcdGlmICghdGhpcy5vdXRsZXQpIHtcblx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJFcnJvcignTm8gb3V0bGV0IGZvdW5kIHJlbGF0aXZlIHRvIGFjdGl2YXRlZCByb3V0ZScpO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdHRoaXMub3V0bGV0LmlzTlNFbXB0eU91dGxldCA9IHRoaXMuaXNFbXB0eU91dGxldDtcblx0XHR0aGlzLmxvY2F0aW9uU3RyYXRlZ3kudXBkYXRlT3V0bGV0RnJhbWUodGhpcy5vdXRsZXQsIHRoaXMuZnJhbWUsIHRoaXMuaXNFbXB0eU91dGxldCk7XG5cblx0XHRpZiAodGhpcy5vdXRsZXQgJiYgdGhpcy5vdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2spIHtcblx0XHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ0N1cnJlbnRseSBpbiBwYWdlIGJhY2sgbmF2aWdhdGlvbiAtIGNvbXBvbmVudCBzaG91bGQgYmUgcmVhdHRhY2hlZCBpbnN0ZWFkIG9mIGFjdGl2YXRlZC4nKTtcblx0XHRcdH1cblx0XHRcdHRoaXMubG9jYXRpb25TdHJhdGVneS5fZmluaXNoQmFja1BhZ2VOYXZpZ2F0aW9uKHRoaXMuZnJhbWUpO1xuXHRcdH1cblxuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmFjdGl2YXRlV2l0aCgpIC0gJHtyb3V0ZVRvU3RyaW5nKGFjdGl2YXRlZFJvdXRlKX1gKTtcblx0XHR9XG5cblx0XHR0aGlzLl9hY3RpdmF0ZWRSb3V0ZSA9IGFjdGl2YXRlZFJvdXRlO1xuXG5cdFx0dGhpcy5tYXJrQWN0aXZhdGVkUm91dGUoYWN0aXZhdGVkUm91dGUpO1xuXG5cdFx0cmVzb2x2ZXIgPSByZXNvbHZlciB8fCB0aGlzLnJlc29sdmVyO1xuXG5cdFx0dGhpcy5hY3RpdmF0ZU9uR29Gb3J3YXJkKGFjdGl2YXRlZFJvdXRlLCByZXNvbHZlcik7XG5cdFx0dGhpcy5hY3RpdmF0ZUV2ZW50cy5lbWl0KHRoaXMuYWN0aXZhdGVkLmluc3RhbmNlKTtcblx0fVxuXG5cdHByaXZhdGUgYWN0aXZhdGVPbkdvRm9yd2FyZChhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsIGxvYWRlZFJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpOiB2b2lkIHtcblx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnUGFnZVJvdXRlck91dGxldC5hY3RpdmF0ZSgpIGZvcndhcmQgbmF2aWdhdGlvbiAtICcgKyAnY3JlYXRlIGRldGFjaGVkIGxvYWRlciBpbiB0aGUgbG9hZGVyIGNvbnRhaW5lcicpO1xuXHRcdH1cblxuXHRcdGNvbnN0IGZhY3RvcnkgPSB0aGlzLmdldENvbXBvbmVudEZhY3RvcnkoYWN0aXZhdGVkUm91dGUsIGxvYWRlZFJlc29sdmVyKTtcblx0XHRjb25zdCBwYWdlID0gdGhpcy5wYWdlRmFjdG9yeSh7XG5cdFx0XHRpc05hdmlnYXRpb246IHRydWUsXG5cdFx0XHRjb21wb25lbnRUeXBlOiBmYWN0b3J5LmNvbXBvbmVudFR5cGUsXG5cdFx0fSk7XG5cblx0XHRjb25zdCBkZXN0cnVjdGFibGVzID0gbmV3IFNldChbXSk7XG5cdFx0Y29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuXHRcdFx0cHJvdmlkZXJzOiBbXG5cdFx0XHRcdHsgcHJvdmlkZTogUGFnZSwgdXNlVmFsdWU6IHBhZ2UgfSxcblx0XHRcdFx0eyBwcm92aWRlOiBGcmFtZSwgdXNlVmFsdWU6IHRoaXMuZnJhbWUgfSxcblx0XHRcdFx0eyBwcm92aWRlOiBQYWdlUm91dGUsIHVzZVZhbHVlOiBuZXcgUGFnZVJvdXRlKGFjdGl2YXRlZFJvdXRlKSB9LFxuXHRcdFx0XHR7IHByb3ZpZGU6IEFjdGl2YXRlZFJvdXRlLCB1c2VWYWx1ZTogYWN0aXZhdGVkUm91dGUgfSxcblx0XHRcdFx0eyBwcm92aWRlOiBDaGlsZHJlbk91dGxldENvbnRleHRzLCB1c2VWYWx1ZTogdGhpcy5wYXJlbnRDb250ZXh0cy5nZXRPckNyZWF0ZUNvbnRleHQodGhpcy5uYW1lKS5jaGlsZHJlbiB9LFxuXHRcdFx0XSxcblx0XHRcdHBhcmVudDogdGhpcy5sb2NhdGlvbi5pbmplY3Rvcixcblx0XHR9KTtcblxuXHRcdGNvbnN0IGNoaWxkSW5qZWN0b3IgPSBuZXcgRGVzdHJ1Y3RpYmxlSW5qZWN0b3IoZGVzdHJ1Y3RhYmxlcywgaW5qZWN0b3IpO1xuXHRcdGNvbnN0IGxvYWRlclJlZiA9IHRoaXMubG9jYXRpb24uY3JlYXRlQ29tcG9uZW50KHRoaXMuZGV0YWNoZWRMb2FkZXJGYWN0b3J5LCB0aGlzLmxvY2F0aW9uLmxlbmd0aCwgY2hpbGRJbmplY3RvciwgW10pO1xuXHRcdGxvYWRlclJlZi5vbkRlc3Ryb3koKCkgPT4gY2hpbGRJbmplY3Rvci5kZXN0cm95KCkpO1xuXHRcdHRoaXMuY2hhbmdlRGV0ZWN0b3IubWFya0ZvckNoZWNrKCk7XG5cblx0XHR0aGlzLmFjdGl2YXRlZCA9IGxvYWRlclJlZi5pbnN0YW5jZS5sb2FkV2l0aEZhY3RvcnkoZmFjdG9yeSk7XG5cdFx0dGhpcy5sb2FkQ29tcG9uZW50SW5QYWdlKHBhZ2UsIHRoaXMuYWN0aXZhdGVkLCB7IGFjdGl2YXRlZFJvdXRlIH0pO1xuXG5cdFx0dGhpcy5hY3RpdmF0ZWRbbG9hZGVyUmVmU3ltYm9sXSA9IGxvYWRlclJlZjtcblx0fVxuXG5cdEBwcm9maWxlXG5cdHByaXZhdGUgbG9hZENvbXBvbmVudEluUGFnZShwYWdlOiBQYWdlLCBjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxhbnk+LCBuYXZpZ2F0aW9uQ29udGV4dCk6IHZvaWQge1xuXHRcdC8vIENvbXBvbmVudCBsb2FkZWQuIEZpbmQgaXRzIHJvb3QgbmF0aXZlIHZpZXcuXG5cdFx0Y29uc3QgY29tcG9uZW50VmlldyA9IGNvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xuXHRcdC8vIFJlbW92ZSBpdCBmcm9tIG9yaWdpbmFsIG5hdGl2ZSBwYXJlbnQuXG5cdFx0dGhpcy52aWV3VXRpbC5yZW1vdmVDaGlsZChjb21wb25lbnRWaWV3LnBhcmVudCwgY29tcG9uZW50Vmlldyk7XG5cdFx0Ly8gQWRkIGl0IHRvIHRoZSBuZXcgcGFnZVxuXHRcdHRoaXMudmlld1V0aWwuaW5zZXJ0Q2hpbGQocGFnZSwgY29tcG9uZW50Vmlldyk7XG5cblx0XHRjb25zdCBuYXZpZ2F0ZWRGcm9tQ2FsbGJhY2sgPSAoPGFueT5nbG9iYWwpLlpvbmUuY3VycmVudC53cmFwKChhcmdzOiBOYXZpZ2F0ZWREYXRhKSA9PiB7XG5cdFx0XHRpZiAoYXJncy5pc0JhY2tOYXZpZ2F0aW9uKSB7XG5cdFx0XHRcdHRoaXMubG9jYXRpb25TdHJhdGVneS5fYmVnaW5CYWNrUGFnZU5hdmlnYXRpb24odGhpcy5mcmFtZSk7XG5cdFx0XHRcdHRoaXMubG9jYXRpb25TdHJhdGVneS5iYWNrKG51bGwsIHRoaXMuZnJhbWUpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdC8vIFRPRE86IGV4cGVyaW1lbnQgd2l0aCB1c2luZyBOZ1pvbmUgaW5zdGVhZCBvZiBnbG9iYWwgYWJvdmVcblx0XHQvLyBjb25zdCBuYXZpZ2F0ZWRGcm9tQ2FsbGJhY2sgPSAoYXJnczogTmF2aWdhdGVkRGF0YSkgPT4ge1xuXHRcdC8vIFx0aWYgKGFyZ3MuaXNCYWNrTmF2aWdhdGlvbikge1xuXHRcdC8vICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuXHRcdC8vICAgICAgIHRoaXMubG9jYXRpb25TdHJhdGVneS5fYmVnaW5CYWNrUGFnZU5hdmlnYXRpb24odGhpcy5mcmFtZSk7XG5cdFx0Ly8gICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmJhY2sobnVsbCwgdGhpcy5mcmFtZSk7XG5cdFx0Ly8gICAgIH0pO1xuXHRcdC8vIFx0fVxuXHRcdC8vIH07XG5cblx0XHRwYWdlLm9uKFBhZ2UubmF2aWdhdGVkRnJvbUV2ZW50LCBuYXZpZ2F0ZWRGcm9tQ2FsbGJhY2spO1xuXHRcdGNvbXBvbmVudFJlZi5vbkRlc3Ryb3koKCkgPT4ge1xuXHRcdFx0aWYgKHBhZ2UpIHtcblx0XHRcdFx0cGFnZS5vZmYoUGFnZS5uYXZpZ2F0ZWRGcm9tRXZlbnQsIG5hdmlnYXRlZEZyb21DYWxsYmFjayk7XG5cdFx0XHRcdHBhZ2UgPSBudWxsO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0Y29uc3QgbmF2T3B0aW9ucyA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5fYmVnaW5QYWdlTmF2aWdhdGlvbih0aGlzLmZyYW1lKTtcblxuXHRcdC8vIENsZWFyIHJlZkNhY2hlIGlmIG5hdmlnYXRpb24gd2l0aCBjbGVhckhpc3Rvcnlcblx0XHRpZiAobmF2T3B0aW9ucy5jbGVhckhpc3RvcnkpIHtcblx0XHRcdGNvbnN0IGNsZWFyQ2FsbGJhY2sgPSAoKSA9PlxuXHRcdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0XHRpZiAodGhpcy5vdXRsZXQpIHtcblx0XHRcdFx0XHRcdHRoaXMucm91dGVSZXVzZVN0cmF0ZWd5LmNsZWFyQ2FjaGUodGhpcy5vdXRsZXQub3V0bGV0S2V5c1swXSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblxuXHRcdFx0cGFnZS5vbmNlKFBhZ2UubmF2aWdhdGVkVG9FdmVudCwgY2xlYXJDYWxsYmFjayk7XG5cdFx0fVxuXG5cdFx0dGhpcy5mcmFtZS5uYXZpZ2F0ZSh7XG5cdFx0XHRjcmVhdGUoKSB7XG5cdFx0XHRcdHJldHVybiBwYWdlO1xuXHRcdFx0fSxcblx0XHRcdGNvbnRleHQ6IG5hdmlnYXRpb25Db250ZXh0LFxuXHRcdFx0Y2xlYXJIaXN0b3J5OiBuYXZPcHRpb25zLmNsZWFySGlzdG9yeSxcblx0XHRcdGFuaW1hdGVkOiBuYXZPcHRpb25zLmFuaW1hdGVkLFxuXHRcdFx0dHJhbnNpdGlvbjogbmF2T3B0aW9ucy50cmFuc2l0aW9uLFxuXHRcdH0pO1xuXHR9XG5cblx0Ly8gRmluZCBhbmQgbWFyayB0aGUgdG9wIGFjdGl2YXRlZCByb3V0ZSBhcyBhbiBhY3RpdmF0ZWQgb25lLlxuXHQvLyBJbiBucy1sb2NhdGlvbi1zdHJhdGVneSB3ZSBhcmUgcmV1c2luZyBjb21wb25lbnRzIG9ubHkgaWYgdGhlaXIgY29ycmVzcG9uaW5nIHJvdXRlc1xuXHQvLyBhcmUgbWFya2VkIGFzIGFjdGl2YXRlZCBmcm9tIHRoaXMgbWV0aG9kLlxuXHRwcml2YXRlIG1hcmtBY3RpdmF0ZWRSb3V0ZShhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUpIHtcblx0XHRjb25zdCBxdWV1ZSA9IFtdO1xuXHRcdHF1ZXVlLnB1c2goYWN0aXZhdGVkUm91dGUuc25hcHNob3QpO1xuXHRcdGxldCBjdXJyZW50Um91dGUgPSBxdWV1ZS5zaGlmdCgpO1xuXG5cdFx0d2hpbGUgKGN1cnJlbnRSb3V0ZSkge1xuXHRcdFx0Y3VycmVudFJvdXRlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkUm91dGUpID0+IHtcblx0XHRcdFx0cXVldWUucHVzaChjaGlsZFJvdXRlKTtcblx0XHRcdH0pO1xuXG5cdFx0XHRjb25zdCB0b3BBY3RpdmF0ZWRSb3V0ZSA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQoY3VycmVudFJvdXRlKTtcblx0XHRcdGxldCBvdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuZ2V0Um91dGVGdWxsUGF0aCh0b3BBY3RpdmF0ZWRSb3V0ZSk7XG5cdFx0XHRsZXQgb3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQob3V0bGV0S2V5LCB0b3BBY3RpdmF0ZWRSb3V0ZSk7XG5cblx0XHRcdGlmIChvdXRsZXQgJiYgb3V0bGV0LmZyYW1lcy5sZW5ndGgpIHtcblx0XHRcdFx0dG9wQWN0aXZhdGVkUm91dGVbcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbF0gPSB0cnVlO1xuXHRcdFx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ0FjdGl2YXRlZCByb3V0ZSBtYXJrZWQgYXMgcGFnZTogJyArIHJvdXRlVG9TdHJpbmcodG9wQWN0aXZhdGVkUm91dGUpKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRjdXJyZW50Um91dGUgPSBxdWV1ZS5zaGlmdCgpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgZ2V0Q29tcG9uZW50RmFjdG9yeShhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsIGxvYWRlZFJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpOiBDb21wb25lbnRGYWN0b3J5PGFueT4ge1xuXHRcdGNvbnN0IHsgY29tcG9uZW50IH0gPSBhY3RpdmF0ZWRSb3V0ZS5yb3V0ZUNvbmZpZztcblxuXHRcdHJldHVybiBsb2FkZWRSZXNvbHZlciA/IGxvYWRlZFJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudCkgOiB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShjb21wb25lbnQpO1xuXHR9XG5cblx0cHJpdmF0ZSBnZXRPdXRsZXQoYWN0aXZhdGVkUm91dGVTbmFwc2hvdDogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IE91dGxldCB7XG5cdFx0Y29uc3QgdG9wQWN0aXZhdGVkUm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KGFjdGl2YXRlZFJvdXRlU25hcHNob3QpO1xuXHRcdGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5nZXRSb3V0ZUZ1bGxQYXRoKHRvcEFjdGl2YXRlZFJvdXRlKTtcblx0XHRsZXQgb3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQob3V0bGV0S2V5LCB0b3BBY3RpdmF0ZWRSb3V0ZSk7XG5cblx0XHQvLyBOYW1lZCBsYXp5IGxvYWRlZCBvdXRsZXQuXG5cdFx0aWYgKCFvdXRsZXQgJiYgdGhpcy5pc0VtcHR5T3V0bGV0KSB7XG5cdFx0XHRjb25zdCBwYXJlbnRPdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuZ2V0Um91dGVGdWxsUGF0aCh0b3BBY3RpdmF0ZWRSb3V0ZS5wYXJlbnQpO1xuXHRcdFx0b3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQocGFyZW50T3V0bGV0S2V5LCB0b3BBY3RpdmF0ZWRSb3V0ZS5wYXJlbnQpO1xuXG5cdFx0XHRpZiAob3V0bGV0KSB7XG5cdFx0XHRcdG91dGxldC5vdXRsZXRLZXlzLnB1c2gob3V0bGV0S2V5KTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gb3V0bGV0O1xuXHR9XG59XG4iXX0=
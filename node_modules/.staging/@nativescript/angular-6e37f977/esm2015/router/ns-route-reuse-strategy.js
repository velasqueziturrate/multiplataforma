import { Injectable } from '@angular/core';
import { NativeScriptDebug } from '../trace';
import { NSLocationStrategy } from './ns-location-strategy';
import { destroyComponentRef, findTopActivatedRouteNodeForOutlet, pageRouterActivatedSymbol } from './page-router-outlet-utils';
const getSnapshotKey = function (snapshot) {
    return snapshot.pathFromRoot.join('->');
};
const ɵ0 = getSnapshotKey;
/**
 * Detached state cache
 */
class DetachedStateCache {
    constructor() {
        this.cache = new Array();
    }
    get length() {
        return this.cache.length;
    }
    push(cacheItem) {
        this.cache.push(cacheItem);
    }
    pop() {
        return this.cache.pop();
    }
    peek() {
        return this.cache[this.cache.length - 1];
    }
    clear() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clear() ${this.cache.length} items will be destroyed`);
        }
        while (this.cache.length > 0) {
            const state = this.cache.pop().state;
            if (!state.componentRef) {
                throw new Error('No componentRed found in DetachedRouteHandle');
            }
            destroyComponentRef(state.componentRef);
        }
    }
    clearModalCache() {
        let removedItemsCount = 0;
        const hasModalPages = this.cache.some((cacheItem) => {
            return cacheItem.isModal;
        });
        if (hasModalPages) {
            let modalCacheCleared = false;
            while (!modalCacheCleared) {
                let cacheItem = this.peek();
                const state = cacheItem.state;
                if (!state.componentRef) {
                    throw new Error('No componentRef found in DetachedRouteHandle');
                }
                destroyComponentRef(state.componentRef);
                if (cacheItem.isModal) {
                    modalCacheCleared = true;
                }
                this.pop();
                removedItemsCount++;
            }
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clearModalCache() ${removedItemsCount} items will be destroyed`);
        }
    }
}
/**
 * Detaches subtrees loaded inside PageRouterOutlet in forward navigation
 * and reattaches them on back.
 * Reuses routes as long as their route config is the same.
 */
export class NSRouteReuseStrategy {
    constructor(location) {
        this.location = location;
        this.cacheByOutlet = {};
    }
    shouldDetach(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const outletKey = this.location.getRouteFullPath(route);
        const outlet = this.location.findOutlet(outletKey, route);
        const key = getSnapshotKey(route);
        const isPageActivated = route[pageRouterActivatedSymbol];
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        let shouldDetach = outlet && !isBack && isPageActivated;
        if (outlet) {
            if (outlet.parent && !outlet.parent.shouldDetach) {
                shouldDetach = false;
            }
            outlet.shouldDetach = shouldDetach;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldDetach isBack: ${isBack} key: ${key} result: ${shouldDetach}`);
        }
        return shouldDetach;
    }
    shouldAttach(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const outletKey = this.location.getRouteFullPath(route);
        const outlet = this.location.findOutlet(outletKey, route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return false;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const shouldAttach = isBack && cache.peek().key === key;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldAttach isBack: ${isBack} key: ${key} result: ${shouldAttach}`);
        }
        if (outlet) {
            outlet.shouldDetach = true;
        }
        return shouldAttach;
    }
    store(route, state) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const key = getSnapshotKey(route);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`store key: ${key}, state: ${state}`);
        }
        const outletKey = this.location.getRouteFullPath(route);
        // tslint:disable-next-line:max-line-length
        const cache = (this.cacheByOutlet[outletKey] = this.cacheByOutlet[outletKey] || new DetachedStateCache());
        if (state) {
            let isModal = false;
            if (this.location._modalNavigationDepth > 0) {
                isModal = true;
            }
            cache.push({ key, state, isModal });
        }
        else {
            const topItem = cache.peek();
            if (topItem.key === key) {
                cache.pop();
                if (!cache.length) {
                    delete this.cacheByOutlet[outletKey];
                }
            }
            else {
                throw new Error("Trying to pop from DetachedStateCache but keys don't match. " + `expected: ${topItem.key} actual: ${key}`);
            }
        }
    }
    retrieve(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const outletKey = this.location.getRouteFullPath(route);
        const outlet = this.location.findOutlet(outletKey, route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return null;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const cachedItem = cache.peek();
        let state = null;
        if (isBack && cachedItem && cachedItem.key === key) {
            state = cachedItem.state;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`retrieved isBack: ${isBack} key: ${key} state: ${state}`);
        }
        return state;
    }
    shouldReuseRoute(future, curr) {
        const shouldReuse = future.routeConfig === curr.routeConfig;
        if (shouldReuse && curr && curr[pageRouterActivatedSymbol]) {
            // When reusing route - copy the pageRouterActivated to the new snapshot
            // It's needed in shouldDetach to determine if the route should be detached.
            future[pageRouterActivatedSymbol] = curr[pageRouterActivatedSymbol];
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldReuseRoute result: ${shouldReuse}`);
        }
        return shouldReuse;
    }
    clearCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clear();
        }
    }
    clearModalCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clearModalCache();
        }
    }
}
NSRouteReuseStrategy.decorators = [
    { type: Injectable }
];
NSRouteReuseStrategy.ctorParameters = () => [
    { type: NSLocationStrategy }
];
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtcm91dGUtcmV1c2Utc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9yb3V0ZXIvbnMtcm91dGUtcmV1c2Utc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDN0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLGtDQUFrQyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFRaEksTUFBTSxjQUFjLEdBQUcsVUFBVSxRQUFnQztJQUNoRSxPQUFPLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3pDLENBQUMsQ0FBQzs7QUFFRjs7R0FFRztBQUNILE1BQU0sa0JBQWtCO0lBQXhCO1FBQ1MsVUFBSyxHQUFHLElBQUksS0FBSyxFQUFhLENBQUM7SUFnRXhDLENBQUM7SUE5REEsSUFBVyxNQUFNO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7SUFDMUIsQ0FBQztJQUVNLElBQUksQ0FBQyxTQUFvQjtRQUMvQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRU0sR0FBRztRQUNULE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRU0sSUFBSTtRQUNWLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRU0sS0FBSztRQUNYLElBQUksaUJBQWlCLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDckMsaUJBQWlC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RCxJQUFJLFdBQVcsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLHlCQUF5QixDQUFDLEVBQUU7WUFDM0Qsd0VBQXdFO1lBQ3hFLDRFQUE0RTtZQUM1RSxNQUFNLENBQUMseUJBQXlCLENBQUMsR0FBRyxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQztTQUNwRTtRQUVELElBQUksaUJBQWlCLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDckMsaUJBQWlCLENBQUMscUJBQXFCLENBQUMsNEJBQTRCLFdBQVcsRUFBRSxDQUFDLENBQUM7U0FDbkY7UUFFRCxPQUFPLFdBQVcsQ0FBQztJQUNwQixDQUFDO0lBRUQsVUFBVSxDQUFDLFNBQWlCO1FBQzNCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFNUMsSUFBSSxLQUFLLEVBQUU7WUFDVixLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDZDtJQUNGLENBQUM7SUFFRCxlQUFlLENBQUMsU0FBaUI7UUFDaEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QyxJQUFJLEtBQUssRUFBRTtZQUNWLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztTQUN4QjtJQUNGLENBQUM7OztZQWxKRCxVQUFVOzs7WUF4RkYsa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVSZXVzZVN0cmF0ZWd5LCBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBEZXRhY2hlZFJvdXRlSGFuZGxlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuLi90cmFjZSc7XG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuL25zLWxvY2F0aW9uLXN0cmF0ZWd5JztcbmltcG9ydCB7IGRlc3Ryb3lDb21wb25lbnRSZWYsIGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQsIHBhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2wgfSBmcm9tICcuL3BhZ2Utcm91dGVyLW91dGxldC11dGlscyc7XG5cbmludGVyZmFjZSBDYWNoZUl0ZW0ge1xuXHRrZXk6IHN0cmluZztcblx0c3RhdGU6IERldGFjaGVkUm91dGVIYW5kbGU7XG5cdGlzTW9kYWw6IGJvb2xlYW47XG59XG5cbmNvbnN0IGdldFNuYXBzaG90S2V5ID0gZnVuY3Rpb24gKHNuYXBzaG90OiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogc3RyaW5nIHtcblx0cmV0dXJuIHNuYXBzaG90LnBhdGhGcm9tUm9vdC5qb2luKCctPicpO1xufTtcblxuLyoqXG4gKiBEZXRhY2hlZCBzdGF0ZSBjYWNoZVxuICovXG5jbGFzcyBEZXRhY2hlZFN0YXRlQ2FjaGUge1xuXHRwcml2YXRlIGNhY2hlID0gbmV3IEFycmF5PENhY2hlSXRlbT4oKTtcblxuXHRwdWJsaWMgZ2V0IGxlbmd0aCgpOiBudW1iZXIge1xuXHRcdHJldHVybiB0aGlzLmNhY2hlLmxlbmd0aDtcblx0fVxuXG5cdHB1YmxpYyBwdXNoKGNhY2hlSXRlbTogQ2FjaGVJdGVtKSB7XG5cdFx0dGhpcy5jYWNoZS5wdXNoKGNhY2hlSXRlbSk7XG5cdH1cblxuXHRwdWJsaWMgcG9wKCk6IENhY2hlSXRlbSB7XG5cdFx0cmV0dXJuIHRoaXMuY2FjaGUucG9wKCk7XG5cdH1cblxuXHRwdWJsaWMgcGVlaygpOiBDYWNoZUl0ZW0ge1xuXHRcdHJldHVybiB0aGlzLmNhY2hlW3RoaXMuY2FjaGUubGVuZ3RoIC0gMV07XG5cdH1cblxuXHRwdWJsaWMgY2xlYXIoKSB7XG5cdFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYERldGFjaGVkU3RhdGVDYWNoZS5jbGVhcigpICR7dGhpcy5jYWNoZS5sZW5ndGh9IGl0ZW1zIHdpbGwgYmUgZGVzdHJveWVkYCk7XG5cdFx0fVxuXG5cdFx0d2hpbGUgKHRoaXMuY2FjaGUubGVuZ3RoID4gMCkge1xuXHRcdFx0Y29uc3Qgc3RhdGUgPSA8YW55PnRoaXMuY2FjaGUucG9wKCkuc3RhdGU7XG5cdFx0XHRpZiAoIXN0YXRlLmNvbXBvbmVudFJlZikge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbXBvbmVudFJlZCBmb3VuZCBpbiBEZXRhY2hlZFJvdXRlSGFuZGxlJyk7XG5cdFx0XHR9XG5cblx0XHRcdGRlc3Ryb3lDb21wb25lbnRSZWYoc3RhdGUuY29tcG9uZW50UmVmKTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgY2xlYXJNb2RhbENhY2hlKCkge1xuXHRcdGxldCByZW1vdmVkSXRlbXNDb3VudCA9IDA7XG5cdFx0Y29uc3QgaGFzTW9kYWxQYWdlcyA9IHRoaXMuY2FjaGUuc29tZSgoY2FjaGVJdGVtKSA9PiB7XG5cdFx0XHRyZXR1cm4gY2FjaGVJdGVtLmlzTW9kYWw7XG5cdFx0fSk7XG5cblx0XHRpZiAoaGFzTW9kYWxQYWdlcykge1xuXHRcdFx0bGV0IG1vZGFsQ2FjaGVDbGVhcmVkID0gZmFsc2U7XG5cblx0XHRcdHdoaWxlICghbW9kYWxDYWNoZUNsZWFyZWQpIHtcblx0XHRcdFx0bGV0IGNhY2hlSXRlbSA9IHRoaXMucGVlaygpO1xuXHRcdFx0XHRjb25zdCBzdGF0ZSA9IDxhbnk+Y2FjaGVJdGVtLnN0YXRlO1xuXG5cdFx0XHRcdGlmICghc3RhdGUuY29tcG9uZW50UmVmKSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdObyBjb21wb25lbnRSZWYgZm91bmQgaW4gRGV0YWNoZWRSb3V0ZUhhbmRsZScpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0ZGVzdHJveUNvbXBvbmVudFJlZihzdGF0ZS5jb21wb25lbnRSZWYpO1xuXHRcdFx0XHRpZiAoY2FjaGVJdGVtLmlzTW9kYWwpIHtcblx0XHRcdFx0XHRtb2RhbENhY2hlQ2xlYXJlZCA9IHRydWU7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHR0aGlzLnBvcCgpO1xuXHRcdFx0XHRyZW1vdmVkSXRlbXNDb3VudCsrO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBEZXRhY2hlZFN0YXRlQ2FjaGUuY2xlYXJNb2RhbENhY2hlKCkgJHtyZW1vdmVkSXRlbXNDb3VudH0gaXRlbXMgd2lsbCBiZSBkZXN0cm95ZWRgKTtcblx0XHR9XG5cdH1cbn1cblxuLyoqXG4gKiBEZXRhY2hlcyBzdWJ0cmVlcyBsb2FkZWQgaW5zaWRlIFBhZ2VSb3V0ZXJPdXRsZXQgaW4gZm9yd2FyZCBuYXZpZ2F0aW9uXG4gKiBhbmQgcmVhdHRhY2hlcyB0aGVtIG9uIGJhY2suXG4gKiBSZXVzZXMgcm91dGVzIGFzIGxvbmcgYXMgdGhlaXIgcm91dGUgY29uZmlnIGlzIHRoZSBzYW1lLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTlNSb3V0ZVJldXNlU3RyYXRlZ3kgaW1wbGVtZW50cyBSb3V0ZVJldXNlU3RyYXRlZ3kge1xuXHRwcml2YXRlIGNhY2hlQnlPdXRsZXQ6IHsgW2tleTogc3RyaW5nXTogRGV0YWNoZWRTdGF0ZUNhY2hlIH0gPSB7fTtcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIGxvY2F0aW9uOiBOU0xvY2F0aW9uU3RyYXRlZ3kpIHt9XG5cblx0c2hvdWxkRGV0YWNoKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG5cdFx0cm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuXHRcdGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb24uZ2V0Um91dGVGdWxsUGF0aChyb3V0ZSk7XG5cdFx0Y29uc3Qgb3V0bGV0ID0gdGhpcy5sb2NhdGlvbi5maW5kT3V0bGV0KG91dGxldEtleSwgcm91dGUpO1xuXHRcdGNvbnN0IGtleSA9IGdldFNuYXBzaG90S2V5KHJvdXRlKTtcblx0XHRjb25zdCBpc1BhZ2VBY3RpdmF0ZWQgPSByb3V0ZVtwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sXTtcblx0XHRjb25zdCBpc0JhY2sgPSBvdXRsZXQgPyBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgOiBmYWxzZTtcblx0XHRsZXQgc2hvdWxkRGV0YWNoID0gb3V0bGV0ICYmICFpc0JhY2sgJiYgaXNQYWdlQWN0aXZhdGVkO1xuXG5cdFx0aWYgKG91dGxldCkge1xuXHRcdFx0aWYgKG91dGxldC5wYXJlbnQgJiYgIW91dGxldC5wYXJlbnQuc2hvdWxkRGV0YWNoKSB7XG5cdFx0XHRcdHNob3VsZERldGFjaCA9IGZhbHNlO1xuXHRcdFx0fVxuXG5cdFx0XHRvdXRsZXQuc2hvdWxkRGV0YWNoID0gc2hvdWxkRGV0YWNoO1xuXHRcdH1cblxuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBzaG91bGREZXRhY2ggaXNCYWNrOiAke2lzQmFja30ga2V5OiAke2tleX0gcmVzdWx0OiAke3Nob3VsZERldGFjaH1gKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gc2hvdWxkRGV0YWNoO1xuXHR9XG5cblx0c2hvdWxkQXR0YWNoKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG5cdFx0cm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuXHRcdGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb24uZ2V0Um91dGVGdWxsUGF0aChyb3V0ZSk7XG5cdFx0Y29uc3Qgb3V0bGV0ID0gdGhpcy5sb2NhdGlvbi5maW5kT3V0bGV0KG91dGxldEtleSwgcm91dGUpO1xuXHRcdGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG5cdFx0aWYgKCFjYWNoZSkge1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblxuXHRcdGNvbnN0IGtleSA9IGdldFNuYXBzaG90S2V5KHJvdXRlKTtcblx0XHRjb25zdCBpc0JhY2sgPSBvdXRsZXQgPyBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgOiBmYWxzZTtcblx0XHRjb25zdCBzaG91bGRBdHRhY2ggPSBpc0JhY2sgJiYgY2FjaGUucGVlaygpLmtleSA9PT0ga2V5O1xuXG5cdFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYHNob3VsZEF0dGFjaCBpc0JhY2s6ICR7aXNCYWNrfSBrZXk6ICR7a2V5fSByZXN1bHQ6ICR7c2hvdWxkQXR0YWNofWApO1xuXHRcdH1cblxuXHRcdGlmIChvdXRsZXQpIHtcblx0XHRcdG91dGxldC5zaG91bGREZXRhY2ggPSB0cnVlO1xuXHRcdH1cblxuXHRcdHJldHVybiBzaG91bGRBdHRhY2g7XG5cdH1cblxuXHRzdG9yZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IERldGFjaGVkUm91dGVIYW5kbGUpOiB2b2lkIHtcblx0XHRyb3V0ZSA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQocm91dGUpO1xuXG5cdFx0Y29uc3Qga2V5ID0gZ2V0U25hcHNob3RLZXkocm91dGUpO1xuXHRcdGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBzdG9yZSBrZXk6ICR7a2V5fSwgc3RhdGU6ICR7c3RhdGV9YCk7XG5cdFx0fVxuXG5cdFx0Y29uc3Qgb3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvbi5nZXRSb3V0ZUZ1bGxQYXRoKHJvdXRlKTtcblxuXHRcdC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcblx0XHRjb25zdCBjYWNoZSA9ICh0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldIHx8IG5ldyBEZXRhY2hlZFN0YXRlQ2FjaGUoKSk7XG5cblx0XHRpZiAoc3RhdGUpIHtcblx0XHRcdGxldCBpc01vZGFsID0gZmFsc2U7XG5cdFx0XHRpZiAodGhpcy5sb2NhdGlvbi5fbW9kYWxOYXZpZ2F0aW9uRGVwdGggPiAwKSB7XG5cdFx0XHRcdGlzTW9kYWwgPSB0cnVlO1xuXHRcdFx0fVxuXG5cdFx0XHRjYWNoZS5wdXNoKHsga2V5LCBzdGF0ZSwgaXNNb2RhbCB9KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3QgdG9wSXRlbSA9IGNhY2hlLnBlZWsoKTtcblx0XHRcdGlmICh0b3BJdGVtLmtleSA9PT0ga2V5KSB7XG5cdFx0XHRcdGNhY2hlLnBvcCgpO1xuXG5cdFx0XHRcdGlmICghY2FjaGUubGVuZ3RoKSB7XG5cdFx0XHRcdFx0ZGVsZXRlIHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJUcnlpbmcgdG8gcG9wIGZyb20gRGV0YWNoZWRTdGF0ZUNhY2hlIGJ1dCBrZXlzIGRvbid0IG1hdGNoLiBcIiArIGBleHBlY3RlZDogJHt0b3BJdGVtLmtleX0gYWN0dWFsOiAke2tleX1gKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRyZXRyaWV2ZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IERldGFjaGVkUm91dGVIYW5kbGUgfCBudWxsIHtcblx0XHRyb3V0ZSA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQocm91dGUpO1xuXG5cdFx0Y29uc3Qgb3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvbi5nZXRSb3V0ZUZ1bGxQYXRoKHJvdXRlKTtcblx0XHRjb25zdCBvdXRsZXQgPSB0aGlzLmxvY2F0aW9uLmZpbmRPdXRsZXQob3V0bGV0S2V5LCByb3V0ZSk7XG5cdFx0Y29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcblx0XHRpZiAoIWNhY2hlKSB7XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9XG5cblx0XHRjb25zdCBrZXkgPSBnZXRTbmFwc2hvdEtleShyb3V0ZSk7XG5cdFx0Y29uc3QgaXNCYWNrID0gb3V0bGV0ID8gb3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrIDogZmFsc2U7XG5cdFx0Y29uc3QgY2FjaGVkSXRlbSA9IGNhY2hlLnBlZWsoKTtcblxuXHRcdGxldCBzdGF0ZSA9IG51bGw7XG5cdFx0aWYgKGlzQmFjayAmJiBjYWNoZWRJdGVtICYmIGNhY2hlZEl0ZW0ua2V5ID09PSBrZXkpIHtcblx0XHRcdHN0YXRlID0gY2FjaGVkSXRlbS5zdGF0ZTtcblx0XHR9XG5cblx0XHRpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcblx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgcmV0cmlldmVkIGlzQmFjazogJHtpc0JhY2t9IGtleTogJHtrZXl9IHN0YXRlOiAke3N0YXRlfWApO1xuXHRcdH1cblxuXHRcdHJldHVybiBzdGF0ZTtcblx0fVxuXG5cdHNob3VsZFJldXNlUm91dGUoZnV0dXJlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBjdXJyOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG5cdFx0Y29uc3Qgc2hvdWxkUmV1c2UgPSBmdXR1cmUucm91dGVDb25maWcgPT09IGN1cnIucm91dGVDb25maWc7XG5cblx0XHRpZiAoc2hvdWxkUmV1c2UgJiYgY3VyciAmJiBjdXJyW3BhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2xdKSB7XG5cdFx0XHQvLyBXaGVuIHJldXNpbmcgcm91dGUgLSBjb3B5IHRoZSBwYWdlUm91dGVyQWN0aXZhdGVkIHRvIHRoZSBuZXcgc25hcHNob3Rcblx0XHRcdC8vIEl0J3MgbmVlZGVkIGluIHNob3VsZERldGFjaCB0byBkZXRlcm1pbmUgaWYgdGhlIHJvdXRlIHNob3VsZCBiZSBkZXRhY2hlZC5cblx0XHRcdGZ1dHVyZVtwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sXSA9IGN1cnJbcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbF07XG5cdFx0fVxuXG5cdFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYHNob3VsZFJldXNlUm91dGUgcmVzdWx0OiAke3Nob3VsZFJldXNlfWApO1xuXHRcdH1cblxuXHRcdHJldHVybiBzaG91bGRSZXVzZTtcblx0fVxuXG5cdGNsZWFyQ2FjaGUob3V0bGV0S2V5OiBzdHJpbmcpIHtcblx0XHRjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuXG5cdFx0aWYgKGNhY2hlKSB7XG5cdFx0XHRjYWNoZS5jbGVhcigpO1xuXHRcdH1cblx0fVxuXG5cdGNsZWFyTW9kYWxDYWNoZShvdXRsZXRLZXk6IHN0cmluZykge1xuXHRcdGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG5cblx0XHRpZiAoY2FjaGUpIHtcblx0XHRcdGNhY2hlLmNsZWFyTW9kYWxDYWNoZSgpO1xuXHRcdH1cblx0fVxufVxuIl19
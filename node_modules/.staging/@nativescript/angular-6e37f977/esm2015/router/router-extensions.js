import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { NSLocationStrategy } from './ns-location-strategy';
import { FrameService } from '../frame.service';
import { NativeScriptDebug } from '../trace';
import { findTopActivatedRouteNodeForOutlet } from './page-router-outlet-utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "./ns-location-strategy";
import * as i3 from "../frame.service";
export class RouterExtensions {
    constructor(router, locationStrategy, frameService) {
        this.router = router;
        this.locationStrategy = locationStrategy;
        this.frameService = frameService;
    }
    navigate(commands, extras) {
        if (extras) {
            this.locationStrategy._setNavigationOptions(extras);
        }
        return this.router.navigate(commands, extras);
    }
    navigateByUrl(url, options) {
        if (options) {
            this.locationStrategy._setNavigationOptions(options);
        }
        return this.router.navigateByUrl(url);
    }
    back(backNavigationOptions) {
        if (backNavigationOptions) {
            this.backOutlets(backNavigationOptions);
        }
        else {
            this.locationStrategy.back();
        }
    }
    canGoBack(backNavigationOptions) {
        let canGoBack = true;
        if (backNavigationOptions) {
            const { outletsToBack, outlets } = this.findOutletsToBack(backNavigationOptions);
            if (outletsToBack.length !== outlets.length) {
                NativeScriptDebug.routerError('No outlet found relative to activated route');
            }
            else {
                outletsToBack.forEach((outletToBack) => {
                    if (!this.locationStrategy.canGoBack(outletToBack)) {
                        canGoBack = false;
                    }
                });
            }
        }
        else {
            canGoBack = this.locationStrategy.canGoBack();
        }
        return canGoBack;
    }
    backToPreviousPage() {
        this.frameService.getFrame().goBack();
    }
    canGoBackToPreviousPage() {
        return this.frameService.getFrame().canGoBack();
    }
    backOutlets(options) {
        const { outletsToBack, outlets } = this.findOutletsToBack(options);
        if (outletsToBack.length !== outlets.length) {
            NativeScriptDebug.routerError('No outlet found relative to activated route');
        }
        else {
            outletsToBack.forEach((outletToBack) => {
                if (outletToBack.isPageNavigationBack) {
                    NativeScriptDebug.routerError('Attempted to call startGoBack while going back:');
                }
                else {
                    this.locationStrategy.back(outletToBack);
                }
            });
        }
    }
    // tslint:disable-next-line:max-line-length
    findOutletsToBack(options) {
        const outletsToBack = [];
        const rootRoute = this.router.routerState.root;
        let outlets = options.outlets;
        let relativeRoute = options.relativeTo || rootRoute;
        const relativeRouteOutlet = this.findOutletByRoute(relativeRoute);
        const isNSEmptyOutlet = relativeRouteOutlet && relativeRouteOutlet.isNSEmptyOutlet;
        // Lazy named outlet has added 'primary' inner NSEmptyOutlet child.
        // Take parent route when `relativeTo` option points to the outer named outlet.
        if (isNSEmptyOutlet && relativeRoute.outlet !== 'primary') {
            relativeRoute = relativeRoute.parent || relativeRoute;
        }
        const routesToMatch = outlets ? relativeRoute.children : [relativeRoute];
        outlets = outlets || [relativeRoute.outlet];
        for (let index = 0; index < routesToMatch.length; index++) {
            const currentRoute = routesToMatch[index];
            if (outlets.some((currentOutlet) => currentOutlet === currentRoute.outlet)) {
                const outlet = this.findOutletByRoute(currentRoute);
                if (outlet) {
                    outletsToBack.push(outlet);
                }
            }
        }
        return { outletsToBack: outletsToBack, outlets: outlets };
    }
    findOutletByRoute(currentRoute) {
        let outlet;
        const currentRouteSnapshop = findTopActivatedRouteNodeForOutlet(currentRoute.snapshot);
        const outletKey = this.locationStrategy.getRouteFullPath(currentRouteSnapshop);
        outlet = this.locationStrategy.findOutlet(outletKey, currentRouteSnapshop);
        return outlet;
    }
}
RouterExtensions.ɵprov = i0.ɵɵdefineInjectable({ factory: function RouterExtensions_Factory() { return new RouterExtensions(i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.NSLocationStrategy), i0.ɵɵinject(i3.FrameService)); }, token: RouterExtensions, providedIn: "root" });
RouterExtensions.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
RouterExtensions.ctorParameters = () => [
    { type: Router },
    { type: NSLocationStrategy },
    { type: FrameService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLWV4dGVuc2lvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9yb3V0ZXIvcm91dGVyLWV4dGVuc2lvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUE2QyxNQUFNLGlCQUFpQixDQUFDO0FBQ3BGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTVELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDN0MsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7Ozs7O0FBWWhGLE1BQU0sT0FBTyxnQkFBZ0I7SUFDNUIsWUFBbUIsTUFBYyxFQUFTLGdCQUFvQyxFQUFTLFlBQTBCO1FBQTlGLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBUyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQW9CO1FBQVMsaUJBQVksR0FBWixZQUFZLENBQWM7SUFBRyxDQUFDO0lBRTlHLFFBQVEsQ0FBQyxRQUFlLEVBQUUsTUFBaUM7UUFDakUsSUFBSSxNQUFNLEVBQUU7WUFDWCxJQUFJLENBQUMsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDcEQ7UUFDRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRU0sYUFBYSxDQUFDLEdBQXFCLEVBQUUsT0FBMkI7UUFDdEUsSUFBSSxPQUFPLEVBQUU7WUFDWixJQUFJLENBQUMsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDckQ7UUFDRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcs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QkFBa0I7WUFFbEIsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciwgVXJsVHJlZSwgTmF2aWdhdGlvbkV4dHJhcywgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgTlNMb2NhdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi9ucy1sb2NhdGlvbi1zdHJhdGVneSc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uT3B0aW9ucywgT3V0bGV0IH0gZnJvbSAnLi9ucy1sb2NhdGlvbi11dGlscyc7XG5pbXBvcnQgeyBGcmFtZVNlcnZpY2UgfSBmcm9tICcuLi9mcmFtZS5zZXJ2aWNlJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi4vdHJhY2UnO1xuaW1wb3J0IHsgZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldCB9IGZyb20gJy4vcGFnZS1yb3V0ZXItb3V0bGV0LXV0aWxzJztcblxuZXhwb3J0IHR5cGUgRXh0ZW5kZWROYXZpZ2F0aW9uRXh0cmFzID0gTmF2aWdhdGlvbkV4dHJhcyAmIE5hdmlnYXRpb25PcHRpb25zO1xuXG5leHBvcnQgaW50ZXJmYWNlIEJhY2tOYXZpZ2F0aW9uT3B0aW9ucyB7XG5cdG91dGxldHM/OiBBcnJheTxzdHJpbmc+O1xuXHRyZWxhdGl2ZVRvPzogQWN0aXZhdGVkUm91dGUgfCBudWxsO1xufVxuXG5ASW5qZWN0YWJsZSh7XG5cdHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgUm91dGVyRXh0ZW5zaW9ucyB7XG5cdGNvbnN0cnVjdG9yKHB1YmxpYyByb3V0ZXI6IFJvdXRlciwgcHVibGljIGxvY2F0aW9uU3RyYXRlZ3k6IE5TTG9jYXRpb25TdHJhdGVneSwgcHVibGljIGZyYW1lU2VydmljZTogRnJhbWVTZXJ2aWNlKSB7fVxuXG5cdHB1YmxpYyBuYXZpZ2F0ZShjb21tYW5kczogYW55W10sIGV4dHJhcz86IEV4dGVuZGVkTmF2aWdhdGlvbkV4dHJhcyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdGlmIChleHRyYXMpIHtcblx0XHRcdHRoaXMubG9jYXRpb25TdHJhdGVneS5fc2V0TmF2aWdhdGlvbk9wdGlvbnMoZXh0cmFzKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMucm91dGVyLm5hdmlnYXRlKGNvbW1hbmRzLCBleHRyYXMpO1xuXHR9XG5cblx0cHVibGljIG5hdmlnYXRlQnlVcmwodXJsOiBzdHJpbmcgfCBVcmxUcmVlLCBvcHRpb25zPzogTmF2aWdhdGlvbk9wdGlvbnMpOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0XHRpZiAob3B0aW9ucykge1xuXHRcdFx0dGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9zZXROYXZpZ2F0aW9uT3B0aW9ucyhvcHRpb25zKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwodXJsKTtcblx0fVxuXG5cdHB1YmxpYyBiYWNrKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucz86IEJhY2tOYXZpZ2F0aW9uT3B0aW9ucykge1xuXHRcdGlmIChiYWNrTmF2aWdhdGlvbk9wdGlvbnMpIHtcblx0XHRcdHRoaXMuYmFja091dGxldHMoYmFja05hdmlnYXRpb25PcHRpb25zKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5sb2NhdGlvblN0cmF0ZWd5LmJhY2soKTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgY2FuR29CYWNrKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucz86IEJhY2tOYXZpZ2F0aW9uT3B0aW9ucykge1xuXHRcdGxldCBjYW5Hb0JhY2sgPSB0cnVlO1xuXHRcdGlmIChiYWNrTmF2aWdhdGlvbk9wdGlvbnMpIHtcblx0XHRcdGNvbnN0IHsgb3V0bGV0c1RvQmFjaywgb3V0bGV0cyB9ID0gdGhpcy5maW5kT3V0bGV0c1RvQmFjayhiYWNrTmF2aWdhdGlvbk9wdGlvbnMpO1xuXG5cdFx0XHRpZiAob3V0bGV0c1RvQmFjay5sZW5ndGggIT09IG91dGxldHMubGVuZ3RoKSB7XG5cdFx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckVycm9yKCdObyBvdXRsZXQgZm91bmQgcmVsYXRpdmUgdG8gYWN0aXZhdGVkIHJvdXRlJyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRvdXRsZXRzVG9CYWNrLmZvckVhY2goKG91dGxldFRvQmFjaykgPT4ge1xuXHRcdFx0XHRcdGlmICghdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmNhbkdvQmFjayhvdXRsZXRUb0JhY2spKSB7XG5cdFx0XHRcdFx0XHRjYW5Hb0JhY2sgPSBmYWxzZTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRjYW5Hb0JhY2sgPSB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuY2FuR29CYWNrKCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGNhbkdvQmFjaztcblx0fVxuXG5cdHB1YmxpYyBiYWNrVG9QcmV2aW91c1BhZ2UoKSB7XG5cdFx0dGhpcy5mcmFtZVNlcnZpY2UuZ2V0RnJhbWUoKS5nb0JhY2soKTtcblx0fVxuXG5cdHB1YmxpYyBjYW5Hb0JhY2tUb1ByZXZpb3VzUGFnZSgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5mcmFtZVNlcnZpY2UuZ2V0RnJhbWUoKS5jYW5Hb0JhY2soKTtcblx0fVxuXG5cdHByaXZhdGUgYmFja091dGxldHMob3B0aW9uczogQmFja05hdmlnYXRpb25PcHRpb25zKSB7XG5cdFx0Y29uc3QgeyBvdXRsZXRzVG9CYWNrLCBvdXRsZXRzIH0gPSB0aGlzLmZpbmRPdXRsZXRzVG9CYWNrKG9wdGlvbnMpO1xuXG5cdFx0aWYgKG91dGxldHNUb0JhY2subGVuZ3RoICE9PSBvdXRsZXRzLmxlbmd0aCkge1xuXHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVyRXJyb3IoJ05vIG91dGxldCBmb3VuZCByZWxhdGl2ZSB0byBhY3RpdmF0ZWQgcm91dGUnKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0b3V0bGV0c1RvQmFjay5mb3JFYWNoKChvdXRsZXRUb0JhY2spID0+IHtcblx0XHRcdFx0aWYgKG91dGxldFRvQmFjay5pc1BhZ2VOYXZpZ2F0aW9uQmFjaykge1xuXHRcdFx0XHRcdE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckVycm9yKCdBdHRlbXB0ZWQgdG8gY2FsbCBzdGFydEdvQmFjayB3aGlsZSBnb2luZyBiYWNrOicpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRoaXMubG9jYXRpb25TdHJhdGVneS5iYWNrKG91dGxldFRvQmFjayk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH1cblx0fVxuXG5cdC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcblx0cHJpdmF0ZSBmaW5kT3V0bGV0c1RvQmFjayhvcHRpb25zPzogQmFja05hdmlnYXRpb25PcHRpb25zKTogeyBvdXRsZXRzVG9CYWNrOiBBcnJheTxPdXRsZXQ+OyBvdXRsZXRzOiBBcnJheTxzdHJpbmc+IH0ge1xuXHRcdGNvbnN0IG91dGxldHNUb0JhY2s6IEFycmF5PE91dGxldD4gPSBbXTtcblx0XHRjb25zdCByb290Um91dGU6IEFjdGl2YXRlZFJvdXRlID0gdGhpcy5yb3V0ZXIucm91dGVyU3RhdGUucm9vdDtcblx0XHRsZXQgb3V0bGV0cyA9IG9wdGlvbnMub3V0bGV0cztcblx0XHRsZXQgcmVsYXRpdmVSb3V0ZSA9IG9wdGlvbnMucmVsYXRpdmVUbyB8fCByb290Um91dGU7XG5cblx0XHRjb25zdCByZWxhdGl2ZVJvdXRlT3V0bGV0ID0gdGhpcy5maW5kT3V0bGV0QnlSb3V0ZShyZWxhdGl2ZVJvdXRlKTtcblx0XHRjb25zdCBpc05TRW1wdHlPdXRsZXQgPSByZWxhdGl2ZVJvdXRlT3V0bGV0ICYmIHJlbGF0aXZlUm91dGVPdXRsZXQuaXNOU0VtcHR5T3V0bGV0O1xuXG5cdFx0Ly8gTGF6eSBuYW1lZCBvdXRsZXQgaGFzIGFkZGVkICdwcmltYXJ5JyBpbm5lciBOU0VtcHR5T3V0bGV0IGNoaWxkLlxuXHRcdC8vIFRha2UgcGFyZW50IHJvdXRlIHdoZW4gYHJlbGF0aXZlVG9gIG9wdGlvbiBwb2ludHMgdG8gdGhlIG91dGVyIG5hbWVkIG91dGxldC5cblx0XHRpZiAoaXNOU0VtcHR5T3V0bGV0ICYmIHJlbGF0aXZlUm91dGUub3V0bGV0ICE9PSAncHJpbWFyeScpIHtcblx0XHRcdHJlbGF0aXZlUm91dGUgPSByZWxhdGl2ZVJvdXRlLnBhcmVudCB8fCByZWxhdGl2ZVJvdXRlO1xuXHRcdH1cblxuXHRcdGNvbnN0IHJvdXRlc1RvTWF0Y2ggPSBvdXRsZXRzID8gcmVsYXRpdmVSb3V0ZS5jaGlsZHJlbiA6IFtyZWxhdGl2ZVJvdXRlXTtcblx0XHRvdXRsZXRzID0gb3V0bGV0cyB8fCBbcmVsYXRpdmVSb3V0ZS5vdXRsZXRdO1xuXG5cdFx0Zm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHJvdXRlc1RvTWF0Y2gubGVuZ3RoOyBpbmRleCsrKSB7XG5cdFx0XHRjb25zdCBjdXJyZW50Um91dGUgPSByb3V0ZXNUb01hdGNoW2luZGV4XTtcblx0XHRcdGlmIChvdXRsZXRzLnNvbWUoKGN1cnJlbnRPdXRsZXQpID0+IGN1cnJlbnRPdXRsZXQgPT09IGN1cnJlbnRSb3V0ZS5vdXRsZXQpKSB7XG5cdFx0XHRcdGNvbnN0IG91dGxldCA9IHRoaXMuZmluZE91dGxldEJ5Um91dGUoY3VycmVudFJvdXRlKTtcblxuXHRcdFx0XHRpZiAob3V0bGV0KSB7XG5cdFx0XHRcdFx0b3V0bGV0c1RvQmFjay5wdXNoKG91dGxldCk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4geyBvdXRsZXRzVG9CYWNrOiBvdXRsZXRzVG9CYWNrLCBvdXRsZXRzOiBvdXRsZXRzIH07XG5cdH1cblxuXHRwcml2YXRlIGZpbmRPdXRsZXRCeVJvdXRlKGN1cnJlbnRSb3V0ZTogQWN0aXZhdGVkUm91dGUpOiBPdXRsZXQge1xuXHRcdGxldCBvdXRsZXQ7XG5cblx0XHRjb25zdCBjdXJyZW50Um91dGVTbmFwc2hvcCA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQoY3VycmVudFJvdXRlLnNuYXBzaG90KTtcblx0XHRjb25zdCBvdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuZ2V0Um91dGVGdWxsUGF0aChjdXJyZW50Um91dGVTbmFwc2hvcCk7XG5cdFx0b3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQob3V0bGV0S2V5LCBjdXJyZW50Um91dGVTbmFwc2hvcCk7XG5cblx0XHRyZXR1cm4gb3V0bGV0O1xuXHR9XG59XG4iXX0=